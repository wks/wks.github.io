<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://wks.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://wks.github.io/" rel="alternate" type="text/html" /><updated>2025-06-17T10:01:28+00:00</updated><id>https://wks.github.io/feed.xml</id><title type="html">Kunshan Wang</title><subtitle>Kunshan Wang&apos;s Personal Web Site</subtitle><author><name>Kunshan Wang</name></author><entry><title type="html">OSPP’2023: The good, the bad, and the ugly</title><link href="https://wks.github.io/blog/2024/03/07/ospp-good-bad-ugly.html" rel="alternate" type="text/html" title="OSPP’2023: The good, the bad, and the ugly" /><published>2024-03-07T00:00:00+00:00</published><updated>2024-03-07T00:00:00+00:00</updated><id>https://wks.github.io/blog/2024/03/07/ospp-good-bad-ugly</id><content type="html" xml:base="https://wks.github.io/blog/2024/03/07/ospp-good-bad-ugly.html"><![CDATA[<p>TL;DR: Last year, the MMTk project participated in the Open-Source Promotion
Plan (OSPP).  We mentored two students and they completed two student projects,
which was cheering.  But the OSPP’2023 event itself was organised in a way I
found frustrating, and even hostile to the free software community.  Meanwhile,
I realised that there were toxic people lurking in the community, which was
worrying.</p>

<p><em>WARNING: Contains harsh words.  Viewer discretion is advised.</em></p>

<!--more-->

<h1 id="the-open-source-promotion-plan-ospp">The Open-Source Promotion Plan (OSPP)</h1>

<p>The United States started a trade war against China several years ago, and my
<a href="https://www.huawei.com">former employer</a> was on the ‘Entity List’.  Depending on your political
stance, you may support one side or the other.  But the trade war raised a real
concern for every company about their software supply chain.  If your company
suddenly appears on the Entity List of some country (including but not limited
to the US), your favourite software may immediately become unavailable.  For
instance, <a href="https://www.mathworks.com/products/matlab.html">MATLAB</a> is <a href="https://news.cgtn.com/news/2020-06-13/Chinese-FM-responds-to-MATLAB-s-ban-on-two-Chinese-universities-Rhx20G3pte/index.html">no longer available</a> to the <a href="https://www.hit.edu.cn/">Harbin
Institute of Technology</a>.</p>

<p>This is where <a href="https://www.gnu.org/philosophy/free-sw.html">free software</a> (a.k.a. free open-source software, or FOSS for
short) comes into play.  What will you fear for if you have the complete source
code (and probably the entire revision history) in your hard drive (not in the
‘cloud’), and the contributors have given you a perpetual, worldwide,
non-exclusive, no-charge, royalty-free, irrevocable license to run, copy,
distribute, study, change and improve the software?  Free software (and free
hardware, too) is the ultimate answer to protectionism.  Since the trade war
started, Chinese companies and the government started to embrace free software
more than ever.  Some government agencies even switched to domestic GNU/Linux
distributions as their primary working environments for average workers.</p>

<p>Here is a photo taken from the computer science section in a Xinhua Book Store
in Beijing.  The book store is currently under refurbishment, so only a small
fraction of books are displayed.  Even if you don’t read Chinese, you can still
recognise books about open-source technologies such as Linux, Apache Pulsar,
Kotlin, Python, Java, OpenCV, Qt 6, Scratch, Go, R, OAuth2 and PostgreSQL.  This
means free software is no longer a niche technology in China, but a technology
on popular demand.</p>

<p><img src="/assets/img/xinhuashudian-shelf.jpg" alt="Xinhua Bookstore" /></p>

<p>The <a href="https://summer-ospp.ac.cn/">Open Source Promotion Plan (OSPP)</a> is an event organised by the
<a href="http://www.is.cas.cn/">Institute of Software, China Academy of Science (ISCAS)</a>.  According to
OSPP’s official website, it is an explicit goal of OSPP to ‘build the open
source software supply chain together’.  Similar to Google Summer of Code
(GSoC), OSPP funds students (not limited to Chinese nationals) to participate in
free software projects for three months (from July to September) in Summer.</p>

<ul>
  <li>For students, such events give them motivations to make contribution, for
the love of FOSS or just some extra cash.</li>
  <li>For FOSS projects, such events give them an opportunity to attract
contributors, and also get some low-priority tasks done while main
contributors are busy with high-priority issues.</li>
  <li>For the organiser, ISCAS, and the Chinese government backing it, this event
encourages more people to participate in FOSS development, which will
eventually yield a stronger free software community and help both Chinese
users and FOSS users worldwide to counter protectionism.</li>
</ul>

<p>That is a win-win-win situation.</p>

<p>The <a href="https://www.mmtk.io/">MMTk</a> project participated in the OSPP in 2023, and I was the project
representative of MMTk.  Two students worked with MMTk, and I mentored one of
them.  The good thing is, both students finished their tasks, and we are
grateful to ISCAS for organising such an awesome event, and to the students for
their contributions.  However, the experience of participating in OSPP is not
100% pleasant, and I’ll elaborate.</p>

<h1 id="the-good">The good</h1>

<p>I have always been a FOSS enthusiast.  In late 2000s and early 2010s, I attended
many off-line activities related to FOSS in Beijing (because I studied in
Beijing).  That included several student societies in my university, the
<a href="https://www.softwarefreedomday.org/">Software Freedom Day</a>, activities from local user groups such as the
<a href="https://beijinglug.club/">Beijing Linux User Group</a>, the <a href="https://www.bjgug.org/">Beijing GNOME User Group</a>, etc.
Then I went to Australia for my PhD, where I enjoyed exciting talks and pizzas
with the <a href="https://clug.org.au/">Canberra Linux User Group</a>.  After I returned to China, I didn’t
find much chance to get together with local communities due to work pressure and
COVID19.  I missed the days when FOSS lovers (including both Chinese and
foreigners working in Beijing) get together once a month, bringing laptops, and
coding for fun.</p>

<p>I heard about OSPP in late 2022, and thought MMTk should participate in the next
year in order to let more people know about MMTk, and probably let more people
know how awesome the <a href="https://www.anu.edu.au/">Australian National University (ANU)</a> is, too.  I
couldn’t wait telling FOSS lovers that we are doing interesting researches on
memory management and working on open-source projects with collaborators from
many different countries.  And we did.  We applied for participation in
OSPP’2023, and we were accepted.</p>

<h2 id="meeting-the-organisers">Meeting the organisers</h2>

<p>In early 2023, I met an OSPP organiser in an off-line meeting, and I was very
excited to know that they were working hard to promote free software.  The
organiser told me that OSPP organisers had visited several universities in
different cities in China in order to get more students know about OSPP and free
software in general.  The organiser also told me that although free software was
already very popular among top-tier universities in Beijing, it was far from
true in lower-tier universities in smaller cities.   I appreciated their
efforts.  It takes time and energy to get people aware of free software, and it
is harder for them to understand the spirit of software freedom, but it is worth
trying.</p>

<p>During the whole OSPP’2023 event, the organisers helped us with the process of
registration as well as overcoming errors of their poorly engineered website
(I’ll elaborate in the next section).  They tried their best keeping the event
running.</p>

<p>The organisers also invited participating communities to submit introduction
videos so that they can help promoting their projects by publishing the videos
on behalf of the communities.  Professor Steve Blackburn, the leader of the MMTk
project, gladly made a video to provide <a href="https://youtu.be/0mldpiYW1X4">a brief introduction to
MMTk</a>.  He even recorded it several times to correct minor mistakes.
I created Chinese subtitle for it and sent it to the OSPP organisers.</p>

<h2 id="the-students">The students</h2>

<p>The event went on well.  We posted two student projects, one for <a href="https://summer-ospp.ac.cn/org/prodetail/235730136">migrating our
JikesRVM binding to the new weak reference processing API</a>,
and another for <a href="https://summer-ospp.ac.cn/org/prodetail/235730272">supporting ARMv8</a>.  Several students expressed
their interests in our <a href="https://mmtk.zulipchat.com/#narrow/stream/265041-Summer-Projects/topic/OSPP">Zulip channel</a>, and some even asked for
easy issues for beginners to fix so that they could get familiar with the MMTk
project.  Eventually, two students were selected by OSPP’s automated matching
algorithm, and I mentored one of them to do the project related to JikesRVM and
weak references.</p>

<p>Mr. Haohang Shi, the student I mentored, demonstrated his ability to learn
things quickly.  I simply told him to look at our continuous integration (CI)
scripts, and told him that JikesRVM needs a 32-bit toolchain and an old version
of JVM (version 8), and that I used LXC to make an isolate environment.  In just
one week or two, he managed to compile JikesRVM with the MMTk binding in a
Docker container in one command.  Haohang was surprised that I labelled such a
simple project of implementing a new API as an ‘advanced’ task.  The JikesRVM is
an exotic meta-circular VM, with unconventional semantic extensions to Java in
the form of <a href="https://www.steveblackburn.org/pubs/papers/vmmagic-vee-2009.pdf">VMMagic</a>, and it interacts with native C and Rust code in
unconventional ways different from the JNI which most Java programmers are
familiar with.  It is also a bit aged, requiring legacy toolchains, and is hard
to debug when segmentation fault happens.  All of these made his life harder
than usual, but he fought through all those difficulties.</p>

<p>From then on, we had an online meeting every week.  I basically point him to
interesting places in the code base, outlining what should be done, and
answering his questions.</p>

<p>Things went on mostly well, until Haohang got stuck trying to call a Rust
closure from JikesRVM.  I thought that was easy (but I was wrong).  The crux was
specialising a top-level function with type argument, and passing the pointer to
the closure object between Rust and native code.  We have similar code in our VM
binding repos including the JikesRVM binding, because it is a common task for
interfacing with native code.  If this happens to my colleagues in the core
team, I will just write part of the code for them should they encounter
something difficult to implement.  However, I didn’t do that for Haohang.  One
reason was that the rules of OSPP forbid mentors from doing coding for the
students (otherwise some mentors would do everything for the student and the
student would just sit there and do nothing and still get the bonus).  Another
reason was that I didn’t want to spoil all the fun of finding the solution by
oneself.  He eventually figured it out by himself after several weeks.  That was
a bit long, but he managed to finish the rest of the work before the deadline
and his code was eventually merged.</p>

<p>In hindsight, I felt I might have been too harsh for Haohang.  After he finished
his project, a colleague in the MMTk team asked me a similar question about
another binding.  Then I realised it may not be so obvious for first-time
contributors like Haohang.</p>

<p>Meanwhile, good news came from the other student working on the ARMv8 port.  The
student was able to run DaCapo Benchmarks on an ARMv8 device with MMTk and
OpenJDK.  In the end, both student projects were successful.  We acknowledged
their contributions on <a href="https://www.mmtk.io/projects">our website</a>.</p>

<h1 id="the-bad">The bad</h1>

<p>While the student projects went on well, the organisation of the OSPP’2023 event
was far from perfect, and the experience as a participant was, to be honest, far
from satisfactory.</p>

<h2 id="the-poorly-engineered-website">The poorly engineered website</h2>

<p>The <a href="https://summer-ospp.ac.cn/">official website</a> was poorly engineered.  It forced each user to have
exactly one role.  But since I am both a community representative and a student
project mentor,  I had to log in with two different email addresses for two
different roles.</p>

<p>Although OSPP’2023 allowed communities to use Chinese or English or both, the
website didn’t seem to be considerate enough for English users.  The
registration forms limit the length of some fields (such as the project
description) by the number of characters, making them unfair for English which
tend to have much more characters than Chinese.  The typesetting was also weird.
When breaking long lines, words can be broken anywhere, disregarding any
hyphenation rules of the English language.  Look at the following screenshot:</p>

<p><img src="/assets/img/ospp2023-linewrap.jpg" alt="Screenshot with weird line wrapping" /></p>

<p>What is ‘Ope’ and what is ‘nJDK’?  And it broke ‘support’ into ‘sup’ and ‘port’,
and ‘minor’ into ‘mino’ and ‘r’.</p>

<p>It ended up that someone set the CSS property <code class="language-plaintext highlighter-rouge">word-break: break-all;</code>.  I still
don’t understand why anyone would do that, but I bet nobody tested the web page
with a proper English article and, if anyone actually did, the tester was not
aware of hyphenation rules.  Anyway, I reported the issue to the organisers and
they fixed it.</p>

<h2 id="where-did-they-publish-our-video">Where did they publish our video?</h2>

<p>In the last section, I mentioned that we made <a href="https://youtu.be/0mldpiYW1X4">an introduction
video</a>.  Despite of the efforts we made creating it, I didn’t find
the video published anywhere by OSPP’2023, and I didn’t get any reply saying
whether our video was accepted or rejected.</p>

<h2 id="they-prefer-wechat-a-proprietary-instant-messaging-app">They prefer WeChat, a proprietary instant messaging app</h2>

<p>The official method for communicating with the organisers was via email.  But
when I sent an email asking questions, one organiser invited me to join a
<a href="https://www.wechat.com/">WeChat</a> group.  Despite its popularity in China, WeChat is a proprietary
instant messaging application mainly focusing on smart phone, and is terrible to
use on desktop computers.  I felt very strange because OSPP stood for ‘Open
Source Promotion Plan’.  It was supposed to promote free open-source software.
Why do they invite me to use a proprietary application?</p>

<p>But I joined the WeChat group anyway to see what would follow.  That was a group
titled ‘OSPP community collaboration’, and its members included 400+
representatives from different communities.  People were asking questions and
pointing out issues about the event, while the organisers replied.</p>

<h2 id="they-use-proprietary-storage-service-and-proprietary-image-formats">They use proprietary storage service and proprietary image formats</h2>

<p>After a few days, the organiser published a template pack for communities to
make their promotional ‘posters’.  Here is a sample:</p>

<p><img src="/assets/img/ospp2023-poster.jpg" alt="Poster template" /></p>

<p>For those who don’t know, those who use WeChat or other Chinese social media
such as Weibo for promotion usually make such one-picture posters and publish
them as tweets, or send them to group-chat channels.  The advantage is obvious.
It is just so simple, and it bypasses any text-formatting functionalities WeChat
or other instant message / social media apps provide to their users, which are
often hard to use.</p>

<p>The problem was, the organiser provided the template pack using a link to <a href="https://pan.baidu.com/">Baidu
Wangpan</a>, a Chinese cloud storage service that requires a proprietary client to
use.</p>

<p>Seriously?  Was OSPP trying to promote open-source software by forcing
participants to use proprietary software?  After complaining to the organisers
of OSPP’2023, they moved the poster templates to <a href="https://github.com/summer-ospp/publicity">a GitHub
repository</a>.</p>

<p>I browsed the repository.  They provided the posters in two formats: a <code class="language-plaintext highlighter-rouge">.sketch</code>
file and a <code class="language-plaintext highlighter-rouge">.figma</code> file.  The former was for <a href="https://www.sketch.com/">Sketch</a>, a proprietary graphics
software exclusive to Mac; and the latter was for <a href="https://www.figma.com/">Figma</a>, a proprietary
web-based graphics software.  There were samples in <code class="language-plaintext highlighter-rouge">.pdf</code> and <code class="language-plaintext highlighter-rouge">.jpg</code>, too.</p>

<p>Are you kidding me?  Providing open-source promotion material in two proprietary
formats?</p>

<p>I complained to the organisers that there was absolutely no way for Linux users
to open the <code class="language-plaintext highlighter-rouge">.sketch</code> file, and I don’t want to register a free account to use
Figma with limited functionality, and I won’t buy a Mac just for OSPP.  Even
<code class="language-plaintext highlighter-rouge">.psd</code> could be slightly better because GIMP and Krita could open a subset of
<code class="language-plaintext highlighter-rouge">.psd</code> files.  An organiser replied in an embarrassed tone, saying that the
artist who designed that poster was just asking them whether they should give
the organisers the <code class="language-plaintext highlighter-rouge">.psd</code> file, too.</p>

<p>From the conversation, it was obvious that the OSPP organisers hired an artist
to make a poster template for OSPP.  The artist was probably an average artist
who knew nothing about free open-source software, and the artist used their
familiar tool, which happened to be Adobe Photoshop, to do their job.  The
organisers of OSPP probably assumed that community representatives were artists
or other non-technical social media operators and probably used Mac, and
exported the templates in Mac-friendly formats.</p>

<h2 id="the-open-source-promotion-plan-was-not-promoting-open-source-the-right-way">The Open-source Promotion Plan was not promoting open-source the right way</h2>

<p><strong>The organisers of OSPP were not organising an event for the free software
community, but an average event whose theme happened to be about free
software.</strong></p>

<p>Using free software is such a basic thing for organising an event for the free
software community.  There are many free and open-source communication
platforms, such as <a href="https://zulip.com/">Zulip</a> which MMTk is using, as well as the good old IRC and
mailing lists.  There are storage services accessible using only free software,
such as their official website.  And there is free graphics software, such as
<a href="https://www.gimp.org/">GIMP</a> and <a href="https://krita.org/">Krita</a> for bitmaps, and <a href="https://inkscape.org/">Inkscape</a> for vector graphics.</p>

<p>And there are artists who are also free software lovers.  The Krita community
hosted <a href="https://krita.org/en/categories/artist-interview/">interviews</a> with artists who use Krita as their main
creative tool.  If you need help from artists who love free software, you can
just ask, because <strong>the free software community is all about creation and
sharing</strong>.  The KDE community held a <a href="https://dot.kde.org/2023/08/14/calling-all-artists-plasma-6-wallpaper-contest">Plasma 6 Wallpaper
Context</a>, with requirements including ‘releasing under the
CC-BY-SA-4.0 license’ and ‘creating the wallpaper in a non-proprietary format’.
Many artists <a href="https://discuss.kde.org/c/community/wallpaper-competition/26">submitted their work</a>, and the KDE community
eventually got a good-looking new default wallpaper for KDE 6, as shown below
(taken from their <a href="https://kde.org/announcements/megarelease/6/">official announcement of the KDE 6
MegaRelease</a>).</p>

<p><img src="/assets/img/plasma6-desktop.png" alt="Plasma 6 Screenshot" /></p>

<p>It was sad because it was so easy to do it right.  Just export the image to the
SVG format and all Linux users could edit the image using Inkscape.  It should
take a sophisticated artist less than ten minutes to do this, and a Linux user
to test if it works by opening the SVG image with Inkscape.  <em>But they did not
do it!</em></p>

<p>It was also sad because it had been three previous OSPP events and the
organisers were still yet to understand the nature of the free software
community.  I wonder why nobody from the 400+ communities complained about
similar issues before.</p>

<p><strong>Organising a free software event this way sent a very bad message to the
public that they didn’t really care about software freedom.</strong>  Ironically,
<a href="https://www.openeuler.org/">OpenEuler</a>, a domestic Linux distribution, was a co-organiser of OSPP’2023.
Using free image formats would have helped OpenEuler demonstrate that their
operating system was suitable for everyday use, but they didn’t.  I couldn’t
help visualising an OpenEuler user going nuts when they couldn’t use their own
operating system to open an image file from their own event.</p>

<p>In the end, we didn’t use their poster templates because a Markdown-formatted
post in our Zulip channel was just enough for promotional purpose, and we didn’t
have a social media account.  I’d rather spend one afternoon fixing some bugs
than trying to edit PDF or JPEG files directly, which would result in
bad-looking images anyway.  I raised an <a href="https://github.com/summer-ospp/publicity/issues/1">issue</a>, asking the
organisers to provide materials in free formats.  However, at the time of
writing, nobody had replied to that issue.</p>

<h1 id="the-ugly">The ugly</h1>

<p>Although the organisers of OSPP’2023 didn’t do a perfect job organising the
event, they promised to do it better next time.  I think there is still hope.
Given enough time, OSPP will eventually be organised in the right way.</p>

<p>However, there was still one thing that could be worse — the communities.  Not
all communities, of course.  Only a few of them.</p>

<p>An interesting fact was, although students were required to be enrolled in
universities (not written on their official website, but I confirmed with the
organisers), there was no such requirement for communities (any communities
using OSI-approved open-source licenses would qualify).  No offence to the
people who didn’t go to university and still made excellent free software, such
as <a href="https://en.wikipedia.org/wiki/Brian_Fox_(computer_programmer)">Brian Fox</a> who dropped out of high school and made the famous <a href="https://www.gnu.org/software/bash/">Bash</a> shell.
But that rule meant that you had to expect participating communities of any
quality, from bleeding edge research projects from the China Academy of Science
to hello-world projects made by first-time programmers, and their members to be
any kind of people you may possibly meet in streets or psychiatric hospitals (I
will elaborate, but no offence to the patients who are actually suffering from
mental disorders).</p>

<h2 id="they-gave-stars-to-each-others-repos">They gave stars to each other’s repos</h2>

<p>When I was invited into the WeChat group of 400+ community representatives, I
found some members were greeting each other and offering to give stars to each
other’s GitHub repositories.  One of them ‘kindly’ asked if he could give a star
to MMTk’s GitHub repository.  I didn’t thank him, but I replied that he needed a
five-star rating system for GitHub so that he could give one star to every repo
he barely knew, and five stars to the repos he honestly loved.</p>

<p>I consider it cheating to blindly give stars to repositories of one’s ‘friends’
for boosting their ‘reputation’.  That would make stars meaningless.  In that
way, a repo with lots of stars would mean many people genuinely liked it, or
merely mean the author had many ‘friends’.  I still prefer that stars mean the
former.</p>

<h2 id="they-wanted-everyone-to-know-their-software-err-sucks">They wanted everyone to know their software… err… sucks</h2>

<p>While organisers and community representatives were using the WeChat group as a
Q/A channel, several communities spammed the channel with news about every
single point release of their software.  Those posts became dominant since July
when the programming phase started and very few questions were asked about
administrivia.  That was annoying.</p>

<p>Well, since they dared spamming, I dared challenging them.</p>

<h3 id="they-said-they-were-faster-than-spring">They said they were faster than Spring…</h3>

<p>I looked at one project.  It advertised as a web framework, with <a href="https://spring.io/">Spring</a>-like
IoC container and annotation-based URL routing, but also supported GraalVM and
claimed to be many times faster than Spring.  Web, IoC and Graal.  Didn’t that
sound familiar?  Yes.  <a href="https://micronaut.io/">Micronaut</a>.  That is a Web framework, with Spring-like
IoC container, annotation-based URL routing, and GraalVM support, too.  I heard
about Micronaut about four or five years ago, but this project seemed to be
recently started, and poorly documented.</p>

<p>I asked its representative how his project was different from Micronaut.</p>

<p>‘The author of our project has never heard of Micronaut’, he answered,
embarrassed, ‘If I have to find any difference, it’s that our project is made in
China.’</p>

<p>Their official web site compared their framework against Spring all the time and
claimed to be much faster, but never mentioned Micronaut at all.  That was not
good.  You simply can’t claim your project is fast without comparing against the
main contenders.</p>

<h3 id="they-said-they-were-faster-than-netty">They said they were faster than Netty…</h3>

<p>Then another project spammed, and I looked at that, too.  It was a simple socket
abstraction layer written in Java, similar to <a href="https://netty.io/">Netty</a>, but poorly documented,
and claimed to be twice as fast as Netty.  I looked at the code for a moment and
found something like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And in another function:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="o">{</span>
    <span class="n">someNetworkOperation</span><span class="o">(...);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">setState</span><span class="o">(...);</span>
    <span class="n">someNetworkOperation</span><span class="o">(...);</span> <span class="c1">// Exception thrown on this line won't be caught.</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">handleNetworkOperationResult</span><span class="o">(...);</span> <span class="c1">// Hey! The network operation may have failed!</span>
<span class="o">}</span>
</code></pre></div></div>

<p>That didn’t look very professional, did it?  Anyone who has learned Java for a
few months knows that <code class="language-plaintext highlighter-rouge">e.printStackTrace()</code> is not the right way to handle
errors, and retrying a failed operation doesn’t guarantee that it will be
successful the second time.  Omitting all the error-handling code and running
micro benchmarks that always succeed will always give you good numbers, but
that’s meaningless.</p>

<p>I told its representative that they shouldn’t claim they were faster than Netty
while they were not doing exception handling properly, just like MMTk can’t
claim a GC algorithm to be faster while the write barrier was deliberately
turned off.  Otherwise people would challenge the result.</p>

<p>‘Our project has been challenged all along’, replied the project representative,
‘and I have long been used to it.  Only those who used our project know how
pleasant it is.’</p>

<p>Yuck!  What an irresponsible developer!</p>

<h4 id="but-people-were-speaking-for-him">But people were speaking for him!</h4>

<p>Strangely, some other people in the WeChat group started to speak for him.</p>

<ul>
  <li>One person said, ‘Some people want security while others want convenience.
Everyone will get what they love.’</li>
  <li>Another person said, ‘As a low-level employee, I can’t care less about how
users feel.  Only the CTO needs to care about users, and we programmers only
need to please ourselves.’</li>
</ul>

<p>Seriously?  I couldn’t believe what I saw.  I asked whether they care about
downstream projects built upon theirs (such as the ‘Chinese Micronaut’ mentioned
earlier which happens to be its downstream project), and apparently they didn’t.
Knowing this, I stopped arguing because that would be futile.</p>

<h2 id="they-hated-free-software-and-didnt-want-to-promote-it">They hated free software and didn’t want to promote it</h2>

<p>After I complained about OSPP’2023 not providing poster templates in free
formats, the organisers said they will be more considerate the next time.
However, other people in the WeChat group started whining.</p>

<ul>
  <li>One person said in some fields, free software were far worse than their
proprietary counterparts, therefore we (OSPP) may use proprietary software.</li>
  <li>Another person said it was good to practice the spirits of free software in
this event, but we don’t need to force it.</li>
  <li>Another person said that OSPP gave me money and I should be satisfied and
shut up.</li>
</ul>

<p>But let’s look at the poster sample again.</p>

<p><img src="/assets/img/ospp2023-poster.jpg" alt="Poster template" /></p>

<p>Does it look good?  Yes.  It does.  Well, it is good enough as a poster for an
event like OSPP, but not <em>that</em> good.  I still don’t quite like blue on blue, or
white on light blue.  It is not the case that it is so good, with all sorts of
fancy effects, that it has to be drawn using best-of-breed tools like Adobe
Photoshop.  Could anyone create a poster of similar quality (or even better)
using only free software?  Given the result of the <a href="https://dot.kde.org/2023/08/14/calling-all-artists-plasma-6-wallpaper-contest">wallpaper
contest</a>, the answer is obviously yes.  So the right question
is not whether we should force using free software, but <em>why not</em>.  OSPP stands
open-source promotion plan, and the use of free software should be the default,
the common sense, rather than something that needs to be ‘forced’.</p>

<h2 id="they-learned-english-for-nine-years-and-still-couldnt-read-simple-english-articles">They learned English for nine years and still couldn’t read simple English articles.</h2>

<p>And when I shared the <a href="https://krita.org/en/categories/artist-interview/">interviews with Krita artists</a>, someone
said he couldn’t understand those interviews because he didn’t speak English
well.</p>

<p>Seriously?  I started learning English since the fourth year in primary school,
and nowadays Chinese schools start teaching English as a compulsory course since
the third year.  By the time when students finish high school, they will have
been learning English for at least nine years (unless they were older than me
and received worse education in their childhood).  How could anyone learn
English for such a long time and still can’t understand simple articles like
those?</p>

<h2 id="and-they-hated-me">And they hated me.</h2>

<p>And someone mentioned me in the group chat, telling me he bought a Mac, a very
expensive model, for opening proprietary image formats.  I started to realise
that someone already started to hate me since I complained about all those
proprietary formats and irresponsible developers.</p>

<p>I told him that he could have donated the money to support three students.  He
apparently broke down mentally, and started telling a pathetic story about
himself, including dropping out of high school, joining an open-source
organisation, and making 5000+ commits per year which most people don’t believe.
Well, I believed what this poor guy said because he supplied a screenshot.  But
I felt sorry for his organisation because 5000+ commits per year means on
average less than 20 minutes for each commit.  You can achieve 5000+ commits per
year, too, if you make 5000+ trivial changes that take less than 20 minutes to
do, and the organisation enforces no code reviewing and no CI tests.  You can’t
do the same for the MMTk project because all pull requests need to be
peer-reviewed and go through comprehensive CI tests which take about an hour,
while performance-sensitive changes need to undergo performance evaluation on
specially tuned testing machine which takes hours if not days.</p>

<p>Strangely, several other people started to sympathise with him.</p>

<ul>
  <li>One said he didn’t have a high degree and had a hard time finding a job.</li>
  <li>Another said he only got 28 points (out of 150) in his English exam, and he
could have gone to Peking University if he got 100 points or more.</li>
</ul>

<p>And they swore to support each other.</p>

<p>How weird!  I know dropping out of high school does not prevent <a href="https://en.wikipedia.org/wiki/Brian_Fox_(computer_programmer)">Brian Fox</a> from
becoming a <a href="https://www.redhat.com/en/command-line-heroes/season-3/heroes-in-a-bash-shell">Hero in a Bash Shell</a>, but I never expected I was surrounded by so
many ‘heroes’.</p>

<h2 id="a-friend-of-mine">A friend of mine</h2>

<p>Later that year, a friend of mine visited me in Beijing after living overseas
for many years.</p>

<p>He told me that many companies in China were simply copying the business models
of companies overseas, but most of them had no idea what they were doing, and
will bankrupt quickly.  That meant if anyone or any company was doing honest
research and development work, they will already be better than 90% of their
peers in China.</p>

<p>Wait!  That sounded horribly familiar!  I told my friend about my experience in
OSPP.  I also mentioned a recent news about CEC-IDE (<a href="https://www.pixelstech.net/article/1693110126-Chinese-Developers-Release-CEC-IDE-Claimed-as-First-Independently-Developed-IDE">see this</a>).
CEC-IDE claimed to be an IDE fully original and fully made-in-China.  But it
ended up that they took the source code of <a href="https://code.visualstudio.com/">Visual Studio Code</a>, changed
its name, added a login window for paid ‘VIP’ services, added some plug-ins, and
labelled it as a home-brewed software, an ‘independently software developed by a
state-owned corporation, with trustworthy quality’ (and it was close-sourced).
Ironically, CEC-IDE was on the CCTV (China Central Television) News when it was
released, not long before it became the laughing stock of all Chinese netizens.</p>

<p>It was said that the government already invested hundreds of millions of CNY
into the project.</p>

<h2 id="the-whole-story">The whole story</h2>

<p>Everything suddenly became clear.  Here is the whole story, in four parts:</p>

<ol>
  <li>Since the trade war started, both Chinese companies and the Chinese
government worried about their software supply chains.</li>
  <li>They started pouring money into the field of domestic software and
open-source software, thinking they could be the rescue.</li>
  <li>Then some developers saw this as an opportunity.  Since the consumers wanted
domestic and open-source software, they just make domestic and open-source
software for them.</li>
</ol>

<p>Note that those developers don’t have to be FOSS lovers.  Anyone who wants some
quick money from investors may come, regardless of whether they like free
software, whether they worked with free software projects before, or whether
they use free software in their work.  That explains why someone don’t care
about whether we use free software in an open-source promotion plan.  And those
who speak for them were probably on the same boat.</p>

<p>But it is difficult to start from scratch, especially for those who have never
been free software contributor.  And here comes part four:</p>

<ol>
  <li>Instead, they simply copied existing open-source projects and label them as
domestically developed.</li>
</ol>

<p>Some copycats simply took the source code and changed the name.  Other more
sophisticated copycats wrote code from scratch, using existing open-source
projects as frames of reference.  Of course they didn’t care about the user, the
documentation or the code quality.  As long as it was made-in-China and/or
open-source, investors would throw money into it, and average people (especially
extreme nationalists) would hail it as the future star of China when they saw it
on the news.  And their bosses probably care more about the number of stars of
their repositories because that would attract more eyeballs and probably more
investment.  And fluency in English was not required as long as they do
everything domestically.  In fact, some netizens (again especially extreme
nationalists) have been advocating abolishing English education in China
(although <a href="http://www.chinadaily.com.cn/a/202103/20/WS60555c97a31024ad0bab06a5.html">the Chinese education authorities strongly
opposed</a>), giving them yet another excuse to fail in their
English exams.</p>

<p>Therefore, from time to time, we find Chinese open-source projects that are so
similar to world-famous ones, but claim to be domestically developed.</p>

<h2 id="the-consequence">The consequence</h2>

<p>A ‘software supply chain’ built this way will be brittle, if working at all.
High-level applications will be built on flawed low-level libraries which don’t
even handle exceptions properly and may break at any time.  But will low-level
developers care?  Probably not.  The decision of which library to use would be
way above their pay grade, and they would worry about their house rent and
mortgage much more than software quality.  Their bosses won’t worry about
software quality, either, if their companies monopolise a field, for example,
food ordering.  When the end users have to choose between one faulty software
and another because there are no other choices, all they can do is pressing the
reload button and pray it would work the next time.</p>

<p>And will we win the trade war this way?  Well, I won’t call it a win if average
people are oppressed by faulty software instead of foreign countries.</p>

<p>What about English skills?  Well, when they can’t fix their faulty software and
realise they can’t read English, they will beg linguists to translate the README
files of proper free software projects, while linguists ask them to wait in
queue because they are busy translating README files for their rival companies.
I’m sure the Chinese education authorities won’t let this happen.</p>

<h1 id="summary">Summary</h1>

<p>OSPP’2023 was awesome.</p>

<p>Students were smart and passionate.</p>

<p>The organisers tried hard keeping the event running, but there were much room
for improvement.</p>

<p>The communities?  Most of them were honestly doing free software developments,
while some people were completely jerks.</p>

<p>So should I tell people the Australian National University is awesome, and our
research group is doing interesting researches?  Yes, to the students, and
probably most community members, too.  In fact, some students already expressed
their interests in studying in the ANU when I told them about this possibility.</p>

<p>What about those who can’t even read simple English articles and those who make
bogus claims about their software performance?  ‘They are not our target
audience’, said one of my colleagues.  The ANU does have English language
requirements and severe punishment against academic dishonesty.</p>]]></content><author><name>Kunshan Wang</name></author><category term="blog" /><category term="mmtk" /><category term="ospp" /><summary type="html"><![CDATA[TL;DR: Last year, the MMTk project participated in the Open-Source Promotion Plan (OSPP). We mentored two students and they completed two student projects, which was cheering. But the OSPP’2023 event itself was organised in a way I found frustrating, and even hostile to the free software community. Meanwhile, I realised that there were toxic people lurking in the community, which was worrying. WARNING: Contains harsh words. Viewer discretion is advised.]]></summary></entry><entry><title type="html">SDDM + KDE Plasma Wayland Frozen After Login</title><link href="https://wks.github.io/blog/2023/12/10/plasmawayland-frozen-after-login.html" rel="alternate" type="text/html" title="SDDM + KDE Plasma Wayland Frozen After Login" /><published>2023-12-10T00:00:00+00:00</published><updated>2023-12-10T00:00:00+00:00</updated><id>https://wks.github.io/blog/2023/12/10/plasmawayland-frozen-after-login</id><content type="html" xml:base="https://wks.github.io/blog/2023/12/10/plasmawayland-frozen-after-login.html"><![CDATA[<p>I could not log into my computer this morning.  I was using <a href="https://github.com/sddm/sddm">SDDM</a> + <a href="https://kde.org/">KDE</a>
<a href="https://kde.org/plasma-desktop/">Plasma</a> with <a href="https://community.kde.org/KWin/Wayland">Wayland</a>.  When I typed my password and pressed ENTER, it stopped
responding.  The screen remained on the log-in screen, but the mouse cursor
disappeared.  I tried to switch terminal using CTRL+ALT+Fx (x = 2, 3, …, 8),
but that didn’t work, either.  What was wrong with it?  I kept trying and
eventually got the answer.</p>

<h1 id="rescue">Rescue</h1>

<p>Since CTRL+ALT+Fx didn’t work, I tried to log into my machine from another
machine via SSH.  It worked.  I managed to get a shell, and restarted SDDM using
<code class="language-plaintext highlighter-rouge">sudo systemctl restart sddm</code>.  Then my computer became responsive again.</p>

<h1 id="what-was-wrong">What was wrong?</h1>

<p>Many things could go wrong.  I updated quite some packages yesterday, and it was
ArchLinux.  As a rolling Linux distribution, any update could render the system
unusable.  But when I visited <a href="https://archlinux.org/">https://archlinux.org/</a>, no recent news mentioned
anything that needed manual intervention.</p>

<p>I was using NVidia’s open source driver (the <a href="https://archlinux.org/packages/extra/x86_64/nvidia-open/"><code class="language-plaintext highlighter-rouge">nvidia-open</code></a> package).  Could
that be a problem?  I uninstalled that package and rebooted.  It would still be
frozen after logging in.  So the display driver was not the problem.</p>

<p>I was using KDE Plasma Wayland session.  Could that be a problem?  I tried to
start the session by typing <code class="language-plaintext highlighter-rouge">startplasma-wayland</code> on a TTY, and that started the
session successfully for me.  So Plasma Wayland may not be the problem.</p>

<p>I was using SDDM, the default display manager for KDE Plasma.  Could that be a
problem?  I installed LXDM.  LXDM could start the Plasma X11 session, but it was
incapable of starting any Wayland sessions.  I installed LightDM, but for some
reasons it failed to start.  I installed GDM.  It could start the GNOME session,
but it didn’t detect the presence of Plasma Wayland.  In the end, I couldn’t
find any display manager that could start the Plasma Wayland session besides
SDDM.  It could be SDDM’s problem, but I couldn’t confirm it.</p>

<p>I tried to created another user, and tried to log in and start the Plasma
Wayland session via SDDM.  Surprisingly, it worked.  It gave my new user a
desktop with default settings.  This meant the problem was probably with my
personal configuration.</p>

<p>What configuration?</p>

<p>I was using <a href="https://fishshell.com">Fish</a> as my default shell.  I used <code class="language-plaintext highlighter-rouge">chsh</code> to
change my default shell to Bash, and tried to log in.  It worked.  It logged
into the Plasma Wayland session successfully.  So it narrowed down the problem
with my Fish configuration.</p>

<p>I moved my entire Fish configuration directory <code class="language-plaintext highlighter-rouge">~/.config/fish</code> away, and
attempted to login.  It worked.  That further confirmed that one (or more) of
my Fish configuration file was wrong.  Which one was it?</p>

<p>I tried to move my configuration files one by one from my backup location back
to <code class="language-plaintext highlighter-rouge">~/.config/fish</code>.  It ended up that the file <code class="language-plaintext highlighter-rouge">fish_variables</code> was the
culprit.</p>

<p>I then tried to gradually remove the lines from <code class="language-plaintext highlighter-rouge">fish_variables</code>.  In the end,
the culprit was the following line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SETUVAR --export UID:1000
</code></pre></div></div>

<p>It is a universal variable.  It means it could have been set at any moment in
the past, and it persisted until today and caused the failure.</p>

<h1 id="solution">Solution</h1>

<p>Removing the universal variable <code class="language-plaintext highlighter-rouge">UID</code> solved the problem, but I still don’t
understand why that variable was set in the first place.  And I don’t know why
it was frozen when the <code class="language-plaintext highlighter-rouge">UID</code> environment variable was set.  Actually I don’t
know exactly what was frozen, the SDDM, or something in the Plasma Wayland
session.</p>]]></content><author><name>Kunshan Wang</name></author><category term="blog" /><category term="kde" /><category term="wayland" /><summary type="html"><![CDATA[I could not log into my computer this morning. I was using SDDM + KDE Plasma with Wayland. When I typed my password and pressed ENTER, it stopped responding. The screen remained on the log-in screen, but the mouse cursor disappeared. I tried to switch terminal using CTRL+ALT+Fx (x = 2, 3, …, 8), but that didn’t work, either. What was wrong with it? I kept trying and eventually got the answer.]]></summary></entry><entry><title type="html">eBPF and Perfetto UI proved me wrong</title><link href="https://wks.github.io/blog/2023/10/04/proved-me-wrong.html" rel="alternate" type="text/html" title="eBPF and Perfetto UI proved me wrong" /><published>2023-10-04T00:00:00+00:00</published><updated>2023-10-04T00:00:00+00:00</updated><id>https://wks.github.io/blog/2023/10/04/proved-me-wrong</id><content type="html" xml:base="https://wks.github.io/blog/2023/10/04/proved-me-wrong.html"><![CDATA[<p>This blog post is about an experience of debugging <a href="https://www.mmtk.io/">MMTk</a> using a tracing and
visualisation tool based on eBPF and Perfetto UI.  During debugging, I tried to
guess what went wrong for many times, but the tool showed what actually happened
and proved me wrong each time.</p>

<h2 id="the-anomaly">The anomaly</h2>

<p>I made <a href="https://github.com/mmtk/mmtk-core/pull/794">a pull request</a> for MMTk-core.  It sped up all benchmarks in the
DaCapo Benchmarks suite, except the <code class="language-plaintext highlighter-rouge">jython</code> benchmark which <a href="https://github.com/mmtk/mmtk-core/pull/794#issuecomment-1521633617">became 3x
slower</a> in stop-the-world (STW) time (i.e. time spent doing
garbage collection).</p>

<p><small><em>In the following plot, <code class="language-plaintext highlighter-rouge">build3</code> is the baseline revision, <code class="language-plaintext highlighter-rouge">build1</code> is an
intermediate commit, and <code class="language-plaintext highlighter-rouge">build2</code> contains my final change.  The time is
normalised to <code class="language-plaintext highlighter-rouge">build3</code> for each benchmark.</em></small></p>

<p><img src="/assets/img/proved-me-wrong/pr794-stw.png" alt="DaCapo results" /></p>

<p>I could conclude that the <code class="language-plaintext highlighter-rouge">jython</code> benchmark had some abnormal behaviour and the
overall result (<code class="language-plaintext highlighter-rouge">build2</code> in <code class="language-plaintext highlighter-rouge">geomean</code>) was still speeding up.  But the 3x
slow-down was too significant to overlook.  I decided to investigate.</p>

<h2 id="ebpf-based-tracing-and-visualisation">eBPF-based tracing and visualisation</h2>

<p>Strangely, the slow-down was only observable on two of the testing machines in
our laboratory.  When I re-ran the <code class="language-plaintext highlighter-rouge">jython</code> benchmark with <code class="language-plaintext highlighter-rouge">build1</code>, <code class="language-plaintext highlighter-rouge">build2</code>
and <code class="language-plaintext highlighter-rouge">build3</code> on my laptop, their stop-the-world (STW) times were similar.  They
were either equally good or equally bad.  I guessed they were equally bad.  I
inferred that the problem was non-deterministic.  It may be triggered under some
unknown conditions.</p>

<p>The slow-down was in the STW time, which meant some GC activities became slower.
But how would I know <em>which</em> GC activity was slow?</p>

<p>At that time, my colleagues were developing a eBPF-based tracing tool which can
record the duration of each work packet during a GC, and visualise them on a
timeline.  Its overhead when not used was so low that we can leave the trace
points in the code in release builds, and active them whenever we want to
measure something.  I thought it was the perfect tool for my task.  Although the
tool was still being developed, I asked my colleagues for a copy and gave it a
try anyway.</p>

<p>The tool included a patch to the MMTk Core source code which inserted USDT (user
statically-defined tracing) tracepoints at important places.  They were compiled
as <code class="language-plaintext highlighter-rouge">NOP</code> instructions, but could be patched at run time to execute custom code.
I used the <code class="language-plaintext highlighter-rouge">bpftrace</code> command line utility to activate those tracepoints to
record the start and the end of each work packet, then used a script to format
the output into a JSON format which was then sent to Perfetto UI.  Perfetto UI
showed what happened during a GC in a timeline.</p>

<p>Actually, I observed two different timeline patterns from different GCs when
running the <code class="language-plaintext highlighter-rouge">jython</code> benchmark.</p>

<p>The first pattern (I called it the ‘kind 1’ GC) looked like this:</p>

<p><img src="/assets/img/proved-me-wrong/pr794-gc-kind1.png" alt="timeline pattern of 'kind 1' GC" /></p>

<p>This was a minor GC in a generational GC algorithm, and it was quite a typical
one.</p>

<p>The green arrows in Thread 192576 marked the start of each stage.</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">Prepare</code> stage happened before the green arrow near the ‘24.0792 s’
mark, during which there were many work packets named <code class="language-plaintext highlighter-rouge">ScanXxxxRoot(s)</code>.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Closure</code> stage happened between that green arrow and the next green
arrow after the ‘24.0796 s’ mark, during which there were many green
<code class="language-plaintext highlighter-rouge">GenNurseryProcessEdges</code> work packets.</li>
  <li>Then there were some short intermediate stages, such as <code class="language-plaintext highlighter-rouge">FinalRefClosure</code>
which handled finalization.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Release</code> stage happened near the end of the GC between the ‘24.0797 s’
and the ‘24.0798 s’ marks, where each worker executed some clean-up job.</li>
</ul>

<p>Since a minor GC does not trace much objects (it only traces the nursery), the
<code class="language-plaintext highlighter-rouge">Closure</code> stage did not took much time.  A ‘kind 1’ GC typically takes only
about 1 ms, despite the <code class="language-plaintext highlighter-rouge">ScanStackRoot</code> work packet in Thread 192587 and the
<code class="language-plaintext highlighter-rouge">GenNurseryProcessEdges</code> packet in Thread 192581 being a bit too big due to an
unrelated load-imbalance problem.</p>

<p>The second pattern (I called it the ‘kind 2’ GC) looked like this:</p>

<p><img src="/assets/img/proved-me-wrong/pr794-gc-kind2.png" alt="timeline pattern of 'kind 2' GC" /></p>

<p>This was also a minor (nursery) GC, too, seen form packet name
<code class="language-plaintext highlighter-rouge">GenNurseryProcessEdges</code>.  The <code class="language-plaintext highlighter-rouge">Prepare</code> stage and the <code class="language-plaintext highlighter-rouge">Closure</code> stage are
similar to the ‘kind 1’.  (Please note the horizontal scale of the timeline.
The <code class="language-plaintext highlighter-rouge">Prepare</code> and the <code class="language-plaintext highlighter-rouge">Closure</code> stages were in the far left of this plot, before
the <code class="language-plaintext highlighter-rouge">Finalization</code> packet.)  What was interesting was the <code class="language-plaintext highlighter-rouge">FinalRefClosure</code>
stage where finalization were done.  After the <code class="language-plaintext highlighter-rouge">Finalization</code> packet, lots of
<code class="language-plaintext highlighter-rouge">GenNurseryProcessEdges</code> work packets were executed.  It was obvious that
finalization resurrected many objects.  A ‘kind 2’ GC is significantly longer
than a ‘kind 1’ GC.  It may take more than 15 ms to execute.</p>

<p>Given that finalization is non-deterministic, we might infer that the slow-down
was caused by an excessive amount of finalization due to non-deterministic
execution.  Problem solved…, or was it?  I still needed to verify.</p>

<h2 id="printing-out-the-gc-times">Printing out the GC times</h2>

<p>I printed out the GC time of each GC in <code class="language-plaintext highlighter-rouge">jython</code> when running on a test machine
in the lab.</p>

<p>With 1500M heap size, the GC time (i.e. STW time) of the original code
(<code class="language-plaintext highlighter-rouge">build3</code>) and my modification (<code class="language-plaintext highlighter-rouge">build2</code>) were:</p>

<ul>
  <li>Before: 2,2,1,8,1,2,9ms</li>
  <li>After: 1,21,1,10,1,20,9ms</li>
</ul>

<p>So the GCs that took 21, 10, 20 and 9 ms should be doing finalization, right?</p>

<p>I ran it on another test machine (with identical hardware) with 1500M heap, too:</p>

<ul>
  <li>Before: 2,1,1,11,1,3,8ms</li>
  <li>After: 2,27,1,9,2,25,8ms</li>
</ul>

<p>The results were similar between two machines.  I then tried to reduce the heap
size.</p>

<p>When I reduce the heap size to 500M:</p>

<ul>
  <li>Before: 1,1,1,1,1,2,2,1,1,5,9,2,2,1,2,1,1,2,1,2,1,5,8,4</li>
  <li>After: 1,1,1,1,1,30,1,1,1,4,8,1,1,1,1,1,1,27,1,1,1,3,8,4</li>
</ul>

<p>When I reduce the heap size to 250M:</p>

<ul>
  <li>Before: 1,1,2,2,2,1,1,2,1,1,2,1,3,1,2,2,1,1,1,1,2,4,5,6,4,1,1,2,1,1,2,1,1,1,2,2,1,2,2,2,2,2,1,1,1,1,1,2,1,1,4,7,5,4,2,2,</li>
  <li>After: 1,1,1,1,1,1,1,1,1,1,2,1,29,1,1,1,2,1,1,1,1,4,6,6,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,2,25,1,1,1,1,1,1,1,1,1,4,5,5,4,1,1,</li>
</ul>

<p>If the slow-down were caused by excessive finalization, I would expect one build
to have more GCs that had more than 15 ms of STW time.  But it was not the case.
Two builds had the same number of GCs, and the GC time of each pair of
corresponding GCs were similar, too, except two pairs.  No matter how large the
heap size was, there were always exactly two GCs that took more than 20 ms in
the ‘After’ case (i.e. <code class="language-plaintext highlighter-rouge">build2</code>, the build with my PR applied).  For other GCs,
most of them took 1 ms and I assumed they were the ‘kind 1’ GCs; some of them
took 5 ms to 10 ms and I guessed they were the ‘kind 2’ GCs.</p>

<p>So the two 20+ ms GCs were interesting.  What happened during them?  Were they
slow because of finalization, too?</p>

<p>I re-ran the test at 250M heap size on my laptop.  Strange things happened.</p>

<ul>
  <li>Before: 1,1,1,1,1,2,1,1,1,1,1,2,1,2,2,1,2,2,2,2,1,2,1,5,7,7,6,1,2,1,1,1,2,1,1,1,2,1,2,2,2,1,1,2,2,2,1,2,2,2,1,1,2,2,2,1,5,7,6,5,1,2,2,</li>
  <li>After: 2,1,1,1,1,1,1,1,2,1,1,1,2,2,2,1,2,2,2,2,1,1,1,7,8,7,5,1,1,2,1,1,1,1,1,1,2,2,1,1,1,2,1,2,2,2,1,1,1,1,1,1,1,1,1,4,6,6,6,4,1,1,</li>
</ul>

<p>The mysterious 20 ms GCs vanished!</p>

<p>This meant those 20 ms GCs were definitely not ‘kind 2’ GCs because otherwise I
would have observed them on my laptop.</p>

<p>This also meant I could not capture those mysterious 20 ms GCs on my laptop
using eBPF tracing.  I could only capture them on the lab machines.</p>

<h2 id="manual-tracing">Manual tracing</h2>

<p>Since I could not use eBPF tracing on the lab machine due to lack of root
access, I manually instrumented the code to log the starts and ends of each work
packets.  I printed the log in the same format as the output of the eBPF tool,
used the same script to process the log into the JSON format, and fed the JSON
into Perfetto UI.  Then a nice timeline came out.  (And you can try it by your
self.  Load <a href="/assets/data/proved-me-wrong/log_manual2.txt.json.gz">this log file</a> into <a href="https://www.ui.perfetto.dev/">https://www.ui.perfetto.dev/</a> and
browse the timeline interactively.)</p>

<p><img src="/assets/img/proved-me-wrong/pr794-manual-perfetto-after.png" alt="the 'after' build, manually traced" /></p>

<p>And that was a strange timeline, too.  Why was the <code class="language-plaintext highlighter-rouge">ProcessRegionModBuf</code> work
packet so large?  The purpose of the <code class="language-plaintext highlighter-rouge">ProcessRegionModBuf</code> work packet is
handling the write barriers for bulk accesses of arrays (such as
<code class="language-plaintext highlighter-rouge">System.arraycopy()</code> in Java) between the last GC and this GC.</p>

<p>There might be two possibilities:</p>

<ol>
  <li>The <code class="language-plaintext highlighter-rouge">jython</code> benchmark did call <code class="language-plaintext highlighter-rouge">System.arraycopy()</code> on a very large array,
therefore the work packet should exist in order to process the write
barrier.  However, it did not appear in the ‘Before’ build (<code class="language-plaintext highlighter-rouge">build3</code>) due to
a bug.</li>
  <li>The <code class="language-plaintext highlighter-rouge">jython</code> benchmark did not copy large arrays at all, but a bug (probably
introduced or triggered by my PR) caused the write barrier to erroneously
record an access to a large array while it did not, resulting in an
abnormally large <code class="language-plaintext highlighter-rouge">ProcessRegionModBuf</code> work packet.</li>
</ol>

<p>So which one was true?</p>

<h2 id="hacking-the-write-barriers">Hacking the write barriers</h2>

<p>I added a log at the place where a <code class="language-plaintext highlighter-rouge">ProcessRegionModBuf</code> work packet is created
in order to see the sizes of the <code class="language-plaintext highlighter-rouge">ProcessRegionModBuf</code> work packets.</p>

<p>When running on the lab machines,</p>

<ul>
  <li>in the ‘before’ build, all <code class="language-plaintext highlighter-rouge">ProcessRegionModBuf</code> work packets had lengths of
0;</li>
  <li>in the ‘after’ build, <code class="language-plaintext highlighter-rouge">ProcessRegionModBuf</code> came in all different sizes.</li>
</ul>

<p>When running on my laptop, all <code class="language-plaintext highlighter-rouge">ProcessRegionModBuf</code> work packets had lengths
of 0.</p>

<p>But it does not make sense to copy zero elements using <code class="language-plaintext highlighter-rouge">System.arraycopy()</code>!</p>

<p>Then I had reasons to believe that there was a bug in the write barrier code so
that in the ‘before’ build, the write barrier failed to record any accessed
array regions, making the GC erroneously faster than it should have been.  In
the ‘after’ build, the bug was not triggered, so the accessed array regions were
recorded by write barriers as usual, resulting in a longer but actually normal
STW time.  In other words, it was not my PR that made the STW time longer, but
the STW time had been shorter than it should have been.</p>

<p>One of my colleagues reminded me that there was an <a href="https://github.com/wenyuzhao/mmtk-openjdk/commit/1c384fd86ffe843afac779e85a98f6550a355923">un-merged
commit</a> that fixes a bug in the write barrier code in the
MMTK-OpenJDK binding.  It was intended to fix an unrelated bug, but it was still
worth giving it a try.</p>

<p>I cherry-picked that commit, and…  Voila!  It fixed the bug!  The ‘before’
build then exhibited the two 20+ ms GCs, just like the ‘after’ build.</p>

<ul>
  <li>Before: 1,2,2,1,1,29,1,1,2,5,8,2,1,1,1,2,1,29,1,1,1,4,9,3,</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>At this point, we could draw the conclusion.  The STW time for the <code class="language-plaintext highlighter-rouge">jython</code>
benchmark should have been 3x longer.  However, due to the bug fixed by <a href="https://github.com/wenyuzhao/mmtk-openjdk/commit/1c384fd86ffe843afac779e85a98f6550a355923">this
commit</a>, the barrier did not record the bulk accesses to arrays
properly, and therefore did less things than it should have done.  When I was
running the DaCapo benchmarks at the beginning of this blog post, I set the heap
size too large (1500M).  With such a large heap size, GC was only triggered a
few times, and the proportion of write barrier handling became more significant
in STW time.  Therefore the STW time for <code class="language-plaintext highlighter-rouge">jython</code> was only 1/3 of the normal
time due to the missing write barrier handling.</p>

<p>However, my PR changed the behaviour in some way, and the bug was somehow not
triggered when running on the test machines in the lab.  And the sub-optimal
implementation of the <code class="language-plaintext highlighter-rouge">ProcessRegionModBuf</code> work packet stuffed all the array
slices delivered from barriers into one single vector, making it impossible to
parallelise.  It gave us a false impression that my PR made the <code class="language-plaintext highlighter-rouge">jython</code>
benchmark 3x slower on the lab machines.</p>

<p>And due to non-determinism, the bug was still reproducible on my laptop with my
PR applied.  That was why I saw the 3x slow-down on the lab machines but not on
my laptop.</p>

<h2 id="what-did-i-learn">What did I learn?</h2>

<p>There is a saying that ‘One can not optimise things that one can not measure’.  It
is very true.  I can hypothesise what caused the performance problem, but I can
never be sure unless I verify it with experiment.  In this example, I first
thought the slow-down was just some random behaviour of the <code class="language-plaintext highlighter-rouge">jython</code> benchmark.
I then thought the slow-down was due to excessive finalization.  But experiments
showed that the actual cause was a bug in the write barrier.</p>

<p>And the visualisation tool is a very useful one.  It first showed me that some
GCs took longer time due to finalisation, and it then showed me that there were
even longer GCs due to buggy and sub-optimal write barrier handling.  It is such
a useful tool because with the timeline in front of me, I no longer need to
guess what slowed things down.  I just look at the timeline, and the work packet
that becomes the bottleneck will stand out of the crowd.  Since the eBPF-based
tracing and visualisation tool was created, I have been using it to debug many
performance issues in GC, including the execution of <code class="language-plaintext highlighter-rouge">obj_free</code>, various weak
table processing tasks, and the load-balancing problems in the <a href="https://github.com/mmtk/mmtk-ruby">MMTk-Ruby
binding</a>.</p>

<p>For example, when I saw the following timeline, I knew the handling of
<code class="language-plaintext highlighter-rouge">obj_free</code> was the bottleneck.</p>

<p><img src="/assets/img/proved-me-wrong/ruby-obj-free.png" alt="`obj_free` was the bottleneck in MMTk-Ruby" /></p>

<p>When I saw the following timeline (with manual annotation of which work packet
created which), I knew the load balancing of the transitive closure stage needed
to be improved.</p>

<p><img src="/assets/img/proved-me-wrong/ruby-load-balance.png" alt="bad load-balance during transitive closure" /></p>

<p>And when I saw the following timeline, I knew the general load balancing was
improved, but some objects took significantly longer to scan than other objects,
and I should focus on those objects because they were the bottleneck.</p>

<p><img src="/assets/img/proved-me-wrong/ruby-scan-object.png" alt="some objects took longer to scan" /></p>

<h2 id="the-tool">The tool</h2>

<p>I thank Claire Huang, <a href="https://www.zcai.org/">Zixian Cai</a>, and <a href="https://users.cecs.anu.edu.au/~steveb/">Prof. Steve Blackburn</a> for
creating such a useful tool.</p>

<p>The tool is now publicly available.  The code has been <a href="https://github.com/mmtk/mmtk-core/commit/b6ffcddeef2407ed910dc1ef98e0d038cc4a1eb6">merged</a>
into the master branch of <a href="https://github.com/mmtk/mmtk-core">mmtk-core</a>.  Related tools and documentation can be
found in <a href="https://github.com/mmtk/mmtk-core/tree/master/tools/tracing">this directory</a>.</p>

<p>The paper that describes this work is <a href="https://users.cecs.anu.edu.au/~steveb/pubs/papers/ebpf-mplr-2023.pdf">freely available online</a>
under the Creative Commons Attribution 4.0 International License, and will be
presented <a href="https://2023.splashcon.org/details/mplr-2023-papers/11/Improving-Garbage-Collection-Observability-with-Performance-Tracing">in the MPLR 2023 conference</a>.</p>]]></content><author><name>Kunshan Wang</name></author><category term="blog" /><category term="mmtk" /><category term="ebpf" /><category term="perfetto" /><summary type="html"><![CDATA[This blog post is about an experience of debugging MMTk using a tracing and visualisation tool based on eBPF and Perfetto UI. During debugging, I tried to guess what went wrong for many times, but the tool showed what actually happened and proved me wrong each time.]]></summary></entry><entry><title type="html">MMTk in An Ancient Wuxia World</title><link href="https://wks.github.io/blog/2023/01/28/lspgdx-with-mmtk.html" rel="alternate" type="text/html" title="MMTk in An Ancient Wuxia World" /><published>2023-01-28T00:00:00+00:00</published><updated>2023-01-28T00:00:00+00:00</updated><id>https://wks.github.io/blog/2023/01/28/lspgdx-with-mmtk</id><content type="html" xml:base="https://wks.github.io/blog/2023/01/28/lspgdx-with-mmtk.html"><![CDATA[<p>TL;DR: During last Christmas, I tried to run <a href="https://gitlab.com/m210/LSPGDX">LSPGDX</a>, a 3D FPS game implemented
in Java using OpenJDK with the MMTk binding.  It worked, but not perfectly.  GC
pauses are still a problem.</p>

<p><em>Disclaimer: This is not part of the research of the <a href="https://www.mmtk.io/">MMTk</a> project, and is not
sponsored by the Australian National University or Shopify.</em></p>

<h1 id="the-first-fps-game-i-played">The first FPS game I played</h1>

<p>When I was nine or ten years old, I played a PC game named
“摇滚少林系列之七侠五义3D”, or “Rock’n’Shaolin: Legend of the Seven Paladins 3D”
(abbreviated as “L7P” or “LSP”).  That was the first first-person shooting (FPS)
game I played.  That was an unusual FPS game because of its Chinese <a href="https://en.wikipedia.org/wiki/Wuxia">Wuxia</a>
theme.  Instead of using guns, the player fights using ancient Chinese weapons
and “qigong”, a powerful martial art that launches fireballs at the enemies.</p>

<p><img src="/assets/img/l7p-title.png" alt="Title screen" />
<img src="/assets/img/l7p-gameplay.png" alt="L7P Game Play (melee)" />
<img src="/assets/img/l7p-gameplay3.png" alt="L7P Game Play (qigong)" /></p>

<p>The game was released in 1990s and, like many games of that era, it ran on DOS.
However, many games of that era (such as Doom and Duke Nukem 3D) also released
the source code of their game engines so that developers could port the games to
modern platforms.  Such ports are called <a href="https://en.wikipedia.org/wiki/Source_port">source ports</a>.  For
example, <a href="https://www.zdoom.org/index">zdoom</a> is a port of Doom’s “id Tech 1” engine, and <a href="https://www.eduke32.com/">eduke32</a> is a port
of Duke3D’s “Build” engine.  Those ports allow us to play those 1990s games on
modern GNU/Linux, MacOS, Windows, and many operating systems and hardwares you
can imagine.</p>

<p>I wondered if there is a source port for the Legend of the Seven Paladins 3D,
too.  Fortunately, there is.</p>

<p>During Christmas last year, I found the <a href="https://gitlab.com/m210/BuildGDX">BuildGDX</a> project and <a href="https://m210.duke4.net/">many other
projects developed by M210</a>.  <a href="https://gitlab.com/m210/BuildGDX">BuildGDX</a> is a port of the Build
engine written in Java, and there are also ports of many Build engine games,
such as DukeGDX for Duke Nukem 3D, WangGDX for Shadow Warrior, BloodGDX for
Blood, and <a href="https://gitlab.com/m210/LSPGDX">LSPGDX</a> for L7P.  It ended up that L7P was also built on the Build
engine, and it was surprisingly the first game based on (an unreleased version
of) the Build engine!</p>

<p>I cloned the repositories, converted the Eclipse projects to Idea projects,
worked around some issues, and I managed to run it on my laptop, with ArchLinux
and OpenJDK 19.  Here is a screenshot.  Note that LSPGDX changed the HUD a
little bit to adapt to modern high-resolution displays.  The game window was a
bit small, though, because I hadn’t figured out how to change the window size by
then.</p>

<p><img src="/assets/img/lspgdx-gameplay.png" alt="LSPGDX game play" /></p>

<h1 id="can-it-run-with-mmtk">Can it run with MMTk?</h1>

<p>Since it ran on OpenJDK, an immediate question came to my mind: “Does it run
with MMTk?”  My colleagues and I have been actively maintaining <a href="https://github.com/mmtk/mmtk-openjdk/">mmtk-openjdk</a>,
the OpenJDK VM binding of MMTk.  In version 10, OpenJDK refactored its GC
framework and introduced a GC interface, making it easy to plug in new GC
algorithms.  Our MMTk binding implements that interface and allows OpenJDK to
use any GC algorithms MMTk provides.  It should be a drop-in replacement for its
GC.</p>

<p>And it actually worked.  After fixing some <a href="https://github.com/mmtk/mmtk-openjdk/pull/191">issues about soft
references</a>, LSPGDX ran on OpenJDK 11 with the MMTk
binding.</p>

<p><img src="/assets/img/lspgdx-mmtk-1.png" alt="LSPGDX title screen with MMTk" /></p>

<p>Pay attention to the log output <code class="language-plaintext highlighter-rouge">[...  INFO mmtk::plan::global] User triggering
collection</code>. That was produced by MMTk core, and that meant the VM was actually
using MMTk.</p>

<p>I gave it a 128MB heap.  (That was way too generous.  Back in the DOS era, that
game ran with 4MB of total memory!)  The game manually triggers a GC during
start-up and another time when loading a saved game.</p>

<p><img src="/assets/img/lspgdx-mmtk-2.png" alt="LSPGDX game play with MMTk" /></p>

<p>As the player walked in the corridors, it only triggered GC once every half
minutes.  The game lagged a little bit when GC happens, but was hardly
noticeable.</p>

<p>However, when entering an area with a lot of enemies, like this one…</p>

<p><img src="/assets/img/lspgdx-fight.png" alt="Fighting many enemies" /></p>

<p>… it started to trigger GC once every several seconds.  What was worse, every
GC froze the game for about 3 seconds.  Note the timestamp of the log messages
“Triggering collection” and “End of GC” in the following screenshot.</p>

<p><img src="/assets/img/lspgdx-mmtk-3.png" alt="MMTk sometimes has very long GC pause" /></p>

<p>I stopped the game because the frequent GC pauses made the game unplayable.</p>

<p>The GC algorithm I chose was Immix, a high-throughput but non-generational
non-concurrent GC. There was a bug by then that prevented Generational Immix
from running.  But even if the GC was generational, once a full-heap GC
happened, it would just take as long as this one.</p>

<p>This experiment showed that GC latency matters for game applications.  And MMTk
does have a concurrent GC algorithm.  The concurrent <a href="https://users.cecs.anu.edu.au/~steveb/pubs/papers/lxr-pldi-2022.pdf">LXR</a> GC algorithm was
published last year, but has not been merged into the mainline MMTk core, yet.
I’ll probably try playing LSPGDX with MMTk again when LXR stablises.</p>

<h1 id="my-forks">My forks</h1>

<p>Since then, I have been hacking BuildGDX and LSPGDX to fix bugs and enhance the
gameplay.  If you are interested, you can clone my repositories on GitLab.</p>

<ul>
  <li>BuildGDX: <a href="https://gitlab.com/wks/BuildGDX">https://gitlab.com/wks/BuildGDX</a></li>
  <li>LSPGDX: <a href="https://gitlab.com/wks/LSPGDX">https://gitlab.com/wks/LSPGDX</a></li>
</ul>]]></content><author><name>Kunshan Wang</name></author><category term="blog" /><category term="mmtk" /><category term="l7p" /><summary type="html"><![CDATA[TL;DR: During last Christmas, I tried to run LSPGDX, a 3D FPS game implemented in Java using OpenJDK with the MMTk binding. It worked, but not perfectly. GC pauses are still a problem.]]></summary></entry><entry><title type="html">Chris Seaton passed away</title><link href="https://wks.github.io/blog/2022/12/08/chris-seaton-passed-away.html" rel="alternate" type="text/html" title="Chris Seaton passed away" /><published>2022-12-08T00:00:00+00:00</published><updated>2022-12-08T00:00:00+00:00</updated><id>https://wks.github.io/blog/2022/12/08/chris-seaton-passed-away</id><content type="html" xml:base="https://wks.github.io/blog/2022/12/08/chris-seaton-passed-away.html"><![CDATA[<p>I am very sad to heard about the death of <a href="https://chrisseaton.com/">Chris Seaton</a>, our collaborator.</p>

<p><a href="https://www.shopify.com">Shopify</a> generously sponsored the <a href="https://www.mmtk.io/">MMTk</a> project to develop <a href="https://github.com/mmtk/mmtk-ruby">mmtk-ruby</a>, a VM
binding that enables <a href="https://www.ruby-lang.org/">Ruby</a> to use MMTk as its garbage collector, and Chris has
been the person actively working with us.  Over the past few years, he has
provided support for Angus Atkinson, the initial developer of mmtk-ruby, and me
who continued the development of mmtk-ruby after Angus.  Although we never met
in person, I received great help from him during regular online meetings. He
helped me getting familiar with the Ruby runtime with which I had no prior
experience, and provided suggestions handling impedance mismatches between MMTk
and Ruby.  While I focused on getting MMTk to work, he helped with adding
MMTk-related version flags, command-line options and other ergonomics.  He fixed
tests and set up a nightly build server.  He helped identifying bugs in MMTk and
its API.  He also helped promoting our project, letting the community know our
effort of improving Ruby with a powerful GC framework.</p>

<p>Sadly, Chris is no longer with us.  It is a great loss for the MMTk project as
well as the whole programming language and virtual machine community.</p>]]></content><author><name>Kunshan Wang</name></author><category term="blog" /><category term="mmtk" /><category term="ruby" /><summary type="html"><![CDATA[I am very sad to heard about the death of Chris Seaton, our collaborator.]]></summary></entry><entry><title type="html">Traversing nested lists with coroutines, Rosetta Code style</title><link href="https://wks.github.io/blog/2022/09/22/coroutine-flatten.html" rel="alternate" type="text/html" title="Traversing nested lists with coroutines, Rosetta Code style" /><published>2022-09-22T00:00:00+00:00</published><updated>2022-09-22T00:00:00+00:00</updated><id>https://wks.github.io/blog/2022/09/22/coroutine-flatten</id><content type="html" xml:base="https://wks.github.io/blog/2022/09/22/coroutine-flatten.html"><![CDATA[<p>I’ll try to use <strong>coroutines</strong> to traverse nested lists, Rosetta Code style.
That means I’ll do it in many different programming languages and libraries,
including Ruby, Lua, Python (including greenlets), JavaScript, Rust, C#, etc.
This task shows the difference between <em>symmetric</em> vs <em>asymmetric</em> coroutines,
and <em>stackful</em> vs <em>stackless</em> coroutines.</p>

<p>Note that this post alone may not be enough to teach you how to use coroutines
in all those languages.</p>

<p>I’ll also provide basic information about coroutines, swap-stack, async/await,
etc. in the appendices.</p>

<!--more-->

<h1 id="the-task">The task</h1>

<p><strong>Input</strong>:</p>

<ul>
  <li>a nested list of numbers, such as <code class="language-plaintext highlighter-rouge">[1, [[2, 3], [4, 5]], [6, 7, 8]]</code></li>
</ul>

<p><strong>Output</strong>:</p>

<ul>
  <li>
    <p>recursively output all numbers in the list.  At each level, visit all
numbers in one element before visiting any subsequent elements.</p>

    <p>When given the list above, the output should be 1, 2, 3, 4, 5, 6, 7 and
8, in that order.</p>
  </li>
</ul>

<p><strong>Requirement</strong>:</p>

<ul>
  <li>Use coroutine(s) to enumerate a nested list, and yield elements to the
calling coroutine one at a time.</li>
</ul>

<p>I will try to do this task using as many programming languages as possible,
<a href="https://rosettacode.org/wiki/Rosetta_Code">Rosetta Code</a> style, to compare their coroutine syntax and API.
At the time of writing (2022), different programming languages still differ
greatly w.r.t. the design of coroutines.</p>

<h1 id="the-code">The code</h1>

<h2 id="ruby-fibers-stackful-both-asymmetric-and-symmetric">Ruby fibers (stackful, both asymmetric and symmetric)</h2>

<p><a href="https://docs.ruby-lang.org/en/3.1/Fiber.html">Fibers</a> are “primitives for implementing light weight cooperative
concurrency in Ruby”.</p>

<p>Ruby fibers are stackful.  According to the <a href="https://docs.ruby-lang.org/en/3.1/Fiber.html">documentation</a>:</p>

<blockquote>
  <p>As opposed to other stackless light weight concurrency models, each fiber
comes with a stack. This enables the fiber to be paused from deeply nested
function calls within the fiber block.</p>
</blockquote>

<p>Ruby fibers can operate in both asymmetric and symmetric mode.  I’ll demonstrate
the task in both modes below.</p>

<h3 id="asymmetric">Asymmetric</h3>

<p>The <a href="https://docs.ruby-lang.org/en/3.1/Fiber.html#method-i-resume"><code class="language-plaintext highlighter-rouge">Fiber#resume</code></a> instance method resumes a fiber, and a subsequent call to
the <a href="https://docs.ruby-lang.org/en/3.1/Fiber.html#method-c-yield"><code class="language-plaintext highlighter-rouge">Fiber.yield</code></a> class method jumps back to the resumer.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Array</span>
    <span class="n">x</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">elem</span><span class="o">|</span>
      <span class="n">traverse</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>      <span class="c1"># recursive call</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="no">Fiber</span><span class="p">.</span><span class="nf">yield</span> <span class="n">x</span>         <span class="c1"># can yield within recursive calls</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">fiber_traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="no">Fiber</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
    <span class="n">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">StopIteration</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="n">fiber</span> <span class="o">=</span> <span class="n">fiber_traverse</span> <span class="no">DATA</span>

<span class="kp">loop</span> <span class="k">do</span>   <span class="c1"># Break if StopIteration is raised.</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="nf">resume</span>
  <span class="nb">puts</span> <span class="n">value</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The <a href="https://docs.ruby-lang.org/en/3.1/Enumerator.html"><code class="language-plaintext highlighter-rouge">Enumerator</code></a> class can automatically transform
block-based visiting functions into fiber-based coroutine.  It uses fiber only
when necessary.  It uses fiber when used as external iterators (calling <code class="language-plaintext highlighter-rouge">e.next</code>
explicitly), but still uses call-back for internal iteration (<code class="language-plaintext highlighter-rouge">e.each { |v| ...
}</code>).</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Array</span>
    <span class="n">x</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">elem</span><span class="o">|</span>
      <span class="n">traverse</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="n">block</span><span class="p">.</span><span class="nf">yield</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># This is just a usual method call, not a coroutine yield.</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">enum_traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="no">Enumerator</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">yielder</span><span class="o">|</span>   <span class="c1"># The yielder encapsulates how to yield.</span>
    <span class="n">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
      <span class="n">yielder</span><span class="p">.</span><span class="nf">yield</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>      <span class="c1"># This may or may not use coroutine yield.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="c1"># We can do internal iteration</span>
<span class="n">enum_traverse</span><span class="p">(</span><span class="no">DATA</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>   <span class="c1"># use call-back</span>
  <span class="nb">puts</span> <span class="n">value</span>
<span class="k">end</span>

<span class="c1"># and external iteration too.</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">enum_traverse</span><span class="p">(</span><span class="no">DATA</span><span class="p">)</span>
<span class="kp">loop</span> <span class="k">do</span>           <span class="c1"># Break if StopIteration is raised.</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">next</span>  <span class="c1"># This will use fiber.</span>
  <span class="nb">puts</span> <span class="n">value</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="symmetric">Symmetric</h3>

<p>The <a href="https://docs.ruby-lang.org/en/3.1/Fiber.html#method-i-transfer"><code class="language-plaintext highlighter-rouge">Fiber#transfer</code></a> method can switch to any fiber, but always needs an
explicit fiber to switch to.  We can pass the current fiber to the new fiber
when we create it, so it can remember which fiber to transfer back to.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="nb">require</span> <span class="s2">"fiber"</span> 

<span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Array</span>
    <span class="n">x</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">elem</span><span class="o">|</span>
      <span class="n">traverse</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>  <span class="c1"># always remember the parent</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="n">parent</span><span class="p">.</span><span class="nf">transfer</span> <span class="n">x</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">fiber_traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">current</span> <span class="o">=</span> <span class="no">Fiber</span><span class="p">.</span><span class="nf">current</span>     <span class="c1"># get the current fiber</span>
  <span class="no">Fiber</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
    <span class="n">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>      <span class="c1"># pass the fiber as parent</span>
    <span class="k">raise</span> <span class="no">StopIteration</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="n">fiber</span> <span class="o">=</span> <span class="n">fiber_traverse</span> <span class="no">DATA</span>
<span class="kp">loop</span> <span class="k">do</span>   <span class="c1"># Break if StopIteration is raised.</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="nf">transfer</span>
  <span class="nb">puts</span> <span class="n">value</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="lua-threads-stackful-asymmetric">Lua threads (stackful, asymmetric)</h2>

<p>Lua “threads” are stackful coroutines.  Lua has a stackless interpreter,
therefore it can easily implement stackful coroutines (Why? See
<a href="#apdx-sisc">appendix</a>).</p>

<p>Lua provides asymmetric coroutines (with limitations) for the sake of
<em>simplicity</em> and <em>portability</em>.</p>

<ul>
  <li>
    <p><strong>Simplicity</strong>: According to <a href="http://www.lua.org/doc/jucs04.pdf"><em>Coroutines in Lua</em></a>, asymmetric
coroutines may be easier to understand.</p>

    <blockquote>
      <p>On the other hand, asymmetric coroutines truly behave like routines, in
  the sense that control is always transferred back to their callers. Since
  even novice programmers are familiar with the concept of a routine,
  control sequencing with asymmetric coroutines seems much simpler to manage
  and understand, besides allowing the development of more structured
  programs</p>
    </blockquote>
  </li>
  <li>
    <p><strong>Portability</strong>: Supporting symmetric coroutines (or even proper stackful
asymmetric coroutines) will require C to have coroutine facilities, such as
<a href="#swap-stack">swap-stack</a>, which is not always available. According to <a href="http://www.lua.org/doc/jucs04.pdf"><em>Coroutines in
Lua</em></a>:</p>

    <blockquote>
      <p>Lua and C code can freely call each other; therefore, an application can
  create a chain of nested function calls wherein the languages are
  interleaved. Implementing a symmetric facility in this scenario imposes
  the preservation of C state when a Lua coroutine is suspended. This
  preservation is only possible if a coroutine facility is also provided for
  C; but a portable implementation of coroutines for C cannot be written.</p>
    </blockquote>

    <p>Lua also added a limitation: <em>a coroutine cannot yield while there are C
function frames on its stack</em>.  Otherwise, Lua would require a <a href="#swap-stack">swap-stack</a>
mechanism for C, making Lua less portable.</p>
  </li>
</ul>

<p>In Lua, the <a href="http://www.lua.org/manual/5.4/manual.html#pdf-coroutine.resume"><code class="language-plaintext highlighter-rouge">coroutine.resume</code></a> function continues the execution of a
coroutine, and <a href="http://www.lua.org/manual/5.4/manual.html#pdf-coroutine.yield"><code class="language-plaintext highlighter-rouge">coroutine.yield</code></a> jumps back to the calling coroutine.</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre><span class="k">function</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"table"</span> <span class="k">then</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">traverse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>         <span class="c1">-- recursive call</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>    <span class="c1">-- can yield within recursive calls</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">coroutine_traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
    <span class="n">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">list</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">{{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">}},</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">}}</span>

<span class="kd">local</span> <span class="n">coro</span> <span class="o">=</span> <span class="n">coroutine_traverse</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
  <span class="kd">local</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
    <span class="k">break</span>   <span class="c1">-- terminated</span>
  <span class="k">end</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The <a href="http://www.lua.org/manual/5.4/manual.html#pdf-coroutine.wrap"><code class="language-plaintext highlighter-rouge">coroutine.wrap</code></a> function can wrap the coroutine into an iterator
function suitable for the <a href="http://www.lua.org/manual/5.4/manual.html#3.3.5">generic <code class="language-plaintext highlighter-rouge">for</code> statement</a>.</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="k">function</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"table"</span> <span class="k">then</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">traverse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">coroutine_traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">coroutine.wrap</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
    <span class="n">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">list</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">{{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">}},</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">}}</span>

<span class="k">for</span> <span class="n">value</span> <span class="k">in</span> <span class="n">coroutine_traverse</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="python-generators-stackless-asymmetric">Python generators (stackless, asymmetric)</h2>

<p>Python generators are a built-in feature since Python 2.x.  They are
single-frame coroutines.</p>

<p>A function that contains a <a href="https://docs.python.org/3/reference/expressions.html#grammar-token-python-grammar-yield_expression"><code class="language-plaintext highlighter-rouge">yield</code></a> keyword is considered a
generator function.  Calling a generator function will create a new generator
object stopped at the beginning of the function, and can be resumed with the
<a href="https://docs.python.org/3/library/functions.html#next"><code class="language-plaintext highlighter-rouge">next(...)</code></a> built-in function.</p>

<p>Being stackless, each coroutine has only one frame, so it cannot yield while
calling another function.  To implement recursive traversal with stackless
coroutines, it is common to create one generator for each level of nested list,
and yield values from the innermost coroutine to the outer coroutine, level by
level.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">new_gen</span> <span class="o">=</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>    <span class="c1"># Create the next level of generator
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">new_gen</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">v</span>             <span class="c1"># Yield everything the inner generator yields
</span>            <span class="k">except</span> <span class="nb">StopIteration</span><span class="p">:</span>       <span class="c1"># until iteration stops.
</span>                <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">x</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="n">gen</span> <span class="o">=</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>    <span class="c1"># The top-level generator
</span><span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>   <span class="c1"># Iterate through it
</span>        <span class="nf">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">StopIteration</span><span class="p">:</span>   <span class="c1"># until iteration stops.
</span>    <span class="k">pass</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Python’s <a href="https://docs.python.org/3/reference/compound_stmts.html#the-for-statement"><code class="language-plaintext highlighter-rouge">for</code></a> statement is a syntax sugar for calling <code class="language-plaintext highlighter-rouge">next(...)</code>
until the exception <a href="https://docs.python.org/3/library/exceptions.html#StopIteration"><code class="language-plaintext highlighter-rouge">StopIteration</code></a> is thrown.  The <a href="https://docs.python.org/3/reference/simple_stmts.html#the-yield-statement"><code class="language-plaintext highlighter-rouge">yield
from</code></a> statement is a syntax sugar for yielding everything from
another generator.  Using all the syntax sugar, the code above will become the
following:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">yield</span> <span class="k">from</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>   <span class="c1"># Use "yield from" to yield everything.
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">x</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">DATA</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="python-coroutines-wtf">Python coroutines (WTF?)</h2>

<p>Python 3.5 attempts to introduce <a href="#async-await">async/await</a>-based asynchronous programming
mechanisms, but it used the word “<a href="https://docs.python.org/3/reference/compound_stmts.html#coroutines">coroutine</a>” to refer to
functions annotated with the <code class="language-plaintext highlighter-rouge">async</code> keyword, like <code class="language-plaintext highlighter-rouge">async def foo(...)</code>, which
is confusing.  Async functions may contain the new <a href="https://docs.python.org/3/reference/expressions.html#await"><code class="language-plaintext highlighter-rouge">await</code></a>
expression, but its semantics is <a href="https://docs.python.org/3/reference/expressions.html#await">very vaguely defined</a> as “suspend
the execution of coroutine on an awaitable object”, whatever “on an awaitable
object” means. That is in stark contrast to the highly detailed semantics of
<a href="https://timsong-cpp.github.io/cppwp/n4861/expr.await#5"><code class="language-plaintext highlighter-rouge">co_await</code> expression in C++20</a> and the <a href="https://doc.rust-lang.org/reference/expressions/await-expr.html"><code class="language-plaintext highlighter-rouge">.await</code> expression in
Rust</a>.</p>

<blockquote>
  <p>In the face of ambiguity, refuse the temptation to guess.</p>

  <p><em>– <a href="https://legacy.python.org/dev/peps/pep-0020/">Zen of Python</a></em></p>
</blockquote>

<p>Because it is so confusing, I am not going to do the task using Python
“coroutines”.</p>

<h2 id="python-greenlet-stackful-symmetric">Python greenlet (stackful, symmetric)</h2>

<h3 id="symmetric-1">Symmetric</h3>

<p>The <a href="https://greenlet.readthedocs.io/en/latest/index.html">greenlet</a> library provides stackful symmetric coroutines.</p>

<p>Greenlets are stackful.  According to the <a href="https://greenlet.readthedocs.io/en/latest/greenlet.html">documentation</a>:</p>

<blockquote>
  <p>A “greenlet” is a small independent pseudo-thread. Think about it as a small
stack of frames; the outermost (bottom) frame is the initial function you
called, and the innermost frame is the one in which the greenlet is currently
paused.</p>
</blockquote>

<p>Greenlets are symmetric.  One greenlet can switch to another using the
<a href="https://greenlet.readthedocs.io/en/latest/api.html#greenlet.greenlet.switch"><code class="language-plaintext highlighter-rouge">glet.switch()</code></a> method to pass a value, or
<a href="https://greenlet.readthedocs.io/en/latest/api.html#greenlet.greenlet.throw"><code class="language-plaintext highlighter-rouge">glet.throw()</code></a> to switch and immediately raise an exception.</p>

<p>There are implementations of Greenlets for both CPython and PyPy.</p>

<p>The official greenlet implementation for CPython uses platform-specific assembly
code (for <a href="https://github.com/python-greenlet/greenlet/blob/master/src/greenlet/platform/switch_amd64_unix.h">amd64</a>, <a href="https://github.com/python-greenlet/greenlet/blob/master/src/greenlet/platform/switch_aarch64_gcc.h">aarch64</a>,
<a href="https://github.com/python-greenlet/greenlet/blob/master/src/greenlet/platform/switch_riscv_unix.h">riscv</a>, etc.) to switch native stacks, similar to what
[Boost Context] does.</p>

<p>PyPy <a href="https://doc.pypy.org/en/latest/stackless.html#greenlets">implements the greenlet API</a> using
<a href="https://doc.pypy.org/en/latest/stackless.html#stacklets">stacklets</a>, which are PyPy’s own swap-stack mechanism.  Like
[Boost Context] and the official greenlet for CPython, PyPy also uses
platform-specific assembly code (for <a href="https://foss.heptapod.net/pypy/pypy/-/blob/branch/default/rpython/translator/c/src/stacklet/switch_x86_64_gcc.h">x86-64</a>,
<a href="https://foss.heptapod.net/pypy/pypy/-/blob/branch/default/rpython/translator/c/src/stacklet/switch_aarch64_gcc.h">aarch64</a>, <a href="https://foss.heptapod.net/pypy/pypy/-/blob/branch/default/rpython/translator/c/src/stacklet/switch_mips64_gcc.h">mips64</a>, etc.  Sorry,
RISC-V.) to switch between stacks.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="n">greenlet</span>

<span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="nf">traverse</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>      <span class="c1"># recursive call
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">parent</span><span class="p">.</span><span class="nf">switch</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                <span class="c1"># can switch at any level of stack
</span>        
<span class="k">def</span> <span class="nf">greenlet_traverse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">.</span><span class="nf">getcurrent</span><span class="p">()</span>     <span class="c1"># remember the current coroutine
</span>    <span class="k">def</span> <span class="nf">_traverse_x</span><span class="p">():</span>
        <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>            <span class="c1"># and pass it as the parent
</span>        <span class="n">current</span><span class="p">.</span><span class="nf">throw</span><span class="p">(</span><span class="nb">StopIteration</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">greenlet</span><span class="p">.</span><span class="nf">greenlet</span><span class="p">(</span><span class="n">_traverse_x</span><span class="p">)</span>

<span class="n">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="n">glet</span> <span class="o">=</span> <span class="nf">greenlet_traverse</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">glet</span><span class="p">.</span><span class="nf">switch</span><span class="p">()</span>   <span class="c1"># switch to the greenlet
</span>        <span class="nf">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">StopIteration</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="emulate-asymmetric-coroutine-using-the-parent-field">Emulate asymmetric coroutine using the <code class="language-plaintext highlighter-rouge">parent</code> field</h3>

<p>We have just demonstrated that greenlets are symmetric.  However, each greenlet
has a <a href="https://greenlet.readthedocs.io/en/latest/greenlet.html#greenlet-parents">parent</a>.  It is the coroutine to switch to when the
current coroutine terminates, normally or by exception.  However, it doesn’t
mean greenlets are asymmetric because the parent can be changed at any time
during execution, and it is not wrong to explicitly <code class="language-plaintext highlighter-rouge">switch</code> to the parent.</p>

<p>We can rewrite our last example and use the <code class="language-plaintext highlighter-rouge">glet.parent</code> field instead of our
own <code class="language-plaintext highlighter-rouge">parent</code> variable to record the parent.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="n">greenlet</span>

<span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="nf">traverse</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">greenlet</span><span class="p">.</span><span class="nf">getcurrent</span><span class="p">().</span><span class="n">parent</span><span class="p">.</span><span class="nf">switch</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># switch to parent
</span>        
<span class="k">def</span> <span class="nf">greenlet_traverse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_traverse_x</span><span class="p">():</span>
        <span class="nf">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">raise</span> <span class="nc">StopIteration</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">greenlet</span><span class="p">.</span><span class="nf">greenlet</span><span class="p">(</span><span class="n">_traverse_x</span><span class="p">)</span>  <span class="c1"># The parent is the current greenlet
</span>
<span class="n">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="n">glet</span> <span class="o">=</span> <span class="nf">greenlet_traverse</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">glet</span><span class="p">.</span><span class="nf">switch</span><span class="p">()</span>   <span class="c1"># switch to the greenlet
</span>        <span class="nf">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">StopIteration</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="javascript-generators-stackless-asymmetric">JavaScript generators (stackless, asymmetric)</h2>

<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*"><code class="language-plaintext highlighter-rouge">function*</code></a> declaration defines a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator">generator
function</a>. Generator functions can have <code class="language-plaintext highlighter-rouge">yield</code> operator that
pauses the execution of the coroutine.</p>

<p>When a generator function called, it creates a generator object.  It can be used
like an iterator.  The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols#the_iterator_protocol"><code class="language-plaintext highlighter-rouge">next</code></a> method switches to the coroutine.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="kd">function</span><span class="o">*</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nf">isArray</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">elem</span> <span class="k">of</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">y</span> <span class="k">of</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">elem</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">yield</span> <span class="nx">y</span><span class="p">;</span>  <span class="c1">// Yield what the inner layer yields.</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">yield</span> <span class="nx">x</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]];</span>

<span class="kd">let</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">DATA</span><span class="p">);</span>
<span class="k">for </span><span class="p">(;;)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nf">next</span><span class="p">();</span>  <span class="c1">// Resumes the coroutine.</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>And there are syntax sugars.  The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/yield*"><code class="language-plaintext highlighter-rouge">yield*</code></a> operator yields
everything from another generator.  Because a generator behaves like an
iterator, the <code class="language-plaintext highlighter-rouge">for-of</code> statement can iterate through the values it yields.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="kd">function</span><span class="o">*</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nf">isArray</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">elem</span> <span class="k">of</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">yield</span><span class="o">*</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">yield</span> <span class="nx">x</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">v</span> <span class="k">of</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">DATA</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="javascript-asyncawait-stackless-asymmetric-asynchronous">JavaScript async/await (stackless, asymmetric, asynchronous)</h2>

<p>JavaScript provides asynchronous programming facilities in the form of
<a href="#async-await">async/await</a> (see <a href="#async-await">appendix</a>).  An <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function"><code class="language-plaintext highlighter-rouge">async</code>
function</a> always returns a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise"><code class="language-plaintext highlighter-rouge">Promise</code></a> object which
can be settled (fulfilled or rejected) later.  An <code class="language-plaintext highlighter-rouge">async</code> function may contain
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await"><code class="language-plaintext highlighter-rouge">await</code> operators</a> which cause async function execution to pause
until its operand (a <code class="language-plaintext highlighter-rouge">Promise</code>) is settled, and resume execution after
fulfilment.</p>

<p>Asynchronous programming is more like cooperative multi-tasking than coroutines.</p>

<p><a id="async-await-example"></a></p>

<p>Despite the difference, I now give an example of traversing nested lists using
async/await.  I create two concurrent tasks, one traverses the nested list, and
the other prints the numbers, and they communicate through a “zero-capacity
queue”.  It is similar to multi-thread programming, except there is only one
thread executing both tasks in alternation, and the execution is scheduled by a
scheduler.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="code"><pre><span class="c1">// A zero-capacity queue.</span>
<span class="c1">// `enqueue` will block until another task calls `dequeue`,</span>
<span class="c1">// and `dequeue` will block until another task calls `enqueue`.</span>
<span class="kd">class</span> <span class="nc">ZeroQueue</span> <span class="p">{</span>
    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">getter_resolver</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setter_resolver</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="nf">enqueue</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getter_resolver</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If a consumer came before, we satisfy it.</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">getter_resolver</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">getter_resolver</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// If we come first, we leave the value and wait until consumed.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">num</span>
            <span class="k">await</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setter_resolver</span> <span class="o">=</span> <span class="nx">resolve</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="nf">dequeue</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">setter_resolver</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If a producer already came, we take the value and let it continue.</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">setter_resolver</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setter_resolver</span> <span class="o">=</span> <span class="kc">null</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// If we come first, we wait for the producer.</span>
            <span class="k">return</span> <span class="k">await</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">getter_resolver</span> <span class="o">=</span> <span class="nx">resolve</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZeroQueue</span><span class="p">()</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nf">isArray</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">elem</span> <span class="k">of</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">await</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// await may potentially yield,</span>
        <span class="c1">// giving the user an impression of block-waiting.</span>
        <span class="k">await</span> <span class="nx">queue</span><span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">print_all</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for </span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="c1">// await may potentially yield,</span>
        <span class="c1">// giving the user an impression of block-waiting.</span>
        <span class="kd">const</span> <span class="nx">v</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">queue</span><span class="p">.</span><span class="nf">dequeue</span><span class="p">()</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="c1">// The first task traverses the list and signal termination.</span>
<span class="nf">traverse</span><span class="p">(</span><span class="nx">DATA</span><span class="p">).</span><span class="nf">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// The second task keep polling till the end.</span>
<span class="nf">print_all</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="javascript-async-generators-stackless-asymmetric-asynchronous">JavaScript async generators (stackless, asymmetric, asynchronous)</h2>

<p>Functions annotated with <code class="language-plaintext highlighter-rouge">async function*</code> defines an async generator function.
An <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/AsyncGenerator">async generator</a> is like a generator, but the <code class="language-plaintext highlighter-rouge">.next()</code>
method returns a <code class="language-plaintext highlighter-rouge">Promise</code> so it can be awaited.  This allows the generator to
use <code class="language-plaintext highlighter-rouge">await</code> while iterating.  It can also use the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for-await...of"><code class="language-plaintext highlighter-rouge">for await ... of</code>
statement</a> as a syntax sugar.</p>

<p>This practice is like building coroutine on top of async/await on top of
coroutine, which looks ugly to me.  Anyway, here is the code:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="k">async</span> <span class="kd">function</span><span class="o">*</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nf">isArray</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">elem</span> <span class="k">of</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">yield</span><span class="o">*</span> <span class="k">await</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">yield</span> <span class="nx">x</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">DATA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="k">await </span><span class="p">(</span><span class="kd">const</span> <span class="nx">v</span> <span class="k">of</span> <span class="nf">traverse</span><span class="p">(</span><span class="nx">DATA</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">main</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="rust-asyncawait-stackless-asymmetric-asynchronous">Rust async/await (stackless, asymmetric, asynchronous)</h2>

<p>Rust’s <code class="language-plaintext highlighter-rouge">async</code> and <code class="language-plaintext highlighter-rouge">await</code> keywords provides support for <a href="#async-await">asynchronous
programming</a> (see <a href="#async-await">appendix</a>) based on stackless asymmetric
coroutines.  There is <a href="https://rust-lang.github.io/async-book/">a dedicated book</a> that covers
asynchronous programming in Rust.</p>

<p>An <a href="https://doc.rust-lang.org/reference/items/functions.html#async-functions"><code class="language-plaintext highlighter-rouge">async</code> function</a> or an <a href="https://doc.rust-lang.org/reference/expressions/block-expr.html#async-blocks"><code class="language-plaintext highlighter-rouge">async</code> block</a>,
when executed, do not execute their bodies immediately, but creates an object
that holds the execution context of that function or block.  Each async function
or block is represented to the user as a <code class="language-plaintext highlighter-rouge">Future</code>.  The <code class="language-plaintext highlighter-rouge">Future::poll</code> method
will resume the async thing until it yields (on an <code class="language-plaintext highlighter-rouge">await</code> site) or finishes.</p>

<p>The <a href="https://doc.rust-lang.org/reference/expressions/await-expr.html"><code class="language-plaintext highlighter-rouge">await</code> expression</a> can only be used in <code class="language-plaintext highlighter-rouge">async</code> functions or
blocks.  Its semantics is complicated but <a href="https://doc.rust-lang.org/reference/expressions/await-expr.html">well-documented</a>. It
calls <code class="language-plaintext highlighter-rouge">Future::poll</code> on a <code class="language-plaintext highlighter-rouge">Future</code> object and, if the <code class="language-plaintext highlighter-rouge">Future</code> is ready, it
grabs its value continues without yielding; otherwise, it yields from the
current <code class="language-plaintext highlighter-rouge">async</code> function or block.  When resumed, it will poll the <code class="language-plaintext highlighter-rouge">Future</code>
again and may or may not yield depending on whether the <code class="language-plaintext highlighter-rouge">Future</code> is ready.</p>

<p>Implementation-wise, <a href="https://rust-lang.github.io/async-book/01_getting_started/04_async_await_primer.html">the documentation suggests</a> that
Rust decomposes an <code class="language-plaintext highlighter-rouge">async</code> function (or block) into a state machine (see
<a href="#function-to-state-machine">appendix</a>) where each state represents an <code class="language-plaintext highlighter-rouge">await</code> site.</p>

<p>Async/await is not supposed to be used like coroutines.  In fact, the book
Asynchronous Programming in Rust <a href="https://rust-lang.github.io/async-book/01_getting_started/02_why_async.html#async-vs-other-concurrency-models">contrasts async/await against
coroutines</a>.  I have given an example in JavaScript
that traverses nested list using async/await using two tasks and a channel.  It
is possible to do the same in Rust, but that’ll need a scheduler.  Since I am
too lazy to write a scheduler or introduce a third-party scheduler, I’ll try a
different approach here.</p>

<p>I’ll abuse the async/await mechanism to exploit its underlying coroutine and
make it behave like a generator.</p>

<ul>
  <li>
    <p><em>Resume</em>: We know that <code class="language-plaintext highlighter-rouge">Future::poll</code> resumes the coroutine.  We call
<code class="language-plaintext highlighter-rouge">Future::poll</code> directly, which is seldom done in usual async/await-based
programs unless we are implementing the “executor” (i.e. scheduler).</p>
  </li>
  <li>
    <p><em>Yield</em>: Each <code class="language-plaintext highlighter-rouge">.await</code> corresponds to a yield site.  We customise the
behaviour of our <code class="language-plaintext highlighter-rouge">Future</code> object (i.e. <code class="language-plaintext highlighter-rouge">WaitUntilResultTaken</code>) so that the
<code class="language-plaintext highlighter-rouge">.await</code> always yields (<code class="language-plaintext highlighter-rouge">Pending</code>) when reached from within the coroutine,
but will continue (<code class="language-plaintext highlighter-rouge">Ready</code>) when resumed from the main function.  The
behaviour is controlled by the <code class="language-plaintext highlighter-rouge">result_taken</code> variable.</p>
  </li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">async fn traverse</code> will recursively call itself in the <code class="language-plaintext highlighter-rouge">.await</code> expression,
and will yield level by level through all the <code class="language-plaintext highlighter-rouge">.await</code> sites to the main
function.</p>

<p>Then we have a problem.  Whenever it yields, the value yielded to the <code class="language-plaintext highlighter-rouge">.poll()</code>
call site in <code class="language-plaintext highlighter-rouge">main</code> is always <code class="language-plaintext highlighter-rouge">Poll::Pending</code>.  Then how do we pass the
traversed numbers to <code class="language-plaintext highlighter-rouge">main</code>?  To work around this, the coroutine writes the
number in a shared variable <code class="language-plaintext highlighter-rouge">result_reporter.num</code> before it yields. This makes
the <code class="language-plaintext highlighter-rouge">ResultReporter</code> struct effectively behave like a “zero-capacity queue” in
our <a href="#async-await-example">previous example</a>, but it connects the generator and
the main function instead of two tasks.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
</pre></td><td class="code"><pre><span class="k">use</span> <span class="nn">async_recursion</span><span class="p">::</span><span class="n">async_recursion</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">future</span><span class="p">::</span><span class="n">Future</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">pin</span><span class="p">::</span><span class="nb">Pin</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">sync</span><span class="p">::</span><span class="nn">atomic</span><span class="p">::{</span><span class="n">AtomicBool</span><span class="p">,</span> <span class="n">AtomicI32</span><span class="p">,</span> <span class="n">Ordering</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">task</span><span class="p">::{</span><span class="n">Context</span><span class="p">,</span> <span class="n">Poll</span><span class="p">};</span>

<span class="nd">#[derive(Default)]</span>
<span class="k">struct</span> <span class="n">ResultReporter</span> <span class="p">{</span>
    <span class="n">num</span><span class="p">:</span> <span class="n">AtomicI32</span><span class="p">,</span> <span class="c1">// Rust is having problem figuring out whether the coroutine races with main,</span>
    <span class="n">result_taken</span><span class="p">:</span> <span class="n">AtomicBool</span><span class="p">,</span> <span class="c1">// so we just use atomic variables here.</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">ResultReporter</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">report_result</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">'a</span> <span class="k">self</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">WaitUntilResultTaken</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.num</span><span class="nf">.store</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nn">Ordering</span><span class="p">::</span><span class="n">Relaxed</span><span class="p">);</span>
        <span class="k">self</span><span class="py">.result_taken</span><span class="nf">.store</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="nn">Ordering</span><span class="p">::</span><span class="n">Relaxed</span><span class="p">);</span>
        <span class="n">WaitUntilResultTaken</span> <span class="p">{</span>
            <span class="n">result_taken</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.result_taken</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">fn</span> <span class="nf">take_result</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">num</span> <span class="o">=</span> <span class="k">self</span><span class="py">.num</span><span class="nf">.load</span><span class="p">(</span><span class="nn">Ordering</span><span class="p">::</span><span class="n">Relaxed</span><span class="p">);</span>
        <span class="k">self</span><span class="py">.result_taken</span><span class="nf">.store</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="nn">Ordering</span><span class="p">::</span><span class="n">Relaxed</span><span class="p">);</span>
        <span class="n">num</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">WaitUntilResultTaken</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">result_taken</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="n">AtomicBool</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="n">Future</span> <span class="k">for</span> <span class="n">WaitUntilResultTaken</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">Output</span> <span class="o">=</span> <span class="p">();</span>

    <span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="k">self</span><span class="p">:</span> <span class="nb">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span> <span class="k">Self</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Context</span><span class="o">&lt;</span><span class="nv">'_</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Poll</span><span class="o">&lt;</span><span class="k">Self</span><span class="p">::</span><span class="n">Output</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.result_taken</span><span class="nf">.load</span><span class="p">(</span><span class="nn">Ordering</span><span class="p">::</span><span class="n">Relaxed</span><span class="p">)</span> <span class="p">{</span>
            <span class="nn">Poll</span><span class="p">::</span><span class="nf">Ready</span><span class="p">(())</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nn">Poll</span><span class="p">::</span><span class="n">Pending</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">NestedList</span> <span class="p">{</span>
    <span class="nf">Leaf</span><span class="p">(</span><span class="nb">i32</span><span class="p">),</span>
    <span class="nf">Nested</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">NestedList</span><span class="o">&gt;</span><span class="p">),</span>
<span class="p">}</span>

<span class="nd">#[async_recursion]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">list</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">NestedList</span><span class="p">,</span> <span class="n">reporter</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">ResultReporter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">match</span> <span class="n">list</span> <span class="p">{</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="c1">// This `await` expression will call `WaitUntilResultTaken::poll()` twice.</span>
            <span class="c1">// The first time is when we reach the `await` here.  It returns `Poll::Pending` so we yield.</span>
            <span class="c1">// The second time is when `main` calls `poll`.  It returns `Poll::Ready(())` so we continue.</span>
            <span class="n">reporter</span><span class="nf">.report_result</span><span class="p">(</span><span class="o">*</span><span class="n">num</span><span class="p">)</span><span class="k">.await</span>
        <span class="p">}</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="n">lists</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="k">in</span> <span class="n">lists</span> <span class="p">{</span>
                <span class="c1">// This `await` will pass the `Poll::Pending` to the caller level by level until it reaches `main`.</span>
                <span class="nf">traverse</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">reporter</span><span class="p">)</span><span class="k">.await</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// [1, [[2, 3], [4, 5]], [6, 7, 8]]</span>
    <span class="k">let</span> <span class="n">nested_list</span> <span class="o">=</span> <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span><span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">3</span><span class="p">)]),</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span><span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">5</span><span class="p">)]),</span>
        <span class="p">]),</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
        <span class="p">]),</span>
    <span class="p">]);</span>

    <span class="k">let</span> <span class="n">result_reporter</span> <span class="o">=</span> <span class="nn">ResultReporter</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">coro</span> <span class="o">=</span> <span class="nf">traverse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result_reporter</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">null_ctx</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="nn">std</span><span class="p">::</span><span class="nn">ptr</span><span class="p">::</span><span class="nn">null_mut</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">};</span>

    <span class="k">loop</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">coro_p</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">Pin</span><span class="p">::</span><span class="nf">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">coro</span><span class="p">)</span> <span class="p">};</span>
        <span class="k">let</span> <span class="n">poll_result</span> <span class="o">=</span> <span class="n">coro_p</span><span class="nf">.poll</span><span class="p">(</span><span class="n">null_ctx</span><span class="p">);</span> <span class="c1">// Let the coroutine run.</span>
        <span class="k">match</span> <span class="n">poll_result</span> <span class="p">{</span>
            <span class="nn">Poll</span><span class="p">::</span><span class="n">Pending</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="c1">// When pausing (at `await` sites) during execution, we get the result.</span>
                <span class="k">let</span> <span class="n">num</span> <span class="o">=</span> <span class="n">result_reporter</span><span class="nf">.take_result</span><span class="p">();</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nn">Poll</span><span class="p">::</span><span class="nf">Ready</span><span class="p">(())</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="c1">// When finished, we just quit.</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="rust-coroutine-crate-stackful-asymmetric">Rust coroutine crate (stackful, asymmetric)</h2>

<p>The third-part crate <a href="https://docs.rs/coroutine/latest/coroutine/"><code class="language-plaintext highlighter-rouge">coroutine</code></a> provides stackful asymmetric
coroutines.  It is built upon the <code class="language-plaintext highlighter-rouge">context</code> crate (see below).</p>

<p>It looks like this crate has not been maintained for quite some time and it
won’t compile. I’ll not do the task using the <code class="language-plaintext highlighter-rouge">coroutine</code> crate.  If you are
interested, their documentation contains some examples.</p>

<h2 id="rust-context-crate-stackful-symmetric">Rust context crate (stackful, symmetric)</h2>

<p>The third-part crate <a href="https://docs.rs/context/latest/context/index.html"><code class="language-plaintext highlighter-rouge">context</code></a> is similar to [Boost Context]. It
provides the abstraction of stackful symmetric coroutines.</p>

<p>It implements swap-stack using machine-specific assembly code
(<a href="https://github.com/zonyitoo/context-rs/blob/master/src/asm/jump_x86_64_sysv_elf_gas.S">x86-64</a>, <a href="https://github.com/zonyitoo/context-rs/blob/master/src/asm/make_arm64_aapcs_elf_gas.S">AArch64</a>,
<a href="https://github.com/zonyitoo/context-rs/blob/master/src/asm/jump_ppc64_sysv_elf_gas.S">ppc64</a>, sorry RISC-V).</p>

<p>The <a href="https://docs.rs/context/latest/context/context/struct.Context.html#method.resume"><code class="language-plaintext highlighter-rouge">Context::resume</code></a> method switches the thread to the
other coroutine, and pass the context of the original coroutine so the thread
can switch back.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="code"><pre><span class="k">use</span> <span class="nn">context</span><span class="p">::</span><span class="nn">stack</span><span class="p">::</span><span class="n">ProtectedFixedSizeStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">context</span><span class="p">::{</span><span class="n">Context</span><span class="p">,</span> <span class="n">Transfer</span><span class="p">};</span>

<span class="nd">#[derive(Debug)]</span>
<span class="k">enum</span> <span class="n">NestedList</span> <span class="p">{</span>
    <span class="nf">Leaf</span><span class="p">(</span><span class="nb">i32</span><span class="p">),</span>
    <span class="nf">Nested</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">NestedList</span><span class="o">&gt;</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">list</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">NestedList</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Transfer</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">match</span> <span class="n">list</span> <span class="p">{</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="c1">// Context-switching consumes the `Context` object.  We have to take and replace it.</span>
            <span class="k">let</span> <span class="n">old_t</span> <span class="o">=</span> <span class="n">t</span><span class="nf">.take</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
            <span class="k">let</span> <span class="n">new_t</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">old_t</span><span class="py">.context</span><span class="nf">.resume</span><span class="p">(</span><span class="o">*</span><span class="n">num</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">};</span>
            <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(</span><span class="n">new_t</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="n">lists</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="k">in</span> <span class="n">lists</span> <span class="p">{</span>
                <span class="c1">// This is stackful coroutine.  We can do recursive function call.</span>
                <span class="nf">traverse</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// [1, [[2, 3], [4, 5]], [6, 7, 8]]</span>
    <span class="k">let</span> <span class="n">nested_list</span> <span class="o">=</span> <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span><span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">3</span><span class="p">)]),</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span><span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">5</span><span class="p">)]),</span>
        <span class="p">]),</span>
        <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Nested</span><span class="p">(</span><span class="nd">vec!</span><span class="p">[</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
            <span class="nn">NestedList</span><span class="p">::</span><span class="nf">Leaf</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
        <span class="p">]),</span>
    <span class="p">]);</span>

    <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">context_function</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Transfer</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
        <span class="c1">// The initial Transfer carries the pointer to the list as `data`.</span>
        <span class="k">let</span> <span class="n">list</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span><span class="p">(</span><span class="n">t</span><span class="py">.data</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="n">NestedList</span><span class="p">)</span> <span class="p">};</span>

        <span class="c1">// From now on, we'll frequently take and replace the Transfer. Use Option.</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">t_holder</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
        <span class="nf">traverse</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">t_holder</span><span class="p">);</span>

        <span class="c1">// Send a special value to indicate the end of traversal.</span>
        <span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t_holder</span><span class="nf">.unwrap</span><span class="p">();</span>
        <span class="k">unsafe</span> <span class="p">{</span> <span class="n">t</span><span class="py">.context</span><span class="nf">.resume</span><span class="p">(</span><span class="nn">usize</span><span class="p">::</span><span class="n">MAX</span><span class="p">)</span> <span class="p">};</span>
        <span class="nd">unreachable!</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="n">stack</span> <span class="o">=</span> <span class="nn">ProtectedFixedSizeStack</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">Transfer</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="k">unsafe</span> <span class="p">{</span> <span class="nn">Context</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stack</span><span class="p">,</span> <span class="n">context_function</span><span class="p">)</span> <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// The initial `resume` sends the list reference as a usize.</span>
    <span class="n">t</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">t</span><span class="py">.context</span><span class="nf">.resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nested_list</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="n">NestedList</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">};</span>

    <span class="c1">// Use this special value to indicate end of traversal.</span>
    <span class="k">while</span> <span class="n">t</span><span class="py">.data</span> <span class="o">!=</span> <span class="nn">usize</span><span class="p">::</span><span class="n">MAX</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">t</span><span class="py">.data</span><span class="p">);</span>

        <span class="c1">// Subsequent `resume` doesn't need to carry values.</span>
        <span class="n">t</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">t</span><span class="py">.context</span><span class="nf">.resume</span><span class="p">(</span><span class="mi">0usize</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="c-iterators-stackless-asymmetric">C# iterators (stackless, asymmetric)</h2>

<p>C# can implement iterators using the <code class="language-plaintext highlighter-rouge">yield return</code> or <code class="language-plaintext highlighter-rouge">yield break</code> statements.
A function that contains <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/yield"><code class="language-plaintext highlighter-rouge">yield</code></a> returns an <code class="language-plaintext highlighter-rouge">Enumerable&lt;T&gt;</code> or
<code class="language-plaintext highlighter-rouge">Enumerator&lt;T&gt;</code> which is resumed every time an item is requested.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td><td class="code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">interface</span> <span class="nc">NestedList</span>
<span class="p">{</span>
    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">Traverse</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Leaf</span> <span class="p">:</span> <span class="n">NestedList</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">Leaf</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">num</span> <span class="p">=</span> <span class="n">num</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">Traverse</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="n">num</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Branch</span> <span class="p">:</span> <span class="n">NestedList</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">NestedList</span><span class="p">&gt;</span> <span class="n">children</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">Branch</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">children</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">NestedList</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Branch</span> <span class="nf">Add</span><span class="p">(</span><span class="n">NestedList</span> <span class="n">child</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">children</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">Traverse</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">child</span> <span class="k">in</span> <span class="n">children</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// It is stackless.  We need to yield from the inner iterators.</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">y</span> <span class="k">in</span> <span class="n">child</span><span class="p">.</span><span class="nf">Traverse</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">yield</span> <span class="k">return</span> <span class="n">y</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">IteratorTraversal</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// [1, [[2, 3], [4, 5]], [6, 7, 8]]</span>
        <span class="kt">var</span> <span class="n">nestedList</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Branch</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Branch</span><span class="p">()</span>
                    <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Branch</span><span class="p">()</span>
                        <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="m">2</span><span class="p">))</span>
                        <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="m">3</span><span class="p">)))</span>
                    <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Branch</span><span class="p">()</span>
                        <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="m">4</span><span class="p">))</span>
                        <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="m">5</span><span class="p">))))</span>
            <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Branch</span><span class="p">()</span>
                    <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="m">6</span><span class="p">))</span>
                    <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="m">7</span><span class="p">))</span>
                    <span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="m">8</span><span class="p">)));</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">n</span> <span class="k">in</span> <span class="n">nestedList</span><span class="p">.</span><span class="nf">Traverse</span><span class="p">())</span> <span class="c1">// Create the iterator</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="c-asyncawait-stackless-asymmetric-asynchronous">C# async/await (stackless, asymmetric, asynchronous)</h2>

<p>C# <a href="https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/">supports asynchronous programming</a> (see
<a href="#async-await">appendix</a>).  Like async/await in any other language, its
programming model is more like cooperative multi-task programming than
coroutines.  It is possible to implement asynchronous traversal using an
<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.threading.asyncqueue-1?view=visualstudiosdk-2022">AsyncQueue</a> to communicate between the traversal task and a
consumer task that consumes the visited values. I am not going to give an
example here.</p>

<h2 id="c-swapcontext-stackful-symmetric">C swapcontext (stackful, symmetric)</h2>

<p>The C programming language itself doesn’t have any support for coroutines or
<a href="#swap-stack">swap-stack</a>.</p>

<p>The POSIX function <a href="https://linux.die.net/man/3/makecontext"><code class="language-plaintext highlighter-rouge">makecontext</code></a> can create a “context” for a
function on a given stack so that when a subsequent invocation of
<a href="https://linux.die.net/man/3/swapcontext"><code class="language-plaintext highlighter-rouge">swapcontext</code></a> swaps to that context, it will continue
execution from the beginning of the given function on the given stack.  This
effectively provides a <a href="#swap-stack">swap-stack</a> mechanism, and can be used to implement
symmetric coroutines.</p>

<p>One design flaw of <code class="language-plaintext highlighter-rouge">makecontext</code> is that it only supports passing <code class="language-plaintext highlighter-rouge">int</code>
arguments to the given function.  Because the size of <code class="language-plaintext highlighter-rouge">int</code> is
platform-specific, it is hard to pass pointers across <code class="language-plaintext highlighter-rouge">makecontext</code>.  According
to the <a href="https://linux.die.net/man/3/makecontext">man page</a>, POSIX 2008 removed <code class="language-plaintext highlighter-rouge">makecontext</code> and
<code class="language-plaintext highlighter-rouge">swapcontext</code>, citing portability issues, and recommended the use of POSIX
threads.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ucontext.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">Node</span> <span class="o">*</span><span class="n">first_child</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">Node</span> <span class="o">*</span><span class="n">next_sibling</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// [1, [[2, 3], [4, 5]], [6, 7, 8]]</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node8</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">NULL</span>      <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node7</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node8</span>    <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node6</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node7</span>    <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node678</span>      <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node6</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">NULL</span>      <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node5</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">NULL</span>      <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node4</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node5</span>    <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node45</span>       <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node4</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">NULL</span>      <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node3</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">NULL</span>      <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node2</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node3</span>    <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node23</span>       <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node2</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node45</span>   <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node2345</span>     <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node23</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node678</span>  <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node1</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>    <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node2345</span> <span class="p">};</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="n">node12345678</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node1</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">NULL</span>      <span class="p">};</span>

<span class="n">ucontext_t</span> <span class="n">main_context</span><span class="p">;</span>
<span class="n">ucontext_t</span> <span class="n">coro_context</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">current_value</span><span class="p">;</span>
<span class="n">bool</span> <span class="n">finished</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">do_yield</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">swapcontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coro_context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">main_context</span><span class="p">);</span>  <span class="c1">// switch back to main</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">visit_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">Node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Node</span> <span class="o">*</span><span class="n">current</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span> <span class="n">current</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">next_sibling</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">first_child</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">do_yield</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">visit_node</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">first_child</span><span class="p">);</span>   <span class="c1">// recursive call</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">traverse</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">visit_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node12345678</span><span class="p">);</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">getcontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coro_context</span><span class="p">);</span>

    <span class="c1">// Obviously, it is stackful.</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">stack</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">65536</span><span class="p">);</span>    <span class="c1">// Not sure if 65536 is enough, though.</span>
                                    <span class="c1">// If we are careful enough, we should use mprotect</span>
                                    <span class="c1">// to create a PROT_NONE region to protect against</span>
                                    <span class="c1">// stack overflow.</span>
    <span class="n">coro_context</span><span class="p">.</span><span class="n">uc_stack</span> <span class="o">=</span> <span class="p">(</span><span class="n">stack_t</span><span class="p">){</span> <span class="p">.</span><span class="n">ss_sp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">,</span> <span class="p">.</span><span class="n">ss_size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="p">};</span>
    <span class="n">coro_context</span><span class="p">.</span><span class="n">uc_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">main_context</span><span class="p">;</span>
    <span class="n">makecontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coro_context</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">traverse</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">swapcontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">coro_context</span><span class="p">);</span>  <span class="c1">// switch to coroutine</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">current_value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="c-coroutine-stackless-asymmetric-asynchronous">C++ coroutine (stackless, asymmetric, asynchronous)</h2>

<p>C++20 introduced “coroutines”.  More precisely, it introduced mechanisms so that
libraries can implement <a href="#async-await">asynchronous programming</a> on top of them.</p>

<p>Any function that contains <code class="language-plaintext highlighter-rouge">co_await</code>, <code class="language-plaintext highlighter-rouge">co_yield</code> and/or <code class="language-plaintext highlighter-rouge">co_return</code> are
coroutine functions.</p>

<p>Calling a coroutine function behaves like the pseudo-code defined in
<a href="https://timsong-cpp.github.io/cppwp/n4861/dcl.fct.def.coroutine#5">Section 9.5.4 (dcl.fct.def.coroutine) paragraph 5</a>.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="n">promise</span><span class="o">-</span><span class="n">type</span> <span class="n">promise</span> <span class="n">promise</span><span class="o">-</span><span class="n">constructor</span><span class="o">-</span><span class="n">arguments</span> <span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">co_await</span> <span class="n">promise</span><span class="p">.</span><span class="n">initial_suspend</span><span class="p">()</span> <span class="p">;</span>
        <span class="n">function</span><span class="o">-</span><span class="n">body</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="p">...</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initial</span><span class="o">-</span><span class="n">await</span><span class="o">-</span><span class="n">resume</span><span class="o">-</span><span class="n">called</span><span class="p">)</span>
            <span class="k">throw</span> <span class="p">;</span>
        <span class="n">promise</span><span class="p">.</span><span class="n">unhandled_exception</span><span class="p">()</span> <span class="p">;</span>
    <span class="p">}</span>
<span class="k">final</span><span class="o">-</span><span class="n">suspend</span> <span class="o">:</span>
    <span class="k">co_await</span> <span class="n">promise</span><span class="p">.</span><span class="n">final_suspend</span><span class="p">()</span> <span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Basically, it implicitly creates a “promise object” which is called (awaited) at
different points of the coroutine execution, like “hooks” or aspect-oriented
programming.  The compiler will generate those <code class="language-plaintext highlighter-rouge">promise.xxxx()</code> method calls,
and it is the programmer’s (or library writer’s) responsibility to define the
“promise type” and the <code class="language-plaintext highlighter-rouge">.initial_suspend()</code>, <code class="language-plaintext highlighter-rouge">.unhandled_exception()</code>, and
<code class="language-plaintext highlighter-rouge">.final_suspend()</code> methods to make the generated calls meaningful.</p>

<p>And evaluation a <code class="language-plaintext highlighter-rouge">co_await</code> expression behaves as defined in <a href="https://timsong-cpp.github.io/cppwp/n4861/expr.await#5">Section 7.6.2.3
(expr.await) paragraph 5</a>.  It takes an “awaiter” (more
precisely, anything that can be converted to an “awaiter”) as operand, and</p>

<ul>
  <li>It calls <code class="language-plaintext highlighter-rouge">awaiter.await_ready()</code>.
    <ul>
      <li>If it returns true, it calls <code class="language-plaintext highlighter-rouge">awaiter.await_resume()</code>, and that’s the
value of the <code class="language-plaintext highlighter-rouge">co_await</code> expression.</li>
      <li>If it returns false, it calls <code class="language-plaintext highlighter-rouge">awaiter.await_suspend()</code>, and depending
on its result, it may suspend the execution of the coroutine, or suspend
and switch to another coroutine, or just continue execution.</li>
    </ul>
  </li>
</ul>

<p>It’s the “conditionally yielding” behaviour of common <a href="#async-await">async/await</a>-based
programming.  Again the compiler generates the above method calls, and it is
again the programmer’s (or library writer’s) responsibility to implement the
<code class="language-plaintext highlighter-rouge">.await_ready()</code>, <code class="language-plaintext highlighter-rouge">.await_resume()</code> and <code class="language-plaintext highlighter-rouge">.await_suspend()</code> methods to make those
generated calls meaningful.</p>

<p>The <a href="https://timsong-cpp.github.io/cppwp/n4861/expr.yield"><code class="language-plaintext highlighter-rouge">co_yield</code></a> expression calls <code class="language-plaintext highlighter-rouge">promise.yield_value(x)</code>,
and programmer (or library writer) shall implement the promise object to make
<code class="language-plaintext highlighter-rouge">.yield_value</code> method meaningful.</p>

<p>And the <a href="https://timsong-cpp.github.io/cppwp/n4861/stmt.return.coroutine"><code class="language-plaintext highlighter-rouge">co_return</code></a> statement calls
<code class="language-plaintext highlighter-rouge">promise.return_void()</code>, and the programmer (or library writer) shall implement
the promise object to make <code class="language-plaintext highlighter-rouge">.return_void</code> method meaningful.</p>

<p>And the standard library function <code class="language-plaintext highlighter-rouge">coroutine_handle::resume()</code> resumes a paused
“coroutine”.</p>

<p>As we can see</p>

<ul>
  <li>the specification defines the semantics of coroutine functions, the
<code class="language-plaintext highlighter-rouge">co_await</code>, <code class="language-plaintext highlighter-rouge">co_yield</code> and <code class="language-plaintext highlighter-rouge">co_return</code> expressions/statements, and the
<code class="language-plaintext highlighter-rouge">coroutine_handle</code> library object and its <code class="language-plaintext highlighter-rouge">.resume()</code> method, and</li>
  <li>the compiler (GCC, Clang, etc.) generate code for the <code class="language-plaintext highlighter-rouge">co_xxx</code>
expression/statements, and</li>
  <li>the programmer defines the promise type and (optionally) “awaiter” types and
fills in lots and lots of methods to customise the behaviour.</li>
</ul>

<p>How complicated C++20 “coroutines” are!</p>

<p>It is complicated enough to <a href="https://www.scs.stanford.edu/~dm/blog/c++-coroutines.html">confuse a C++ programmer with 25-years’
experience</a>.</p>

<p>And I admit I am not smart enough to use C++20 coroutines.</p>

<p>If you are not smart enough, either, but want to learn about C++20 coroutines, I
recommend starting with another language, such as Ruby or Lua, and come back to
C++20 when the idea of coroutines don’t scare you.</p>

<p>Anyway, here is the code.  The following code tries to use C++20 coroutines as
generators.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre></td><td class="code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;coroutine&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="nc">Node</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">first_child</span><span class="p">;</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">next_sibling</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// [1, [[2, 3], [4, 5]], [6, 7, 8]]</span>
<span class="n">Node</span> <span class="n">node8</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node7</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node8</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node6</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node7</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node678</span>      <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node6</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node5</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node4</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node5</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node45</span>       <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node4</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node3</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node2</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node3</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node23</span>       <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node2</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node45</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node2345</span>     <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node23</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node678</span>  <span class="p">};</span>
<span class="n">Node</span> <span class="n">node1</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node2345</span> <span class="p">};</span>
<span class="n">Node</span> <span class="n">node12345678</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node1</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>

<span class="k">struct</span> <span class="nc">Traverser</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="nc">promise_type</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">handle_type</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">coroutine_handle</span><span class="o">&lt;</span><span class="n">promise_type</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="k">struct</span> <span class="nc">promise_type</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">current_value_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">finished_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

        <span class="c1">// This is executed when the "coroutine" is created.</span>
        <span class="n">Traverser</span> <span class="n">get_return_object</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">Traverser</span><span class="p">(</span><span class="n">handle_type</span><span class="o">::</span><span class="n">from_promise</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="c1">// Called at the beginning of the coroutine.</span>
        <span class="c1">// We let it stop there to mimic Python generator behaviour.</span>
        <span class="n">std</span><span class="o">::</span><span class="n">suspend_always</span> <span class="nf">initial_suspend</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{};</span>
        <span class="p">}</span>

        <span class="c1">// Called when the coroutine finished execution.</span>
        <span class="n">std</span><span class="o">::</span><span class="n">suspend_always</span> <span class="n">final_suspend</span><span class="p">()</span> <span class="k">noexcept</span> <span class="p">{</span>
            <span class="c1">// We set a variable so the main function knows it finished.</span>
            <span class="n">finished_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">{};</span>
        <span class="p">}</span>

        <span class="c1">// Called when a co_yield expression is evaluated.</span>
        <span class="n">std</span><span class="o">::</span><span class="n">suspend_always</span> <span class="nf">yield_value</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">current_value_</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">{};</span>
        <span class="p">}</span>

        <span class="c1">// Called when an exception is thrown.</span>
        <span class="kt">void</span> <span class="nf">unhandled_exception</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">terminate</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">handle_type</span> <span class="n">handle_</span><span class="p">;</span>

    <span class="n">Traverser</span><span class="p">(</span><span class="n">handle_type</span> <span class="n">handle</span><span class="p">)</span> <span class="o">:</span> <span class="n">handle_</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="p">{}</span>

    <span class="kt">void</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">handle_</span><span class="p">.</span><span class="n">resume</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="n">finished</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handle_</span><span class="p">.</span><span class="n">promise</span><span class="p">().</span><span class="n">finished_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="nf">get_value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handle_</span><span class="p">.</span><span class="n">promise</span><span class="p">().</span><span class="n">current_value_</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">Traverser</span> <span class="nf">visit_node</span><span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="n">current</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span> <span class="n">current</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">next_sibling</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">first_child</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Yield.</span>
            <span class="k">co_yield</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// It is stackless.  We need multiple levels of coroutines.</span>
            <span class="k">auto</span> <span class="n">sub_traverser</span> <span class="o">=</span> <span class="n">visit_node</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">first_child</span><span class="p">);</span>
            <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sub_traverser</span><span class="p">.</span><span class="n">resume</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sub_traverser</span><span class="p">.</span><span class="n">finished</span><span class="p">())</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// Yield from sub-coroutine.</span>
                <span class="k">co_yield</span> <span class="n">sub_traverser</span><span class="p">.</span><span class="n">get_value</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">traverser</span> <span class="o">=</span> <span class="n">visit_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node12345678</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">traverser</span><span class="p">.</span><span class="n">resume</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">traverser</span><span class="p">.</span><span class="n">finished</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">traverser</span><span class="p">.</span><span class="n">get_value</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="c-boostcoroutine2-stackful-asymmetric">C++ Boost.Coroutine2 (stackful, asymmetric)</h2>

<p>Note: Boost.Coroutine is deprecated in favour for Boost.Coroutine2.</p>

<p><a href="https://www.boost.org/doc/libs/1_80_0/libs/coroutine2/doc/html/index.html">Boost.Coroutine2</a> provides stackful asymmetric coroutines.  It is implemented
on top of <a href="https://www.boost.org/doc/libs/1_80_0/libs/context/doc/html/index.html">Boost.Context</a> (see below).</p>

<p>A <code class="language-plaintext highlighter-rouge">boost::coroutines2::coroutine&lt;T&gt;</code> has two members: <code class="language-plaintext highlighter-rouge">pull_type</code> and
<code class="language-plaintext highlighter-rouge">push_type</code>.  A coroutine can be created by instantiating either of them.  In
this task, we will create a <code class="language-plaintext highlighter-rouge">pull_type</code> so that the main function can pull data
from the coroutine.  It will create a coroutine which receives a <code class="language-plaintext highlighter-rouge">&amp;push_type</code> so
that it can yield and push data back to the main function.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;boost/coroutine2/coroutine.hpp&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="nc">Node</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">first_child</span><span class="p">;</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">next_sibling</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// [1, [[2, 3], [4, 5]], [6, 7, 8]]</span>
<span class="n">Node</span> <span class="n">node8</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node7</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node8</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node6</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node7</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node678</span>      <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node6</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node5</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node4</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node5</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node45</span>       <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node4</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node3</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node2</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node3</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node23</span>       <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node2</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node45</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node2345</span>     <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node23</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node678</span>  <span class="p">};</span>
<span class="n">Node</span> <span class="n">node1</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node2345</span> <span class="p">};</span>
<span class="n">Node</span> <span class="n">node12345678</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node1</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>

<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">coroutines2</span><span class="o">::</span><span class="n">coroutine</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">coro_t</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">visit_node</span><span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="n">coro_t</span><span class="o">::</span><span class="n">push_type</span> <span class="o">&amp;</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="n">current</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span> <span class="n">current</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">next_sibling</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">first_child</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sink</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>   <span class="c1">// Yield at any level.  It's stackful!</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">visit_node</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">first_child</span><span class="p">,</span> <span class="n">sink</span><span class="p">);</span>   <span class="c1">// Recursive call.</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">traverser</span> <span class="o">=</span> <span class="n">coro_t</span><span class="o">::</span><span class="n">pull_type</span><span class="p">([](</span><span class="n">coro_t</span><span class="o">::</span><span class="n">push_type</span> <span class="o">&amp;</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">visit_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node12345678</span><span class="p">,</span> <span class="n">sink</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">value</span> <span class="o">:</span> <span class="n">traverser</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Can be used as iterator using begin() and end().</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="c-boostcontext-stackful-symmetric">C++ Boost.Context (stackful, symmetric)</h2>

<p><a href="https://www.boost.org/doc/libs/1_80_0/libs/context/doc/html/index.html">Boost.Context</a> implements a <a href="#swap-stack">swap-stack</a> mechanism using machine-dependent
assembly language(<a href="https://github.com/boostorg/context/blob/develop/src/asm/jump_x86_64_sysv_elf_gas.S">x86-64</a>, <a href="https://github.com/boostorg/context/blob/develop/src/asm/jump_arm64_aapcs_elf_gas.S">ARM64</a>,
<a href="https://github.com/boostorg/context/blob/develop/src/asm/jump_riscv64_sysv_elf_gas.S">RISCV64</a>, etc.).  We can also implement symmetric coroutines
using its C++ API.  A <code class="language-plaintext highlighter-rouge">boost::coroutine::fiber</code> represents a coroutine, and
<code class="language-plaintext highlighter-rouge">fiber::resume()</code> switches to that coroutine.  Because <code class="language-plaintext highlighter-rouge">fiber::resume()</code> doesn’t
pass values, we need to use a side channel (the shared <code class="language-plaintext highlighter-rouge">State</code> object) to pass
the value and indicate that the traversal has finished.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;boost/coroutine2/coroutine.hpp&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="nc">Node</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">first_child</span><span class="p">;</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">next_sibling</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// [1, [[2, 3], [4, 5]], [6, 7, 8]]</span>
<span class="n">Node</span> <span class="n">node8</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node7</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node8</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node6</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node7</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node678</span>      <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node6</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node5</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node4</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node5</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node45</span>       <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node4</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node3</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node2</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node3</span>    <span class="p">};</span>
<span class="n">Node</span> <span class="n">node23</span>       <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node2</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node45</span>   <span class="p">};</span>
<span class="n">Node</span> <span class="n">node2345</span>     <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node23</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node678</span>  <span class="p">};</span>
<span class="n">Node</span> <span class="n">node1</span>        <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node2345</span> <span class="p">};</span>
<span class="n">Node</span> <span class="n">node12345678</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">first_child</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node1</span><span class="p">,</span>  <span class="p">.</span><span class="n">next_sibling</span> <span class="o">=</span> <span class="nb">nullptr</span>   <span class="p">};</span>

<span class="k">struct</span> <span class="nc">State</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">current_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">finished</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">visit_node</span><span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="n">State</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">context</span><span class="o">::</span><span class="n">fiber</span> <span class="o">&amp;</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="n">current</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span> <span class="n">current</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">next_sibling</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">first_child</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">state</span><span class="p">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
            <span class="n">sink</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">sink</span><span class="p">).</span><span class="n">resume</span><span class="p">();</span>   <span class="c1">// Yield at any level.  It's stackful!</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">visit_node</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">first_child</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">sink</span><span class="p">);</span>   <span class="c1">// Recursive call.</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">State</span> <span class="n">state</span><span class="p">;</span>

    <span class="k">auto</span> <span class="n">traverser</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">context</span><span class="o">::</span><span class="n">fiber</span><span class="p">([</span><span class="o">&amp;</span><span class="n">state</span><span class="p">](</span><span class="n">boost</span><span class="o">::</span><span class="n">context</span><span class="o">::</span><span class="n">fiber</span> <span class="o">&amp;&amp;</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">visit_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node12345678</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">sink</span><span class="p">);</span>
        <span class="n">state</span><span class="p">.</span><span class="n">finished</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">traverser</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">traverser</span><span class="p">).</span><span class="n">resume</span><span class="p">();</span>  <span class="c1">// Resume the coroutine.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">state</span><span class="p">.</span><span class="n">current_value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h1 id="appendices">Appendices</h1>

<h2 id="why-this-task">Why this task?</h2>

<p>The purpose of this task is to compare <em>symmetric</em>, <em>asymmetric</em>, <em>stackful</em> and
<em>stackless</em> coroutines.</p>

<p>This task is natural to implement with coroutines, because the traversal of a
data structure is relatively independent from the consumption of the values.</p>

<p>This task is also much easier with stackful coroutines than stackless
coroutines.  Because the data structure (nested lists) is recursive, it is
easier to traverse it using a recursive algorithm, and recursion needs a stack.
Stackful coroutines can handle recursive calls quite trivially. But when using
stackless coroutines, we have to do some hack and chain up multiple coroutines
to form a stack of coroutines, and yield values from the innermost coroutine
through multiple layers of coroutines to the consumer.</p>

<p>From the code examples above, we can clearly see the difference between
different kinds of coroutines.</p>

<h2 id="what-are-coroutines-anyway">What are coroutines anyway?</h2>

<p>According to <a href="https://dl.acm.org/doi/10.1145/366663.366704">Conway</a>, a <strong>coroutine</strong> is “<em>an autonomous program
which communicates with adjacent modules as if they were input or output
subroutines</em>”.  Coroutines are subroutines all at the same level, each acting as
if it were the master program when in fact there is no master program.</p>

<p>Coroutines has the following characteristics. (See <a href="http://www.lua.org/doc/jucs04.pdf"><em>Coroutines in
Lua</em></a>)</p>

<ol>
  <li>The values of data local to a coroutine persist between successive calls.</li>
  <li>The execution of a coroutine is suspended as control leaves it, only to
carry on where it left off when control re-enters the coroutine at some
later stage.</li>
</ol>

<p>The first characteristic means coroutines can be resumed from where it paused.</p>

<p>In the second characteristic, “as control leaves it” means it is the programmer
that decides <em>where</em> to pause a coroutine, not the implicit scheduler.  Control
flow is part of a program, not the runtime.</p>

<p>For this reason, the “fibers” in Ruby, the “generators” in Python, the
“threads” in Lua, and the “user contexts” in the <code class="language-plaintext highlighter-rouge">swapcontext</code> POSIX API are all
coroutines, despite not being called “coroutines”.  The programmer explicitly
transfers control from one to another.</p>

<p>On the other hand, a “goroutine” in the Go programming language is not a
coroutine, despite the similar name.  In fact, <a href="https://golang.google.cn/ref/spec#Go_statements">the official document</a>
defines a “goroutine” as “an independent concurrent thread of control”, i.e. a
thread.</p>

<p><small>Note: Goroutine is a threading mechanism implemented in the user space,
an “M × N” green thread system. The Go runtime schedules M goroutines on N native
threads. It is the scheduler that switches a native thread between different
goroutines at unspecified time and locations, usually when IO operations may
block, or when queues are full or empty.  To the programmer, a goroutine is just
like a thread: it keeps going forward.  It may block, but not because the
programmer asked it to yield, but because some requests cannot be satisfied,
such as queues and IO. </small></p>

<p>Coroutines are not mutually exclusive with threads.  Each thread is executing
one coroutine at a time, and each thread may jump from one coroutine to another
according to the control flow in the program.</p>

<h2 id="symmetric-and-asymmetric-coroutines">Symmetric and asymmetric coroutines.</h2>

<p>With <em>symmetric</em> coroutines, all coroutines are equal.  A thread can jump from
any coroutine to any other coroutine.  When switching, the programmer always
needs to specify which coroutine to jump to, i.e. destination.</p>

<p>With <em>asymmetric</em> coroutines, coroutines have a parent-child relation.  There
are two different operations that jumps between coroutines, namely <code class="language-plaintext highlighter-rouge">resume</code> and
<code class="language-plaintext highlighter-rouge">yield</code>.  When a thread “resumes” a coroutine, the destination becomes the child
of the source coroutine, until it “yields”, when the thread jumps back from the
child to the parent coroutine.  A coroutine cannot be resumed when it already
has a parent.  When yielding, the programmer doesn’t need to specify the
destination, because the destination is always implicitly the parent coroutine.</p>

<p>Symmetric and asymmetric coroutines have equal expressive power, and they can
implement each other.  See <a href="http://www.lua.org/doc/jucs04.pdf">Coroutines in Lua</a> for more details.</p>

<h2 id="stackful-and-stackless-coroutines">Stackful and stackless coroutines.</h2>

<p>A <em>stackful</em> coroutine has its own execution stack.  A thread can switch
coroutine when the current coroutine has any number of frames on its stack. When
switching, the thread saves the entire stack and switches to a whole new stack
(implementation-wise, it only needs to save registers, change the stack pointer,
and restore registers from the new stack).</p>

<p>A <em>stackless</em> coroutine has only one frame.  Therefore, a coroutine is usually
defined by a “coroutine function”. From my knowledge, all stackless coroutines
are asymmetric.  A coroutine function can only yield within the coroutine
function itself.  That means when a coroutine C1 calls another function F2, the
thread cannot yield from C1 while executing F2;  when a coroutine C1 resumes
another coroutine C2, the thread can only yield from C2 back to C1, but not
directly from C2 to C1’s parent.</p>

<p>Stackful coroutines are more powerful, but need some kind of “swap-stack”
mechanism (see below) to implement.  Stackless coroutines are more restricted,
but does not require swap-stack.</p>

<h2 id="swap-stack">The swap-stack mechanism</h2>

<p>Conceptually, the context of nested function calls is a stack, a
last-in-first-out data structure, called the <em>control stack</em>, often simply
called a <em>stack</em>.</p>

<p>A control stack has many <em>frames</em>.  Each frame contains the execution context of
a function activation, (and this is why a frame is also known as an <em>activation
record</em>).  The context includes the program counter (PC) as well as the values
of local variables.  The top frame is the context of the most recently entered
function, and is the only frame on a stack that is active.  All other frames are
paused at a call site, waiting for the called function (the frame above it) to
return.</p>

<p>In most programming languages, a thread is always bound to one stack. But more
generally, a thread can switch among different stacks.  When a thread switches
from one stack to another, it pauses the top frame as well making the whole
stack paused.  Then it switches its stack pointer to the new stack, and resume
the top frame of the new stack, therefore continue from where that frame was
paused.</p>

<p>This is basically what <em>stackful coroutine</em> does.  Each coroutine has a stack,
which can be paused and resumed.  When resumed, it continues from where it was
paused.</p>

<h3 id="implementing-swap-stack-with-compiler">Implementing swap-stack with compiler</h3>

<p>Implementation-wise, if the language is compiled, it needs a special instruction
sequence that does the following things:</p>

<ol>
  <li>Save live registers on the top of the current stack, and</li>
  <li>set the stack pointer (SP) register to the destination stack, and</li>
  <li>restore the saved registers from the top of the destination stack.</li>
</ol>

<p>The C and C++ programming languages themselves do not have support for
swap-stack.  In practice, we usually rely on libraries or compiler extensions to
do that in C or C++.</p>

<p>Here I give two examples of implementations of swap-stack for compiled code.</p>

<ol>
  <li>
    <p>One is from <a href="https://www.boost.org/doc/libs/1_80_0/libs/context/doc/html/index.html">Boost.Context</a>.  It is implemented as a library in the assembly
language, therefore it has to be platform-specific. Here are the code for
<a href="https://github.com/boostorg/context/blob/develop/src/asm/jump_x86_64_sysv_elf_gas.S">x86-64</a>, <a href="https://github.com/boostorg/context/blob/develop/src/asm/jump_arm64_aapcs_elf_gas.S">ARM64</a> and
<a href="https://github.com/boostorg/context/blob/develop/src/asm/jump_riscv64_sysv_elf_gas.S">RISCV64</a>.  Because it is implemented as a library, it can
only depend on the application binary interface (ABI) of the platform.  In
this case, the assembly code has to conservatively save all callee-saved
registers no matter whether they are still in use or not, because as a
library, it does not have the liveness information the compiler has.</p>
  </li>
  <li>
    <p>The other is an LLVM extension created by <a href="http://dx.doi.org/10.1145/2400682.2400695">Dolan et al.</a>.  As part of
a compiler framework, it can identify and save only live registers, making
it much more efficient than library-based approaches.</p>
  </li>
</ol>

<h3 id="implementing-swap-stack-with-interpreter">Implementing swap-stack with interpreter</h3>

<p>If the language is interpreted, it depends.  An interpreter can be stackful or
stackless, and even stackless interpreters can allow the interpreted functions
to call foreign C functions.</p>

<p>A stackful interpreter uses the native (C) stack to implement function
invocation.  Such interpreters usually has the following form:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">interpret_function</span><span class="p">(</span><span class="n">Frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">current_instruction</span><span class="p">().</span><span class="n">type</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">...:</span>
            <span class="p">...</span>
        <span class="k">case</span> <span class="n">CALL</span><span class="p">:</span>
            <span class="p">...</span>
            <span class="n">Frame</span> <span class="o">*</span><span class="n">new_frame</span> <span class="o">=</span> <span class="n">create_frame</span><span class="p">(</span><span class="n">called_function</span><span class="p">);</span>
            <span class="n">interpret_function</span><span class="p">(</span><span class="n">new_frame</span><span class="p">);</span>  <span class="c1">// Recursive call</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Because a language-level function call corresponds to an interpreter-level
(C-level) function call, each frame in the interpreted language corresponds to a
C frame.  It is difficult to implement swap-stack with stackful interpreter
because it needs to swap out the C stack (which has C frames) in order to swap
out the interpreted language stack.  As we have discussed before, C does not
have native support for swap-stack, and it needs libraries written in assembly
language or compiler extensions to do so.</p>

<p><a id="apdx-sisc"></a></p>

<p>What about stackless interpreters?</p>

<p>A stackless interpreter does not turn language-level function calls into C-level
function calls.  A stackless interpreter usually has the following form:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">interpret_function</span><span class="p">(</span><span class="n">Frame</span> <span class="o">*</span><span class="n">initial_frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Frame</span> <span class="o">*</span><span class="n">current_frame</span> <span class="o">=</span> <span class="n">initial_frame</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">current_instruction</span><span class="p">().</span><span class="n">type</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">...:</span>
            <span class="p">...</span>
        <span class="k">case</span> <span class="n">CALL</span><span class="p">:</span>
            <span class="p">...</span>
            <span class="n">Frame</span> <span class="o">*</span><span class="n">new_frame</span> <span class="o">=</span> <span class="n">create_frame</span><span class="p">(</span><span class="n">called_function</span><span class="p">);</span>
            <span class="n">new_frame</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">current_frame</span><span class="p">;</span>
            <span class="n">current_frame</span> <span class="o">=</span> <span class="n">new_frame</span><span class="p">;</span>  <span class="c1">// Only replace the frame pointer</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>A stackless interpreter always remains in the single <code class="language-plaintext highlighter-rouge">interpret_function</code>
function activation even when the interpreted language program makes a call.
Swap-stack is relatively easier to implement with stackless interpreter,
because it does not need to swap out any C frames…</p>

<p>… unless it allows foreign function calls.  If the stackless interpreter
allows the interpreted language to call foreign C functions, then C functions
must have frames on some stack.  Then we face the same problem as implementing
swap-stack for compiled languages.</p>

<h3 id="the-mu-micro-virtual-machine">The Mu micro virtual machine</h3>

<p>I designed the <a href="https://microvm.github.io/">Mu micro virtual machine</a>, and it is the main part of <a href="https://wks.github.io/downloads/pdf/wang-thesis-2018.pdf">my
PhD thesis</a>.  Swap-stack is a very important mechanism of the Mu
micro VM, and it is designed to be supported by the JIT compiler.  It enables
the implementation of symmetric stackful coroutines, and it is the foundation of
other VM mechanisms, such as trapping and <a href="https://wks.github.io/downloads/pdf/osr-vee-2018.pdf">on-stack replacement
(OSR)</a>.  If you are interested, read
<a href="https://wks.github.io/downloads/pdf/wang-thesis-2018.pdf#subsection.5.3.6">Section 5.3.6</a> of <a href="https://wks.github.io/downloads/pdf/wang-thesis-2018.pdf">my thesis</a>.</p>

<h2 id="function-to-state-machine">Decomposing a function into a state machine</h2>

<p>Interpreters usually have no problem saving the frame of a function at a <code class="language-plaintext highlighter-rouge">yield</code>
point so that it can be resumed later.  The interpreter can implement the layout
of stack frames and the behaviour of function calls / coroutine resumption in
any way it wants.  They may even allocate frames in the heap so that they can
temporarily remove a frame from the stack and put it back later. For compilers,
if swap-stack is available, one thread can just save the register states on one
stack and restore them from another stack. Without swap-stack, however, it may
be a challenge.</p>

<p>One way to implement pause-able and resume-able functions is decomposing a
function into a state machine.  Each <code class="language-plaintext highlighter-rouge">yield</code> point becomes a state, and a
function starts by matching the state and jumping to the right place.</p>

<p>For example, assume the <code class="language-plaintext highlighter-rouge">yield()</code> call represents a coroutine yield in the
following C pseudo-code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Long</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">yield</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"time</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">yield</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"no</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">yield</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"see</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Such a function can be transformed into a function that takes a state when
called, and returns a new state when yielding or returning.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">State</span> <span class="p">{</span>
    <span class="n">START</span><span class="p">,</span> <span class="n">STATE1</span><span class="p">,</span> <span class="n">STATE2</span><span class="p">,</span> <span class="n">STATE3</span><span class="p">,</span> <span class="n">END</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">State</span> <span class="nf">foo</span><span class="p">(</span><span class="k">enum</span> <span class="n">State</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">START</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Long</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">STATE1</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">STATE1</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"time</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">STATE2</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">STATE2</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"no</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">STATE3</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">STATE3</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"see</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">END</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="n">State</span> <span class="n">state</span> <span class="o">=</span> <span class="n">START</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">END</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Resuming foo()...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"foo() paused</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>What about local variables?  Local variables can be packed into the states, too.
C programmers may use the <code class="language-plaintext highlighter-rouge">union</code> type, but it is easier with tagged unions or
object-oriented programming.</p>

<p>Suppose we have a (pseudo) Rust function where <code class="language-plaintext highlighter-rouge">yield!()</code> represents a coroutine
yield.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">square_sum</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"a * a = {}"</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
    <span class="k">yield</span><span class="o">!</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"b * b = {}"</span><span class="p">,</span> <span class="n">b2</span><span class="p">);</span>
    <span class="k">yield</span><span class="o">!</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">+</span> <span class="n">b2</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"result = {}"</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can use an <code class="language-plaintext highlighter-rouge">enum</code> to hold <em>live</em> (will be used later) local variables at each
<code class="language-plaintext highlighter-rouge">yield!()</code> point.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="code"><pre><span class="cd">/// Note: each state holds the live local variables.</span>
<span class="k">enum</span> <span class="n">State</span> <span class="p">{</span>
    <span class="n">Start</span> <span class="p">{</span> <span class="n">a</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">i32</span> <span class="p">},</span>
    <span class="n">State1</span> <span class="p">{</span> <span class="n">b</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span> <span class="n">a2</span><span class="p">:</span> <span class="nb">i32</span> <span class="p">},</span>  <span class="c1">// Note: a is no longer useful.</span>
    <span class="n">State2</span> <span class="p">{</span> <span class="n">a2</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span> <span class="n">b2</span><span class="p">:</span> <span class="nb">i32</span> <span class="p">},</span> <span class="c1">// Note: neither a nor b are useful now.</span>
    <span class="n">End</span> <span class="p">{</span> <span class="n">result</span><span class="p">:</span> <span class="nb">i32</span> <span class="p">},</span>
<span class="p">}</span>

<span class="cd">/// Calling this function merely gets the initial state.</span>
<span class="cd">/// It doesn't actually execute the body of the original function.</span>
<span class="k">fn</span> <span class="nf">square_sum</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">State</span> <span class="p">{</span>
    <span class="nn">State</span><span class="p">::</span><span class="n">Start</span> <span class="p">{</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">}</span>
<span class="p">}</span>

<span class="cd">/// Call this for each step.</span>
<span class="k">fn</span> <span class="nf">square_sum_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">State</span> <span class="p">{</span>
    <span class="k">match</span> <span class="n">state</span> <span class="p">{</span>
        <span class="nn">State</span><span class="p">::</span><span class="n">Start</span> <span class="p">{</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="c1">// Restore local variables from the state.</span>
            <span class="k">let</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="p">;</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"a * a = {}"</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
            <span class="nn">State</span><span class="p">::</span><span class="n">State1</span> <span class="p">{</span> <span class="n">b</span><span class="p">,</span> <span class="n">a2</span> <span class="p">}</span> <span class="c1">// Save useful local variables into state.</span>
        <span class="p">}</span>

        <span class="nn">State</span><span class="p">::</span><span class="n">State1</span> <span class="p">{</span> <span class="n">b</span><span class="p">,</span> <span class="n">a2</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="c1">// restore</span>
            <span class="k">let</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"b * b = {}"</span><span class="p">,</span> <span class="n">b2</span><span class="p">);</span>
            <span class="nn">State</span><span class="p">::</span><span class="n">State2</span> <span class="p">{</span> <span class="n">a2</span><span class="p">,</span> <span class="n">b2</span> <span class="p">}</span> <span class="c1">// save</span>
        <span class="p">}</span>

        <span class="nn">State</span><span class="p">::</span><span class="n">State2</span> <span class="p">{</span> <span class="n">a2</span><span class="p">,</span> <span class="n">b2</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="c1">// restore</span>
            <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">+</span> <span class="n">b2</span><span class="p">;</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"result = {}"</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
            <span class="nn">State</span><span class="p">::</span><span class="n">End</span> <span class="p">{</span> <span class="n">result</span> <span class="p">}</span> <span class="c1">// save</span>
        <span class="p">}</span>

        <span class="nn">State</span><span class="p">::</span><span class="n">End</span> <span class="p">{</span> <span class="o">..</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="nd">panic!</span><span class="p">(</span><span class="s">"Coroutine already finished!"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">state</span> <span class="o">=</span> <span class="nf">square_sum</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="k">loop</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">state</span> <span class="p">{</span>
            <span class="nn">State</span><span class="p">::</span><span class="n">End</span> <span class="p">{</span> <span class="n">result</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"Execution finished. Result is {}"</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">_</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"Resuming..."</span><span class="p">);</span>
                <span class="n">state</span> <span class="o">=</span> <span class="nf">square_sum_step</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"Yielded."</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="async-await">Asynchronous programming (async/await) and coroutines</h2>

<p>In asynchronous programming, a program consists of many tasks that can be
completed in the future, and one task can wait for other tasks to complete
before continuing.  There are many ways to implement asynchronous programming.
It can be trivially executed inline (e.g. the X10 compiler is <a href="https://x10.sourceforge.net/documentation/intro/latest/html/node4.html#SECTION00410000000000000000">allowed to
inline</a> an async activity), executed sequentially, using threads, or
using coroutines.</p>

<p>The notion of “Future” and its friend “Promise” are well-known in multi-thread
programming (<a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/Future.html">C++</a>, <a href="https://en.cppreference.com/w/cpp/thread/future">Java</a>, <a href="https://learn.microsoft.com/en-us/cpp/standard-library/future-class">C#</a> and
<a href="https://docs.python.org/3/library/concurrent.futures.html#future-objects">Python</a>).  A pair of Future and Promise represents a value yet
to be produced.  The Future waits for the value to be produced, and the Promise
is a place to store the value to be acquired via the Future.  C++ even has the
<a href="https://en.cppreference.com/w/cpp/thread/async"><code class="language-plaintext highlighter-rouge">std::async</code></a> function in the standard library to launch an
asynchronous task in a new thread.</p>

<p>Recently many programming languages employed a style of asynchronous programming
language based on coroutines in the form of async/await.  I guess the reason
behind its gaining popularity is two fold:</p>

<ol>
  <li>
    <p>Native, OS-provided threads are too heavy-weight, but not many programming
languages support light-weight “M × N” green threads, that is, M OS threads
are multiplexed to run N application-level threads and N ≫ M.  AFAIK, only
Erlang and Go supports such light-weight threads.</p>
  </li>
  <li>
    <p>Not many languages support stackful coroutines.  As we discussed before,
stackful coroutines are only practical with swap-stack. Some languages (such
as Kotlin) are targeted to runtimes (such as JVM) that don’t support
swap-stack.</p>
  </li>
</ol>

<p>As a compromise, some languages resorted to coroutines.  They attempted to
implement cooperative multi-tasking using coroutines that yield when they are
about to block, and a scheduler that decides which coroutine can continue
without blocking.  And there is async/await.</p>

<p>A function can be annotated with the <code class="language-plaintext highlighter-rouge">async</code> keyword.  An async function is
like a Python generator.  When called, it doesn’t execute the body of the
function immediately, but will create an object that holds the execution context
of the function, like a frame.  An async function may contain <code class="language-plaintext highlighter-rouge">await</code>
expressions.  An <code class="language-plaintext highlighter-rouge">await</code> is like a conditional <code class="language-plaintext highlighter-rouge">yield</code>.  If a given <code class="language-plaintext highlighter-rouge">Future</code> is
ready, then grab the value and continue; otherwise, suspend the execution and
give control to the scheduler so that it can find something else to execute.</p>

<p>Async and await gives the programmer the feeling of multi-thread programming
except that the programmer must explicitly annotate places that may
<em>potentially</em> yield with <code class="language-plaintext highlighter-rouge">await</code>.</p>

<p>You can find an async/await example in JavaScript earlier in this post.  It
looks pretty like two threads communicating with each other using a channel.</p>

<h3 id="consequence-of-being-stackless">Consequence of being stackless</h3>

<p>Without proper swap-stack support, the compiler has to implement coroutines by
decomposing <code class="language-plaintext highlighter-rouge">async</code> functions into state machines.  <code class="language-plaintext highlighter-rouge">await</code> expressions are
places the function may yield, and each <code class="language-plaintext highlighter-rouge">await</code> represents a state in the state
machine.</p>

<p>However, async/await is not the only way to implement cooperative multi-task
programming on top of coroutines.  <a href="http://www.gevent.org/index.html">gevent</a> is a Python framework based on
<a href="https://greenlet.readthedocs.io/en/latest/index.html">Greenlets</a> which implement symmetric coroutines.  With the ability to
switch coroutine at any level of stack, each coroutine can yield to the
scheduler as part of potentially blocking functions (such as sleeping, IO
operations, etc.), and programmers do not need to annotate any expression with
<code class="language-plaintext highlighter-rouge">await</code>.</p>]]></content><author><name>Kunshan Wang</name></author><category term="blog" /><category term="coroutine" /><category term="rosettacode" /><summary type="html"><![CDATA[I’ll try to use coroutines to traverse nested lists, Rosetta Code style. That means I’ll do it in many different programming languages and libraries, including Ruby, Lua, Python (including greenlets), JavaScript, Rust, C#, etc. This task shows the difference between symmetric vs asymmetric coroutines, and stackful vs stackless coroutines. Note that this post alone may not be enough to teach you how to use coroutines in all those languages. I’ll also provide basic information about coroutines, swap-stack, async/await, etc. in the appendices.]]></summary></entry><entry><title type="html">A Wrong Name: Fifteen Years of TransitiveClosure in MMTk</title><link href="https://wks.github.io/blog/2022/05/16/fifteen-years-transitiveclosure.html" rel="alternate" type="text/html" title="A Wrong Name: Fifteen Years of TransitiveClosure in MMTk" /><published>2022-05-16T00:00:00+00:00</published><updated>2022-05-16T00:00:00+00:00</updated><id>https://wks.github.io/blog/2022/05/16/fifteen-years-transitiveclosure</id><content type="html" xml:base="https://wks.github.io/blog/2022/05/16/fifteen-years-transitiveclosure.html"><![CDATA[<p>The <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> interface in MMTk is confusing.  It should have been
split into two different interfaces, but not… until now.  What’s more
interesting is how we ended up having an interface like that 15 years ago, and
why it stayed that way since then.</p>

<h2 id="mmtk">MMTk?</h2>

<p>I have been contributing to the Memory Management Toolkit (MMTk) project since I
left Huawei.  <a href="https://www.mmtk.io/">MMTk</a> is a framework for garbage collection.  It was part of the
<a href="https://www.jikesrvm.org/">JikesRVM</a>, and has been a good platform for GC research.  Many state-of-the-art
garbage collection algorithms have been developed on it.  Now we are
re-implementing MMTk in Rust so that it can be integrated into many different
languages and VMs, such as OpenJDK, V8, Julia, GHC, PyPy and, of course
<a href="https://github.com/mmtk/mmtk-ruby/">Ruby</a> which I am working on.</p>

<p>As I started working on MMTk, one part of the code, that is, the
<code class="language-plaintext highlighter-rouge">TransitiveClosure</code> interface/trait has always confused me.</p>

<h2 id="transitiveclosure">TransitiveClosure?</h2>

<p>In the core MMTk repository, the <a href="https://github.com/mmtk/mmtk-core">mmtk-core</a>, you can find the
<a href="https://github.com/mmtk/mmtk-core/blob/093da769a71067dcd4f37db6f453213e7dace660/src/plan/transitive_closure.rs#L12">TransitiveClosure</a> trait and its implementation for all
<code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> instances. (Let’s not worry about what <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code>
does for now.)</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">TransitiveClosure</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">process_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">);</span>
    <span class="k">fn</span> <span class="nf">process_node</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">ProcessEdgesWork</span><span class="o">&gt;</span> <span class="n">TransitiveClosure</span> <span class="k">for</span> <span class="n">T</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">process_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">_slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
        <span class="nd">unreachable!</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nd">#[inline]</span>
    <span class="k">fn</span> <span class="nf">process_node</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">)</span> <span class="p">{</span>
        <span class="nn">ProcessEdgesWork</span><span class="p">::</span><span class="nf">process_node</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">object</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The presence of <code class="language-plaintext highlighter-rouge">unreachable!();</code> startled me.  The code implemented one method
(<code class="language-plaintext highlighter-rouge">process_node</code>), but declared the other method (<code class="language-plaintext highlighter-rouge">process_edge</code>) unreachable.
This is not how we usually use traits.  When we define a trait with two methods,
we expect <em>both</em> methods to be callable on <em>all</em> instances. Otherwise, why do we
even have the <code class="language-plaintext highlighter-rouge">process_edge</code> method in <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> in the first place?</p>

<p>I guess <em>some</em> types must have implemented the <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> trait <em>and</em>
provided a proper <code class="language-plaintext highlighter-rouge">process_edge</code> implementation.  And…  I am right.  It is
<a href="https://github.com/mmtk/mmtk-core/blob/093da769a71067dcd4f37db6f453213e7dace660/src/plan/transitive_closure.rs#L51">ObjectsClosure</a>.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">E</span><span class="p">:</span> <span class="n">ProcessEdgesWork</span><span class="o">&gt;</span> <span class="n">TransitiveClosure</span> <span class="k">for</span> <span class="n">ObjectsClosure</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">process_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.buffer</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.buffer</span><span class="nf">.reserve</span><span class="p">(</span><span class="nn">E</span><span class="p">::</span><span class="n">CAPACITY</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">self</span><span class="py">.buffer</span><span class="nf">.push</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
        <span class="c1">// ... more code omitted.</span>
    <span class="p">}</span>
    <span class="k">fn</span> <span class="nf">process_node</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">_object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">)</span> <span class="p">{</span>
        <span class="nd">unreachable!</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">unreachable!()</code> again?  What the <a href="https://www.dictionary.com/browse/wtf">…</a>!</p>

<p>Clearly <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> and <code class="language-plaintext highlighter-rouge">ObjectsClosure</code> are implementing two different
interfaces.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> only implements <code class="language-plaintext highlighter-rouge">process_node</code>, while</li>
  <li><code class="language-plaintext highlighter-rouge">ObjectsClosure</code> only implements <code class="language-plaintext highlighter-rouge">process_edge</code>.</li>
</ul>

<h2 id="should-we-split-transitiveclosure">Should we split TransitiveClosure?</h2>

<p>Maybe we should split it into <em>two different traits</em>, one contains
<code class="language-plaintext highlighter-rouge">process_node</code> and the other contains <code class="language-plaintext highlighter-rouge">process_edge</code>.  In this way, a type may
only implement the trait it needs, and not the <code class="language-plaintext highlighter-rouge">unreachable!()</code> stub.</p>

<p>Or, should we?</p>

<p>To confirm this, let’s find their call sites, and see whether we ever use both
methods at the same time.  The short answer is, no.</p>

<h3 id="the-process_node-method">The process_node method</h3>

<p><code class="language-plaintext highlighter-rouge">process_node</code> is only called by <code class="language-plaintext highlighter-rouge">XxxSpace::trace_object</code>, where <code class="language-plaintext highlighter-rouge">XxxSpace</code> is a
concrete space.  It can be <a href="https://github.com/mmtk/mmtk-core/blob/093da769a71067dcd4f37db6f453213e7dace660/src/policy/copyspace.rs#L156">CopySpace</a>, <a href="https://github.com/mmtk/mmtk-core/blob/093da769a71067dcd4f37db6f453213e7dace660/src/policy/mallocspace/global.rs#L244">MallocSpace</a>,
<a href="https://github.com/mmtk/mmtk-core/blob/093da769a71067dcd4f37db6f453213e7dace660/src/policy/largeobjectspace.rs#L170">LargeObjectSpace</a> and so on.</p>

<p><small><em><code class="language-plaintext highlighter-rouge">ImmixSpace</code> even has <a href="https://github.com/mmtk/mmtk-core/blob/093da769a71067dcd4f37db6f453213e7dace660/src/policy/immix/immixspace.rs#L317">two</a> <a href="https://github.com/mmtk/mmtk-core/blob/093da769a71067dcd4f37db6f453213e7dace660/src/policy/immix/immixspace.rs#L340">flavours</a> of
<code class="language-plaintext highlighter-rouge">trace_object</code>, both call <code class="language-plaintext highlighter-rouge">process_node</code>.</em></small></p>

<p>The <code class="language-plaintext highlighter-rouge">trace_object</code> method of a space visits an object during tracing.  It marks
or copies the object and, if it is the first time it visits an object, it
<em>enqueues</em> the object into the marking queue by calling the <code class="language-plaintext highlighter-rouge">process_node</code>
method which does the actual enqueuing.</p>

<h3 id="the-process_edge-method">The process_edge method</h3>

<p><code class="language-plaintext highlighter-rouge">process_edge</code> is only called by <code class="language-plaintext highlighter-rouge">VM::Scanning::scan_object</code>.</p>

<p><code class="language-plaintext highlighter-rouge">scan_object</code> is implemented by a VM binding (such as <a href="https://github.com/mmtk/mmtk-openjdk/blob/86c6f534ae57d03fa45e7a73b698f851c84ab943/mmtk/src/scanning.rs#L42">the OpenJDK
binding</a>) because it is VM-specific.  MMTk calls <code class="language-plaintext highlighter-rouge">scan_object</code>
when it needs the VM to locate all reference fields in an object.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">Scanning</span><span class="o">&lt;</span><span class="n">VM</span><span class="p">:</span> <span class="n">VMBinding</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">scan_object</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">TransitiveClosure</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">trace</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="p">,</span>
        <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">,</span>
        <span class="n">tls</span><span class="p">:</span> <span class="n">VMWorkerThread</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="c1">// ... more code omitted</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">trait</code> parameter is a call-back.  When <code class="language-plaintext highlighter-rouge">scan_object(trace, object, tls)</code> is
called, it scans <code class="language-plaintext highlighter-rouge">object</code>, and calls <code class="language-plaintext highlighter-rouge">trace.process_edge</code> on each edge, i.e.
each reference field, of <code class="language-plaintext highlighter-rouge">object</code>.</p>

<h3 id="yes--they-are-different">Yes!  They are different!</h3>

<p>We confirmed that each of the two methods is used in a different scenario.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">process_node</code> is only used by <code class="language-plaintext highlighter-rouge">trace_object</code>, and</li>
  <li><code class="language-plaintext highlighter-rouge">process_edge</code> is only used by <code class="language-plaintext highlighter-rouge">scan_object</code>.</li>
</ul>

<p>And nothing calls both <code class="language-plaintext highlighter-rouge">process_node</code> and <code class="language-plaintext highlighter-rouge">process_edge</code> at the same time.</p>

<p>So let’s split them into two traits.</p>

<p>But my colleague <a href="https://qinsoon.com/">Yi Lin</a> reminded me that there were other classes that extends
<code class="language-plaintext highlighter-rouge">TransitiveClosure</code> in the original MMTk in JikesRVM.  To be safe, I looked into
the original JikesRVM MMTk before making further decisions.</p>

<h2 id="back-in-jikesrvm">Back in JikesRVM</h2>

<p>Now we temporarily move away from Rust MMTk, and go back to JikesRVM MMTk.  If
the <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> trait is designed like this in Rust, it must have its
roots back in JikesRVM.</p>

<h3 id="transitiveclosure-in-jikesrvm-mmtk">TransitiveClosure in JikesRVM MMTk</h3>

<p>In <a href="https://www.jikesrvm.org/">JikesRVM</a>, there is a class named <a href="https://github.com/JikesRVM/JikesRVM/blob/0b6002e7d746a829d56c90acfc4bb5c560faf634/MMTk/src/org/mmtk/plan/TransitiveClosure.java#L29">TransitiveClosure</a>.  Yes.
It is a <em>class</em>, not an interface.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Uninterruptible</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
  <span class="c1">// Other methods omitted...</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processEdge</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Address</span> <span class="n">slot</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">VM</span><span class="o">.</span><span class="na">assertions</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="s">"processEdge not implemented."</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processNode</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">VM</span><span class="o">.</span><span class="na">assertions</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="s">"processNode not implemented."</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Defining <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> as a class allows it to provide failing default
implementations of <code class="language-plaintext highlighter-rouge">processEdge</code> and <code class="language-plaintext highlighter-rouge">processNode</code>.  This allows its subclasses
to override one method while leaving the other failing.</p>

<p><small><em>(Note that the JikesRVM code was written before Java 8, so interface
methods could not have default implementations.)</em></small></p>

<h3 id="transitiveclosure-subclasses-in-jikesrvm-mmtk">TransitiveClosure subclasses in JikesRVM MMTk</h3>

<p>In JikesRVM, many classes inherit from <code class="language-plaintext highlighter-rouge">TransitiveClosure</code>.</p>

<ul>
  <li>TransitiveClosure
    <ul>
      <li>TraceLocal
        <ul>
          <li>NoGCTraceLocal</li>
          <li>MSTraceLocal</li>
          <li>SSTraceLocal</li>
          <li>MCMarkTraceLocal</li>
          <li>MCForwardTraceLocal</li>
          <li>ImmixTraceLocal</li>
          <li>ImmixDefragTraceLocal</li>
          <li>…</li>
        </ul>
      </li>
      <li>RCZero</li>
      <li>RCModifiedProcessor</li>
      <li>GenRCModifiedProcessor</li>
      <li>ObjectReferenceBuffer
        <ul>
          <li>RCDecBuffer</li>
        </ul>
      </li>
      <li>TraceWriteBuffer</li>
    </ul>
  </li>
</ul>

<h3 id="tracelocal">TraceLocal</h3>

<p>Back in JikesRVM MMTk, there was no concept of “work packet”.  The abstraction
of tracing is the <code class="language-plaintext highlighter-rouge">Trace</code> class and its thread-local counterpart, <code class="language-plaintext highlighter-rouge">TraceLocal</code>.
<code class="language-plaintext highlighter-rouge">ThreadLocal</code> was the local context of a GC thread during tracing GC.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TraceLocal</span> <span class="kd">extends</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="nd">@Inline</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">processNode</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">values</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Inline</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">processEdge</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Address</span> <span class="n">slot</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ObjectReference</span> <span class="n">object</span> <span class="o">=</span> <span class="no">VM</span><span class="o">.</span><span class="na">activePlan</span><span class="o">.</span><span class="na">global</span><span class="o">().</span><span class="na">loadObjectReference</span><span class="o">(</span><span class="n">slot</span><span class="o">);</span>
        <span class="nc">ObjectReference</span> <span class="n">newObject</span> <span class="o">=</span> <span class="n">traceObject</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">overwriteReferenceDuringTrace</span><span class="o">())</span> <span class="o">{</span>
            <span class="no">VM</span><span class="o">.</span><span class="na">activePlan</span><span class="o">.</span><span class="na">global</span><span class="o">().</span><span class="na">storeObjectReference</span><span class="o">(</span><span class="n">slot</span><span class="o">,</span> <span class="n">newObject</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// ... more code omitted</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In JikesRVM, <code class="language-plaintext highlighter-rouge">TraceLocal</code> is the counterpart of both <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> and
<code class="language-plaintext highlighter-rouge">ObjectsClosure</code> of the current Rust MMTk.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Space.traceObject</code> calls <code class="language-plaintext highlighter-rouge">TraceLocal.processNode</code> to enqueues newly visited
objects,
    <ul>
      <li>just like <code class="language-plaintext highlighter-rouge">XxxSpace::trace_object</code> calling
<code class="language-plaintext highlighter-rouge">ProcessEdgesWork.process_node</code> in Rust MMTk.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> calls <code class="language-plaintext highlighter-rouge">TraceLocal.processEdge</code> to process each
reference field (edge),
    <ul>
      <li>just like <code class="language-plaintext highlighter-rouge">Scanning::scan_object</code> calling <code class="language-plaintext highlighter-rouge">ObjectsClosure.process_edge</code>
in Rust MMTk.</li>
    </ul>
  </li>
</ul>

<p>In JikesRVM MMTk, each plan (GC algorithm) defines its own <code class="language-plaintext highlighter-rouge">TraceLocal</code>
subclass.</p>

<p><small><em>(Some GC algorithms. such as MarkCompact and Immix, even have more than
one <code class="language-plaintext highlighter-rouge">TraceLocal</code> for different kinds of traces.)</em></small></p>

<p>It looks like the <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> is a proper interface for <code class="language-plaintext highlighter-rouge">TraceLocal</code>.
It implements both <code class="language-plaintext highlighter-rouge">processNode</code> and <code class="language-plaintext highlighter-rouge">processEdge</code>.</p>

<p>However, <code class="language-plaintext highlighter-rouge">TraceLocal</code> is the only class that implements both <code class="language-plaintext highlighter-rouge">processNode</code> and
<code class="language-plaintext highlighter-rouge">processEdge</code>.  Other classes don’t.</p>

<h3 id="processedge-field-visitors">processEdge: Field visitors</h3>

<p>Some subclasses of <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> are related to reference counting (RC).
They are <code class="language-plaintext highlighter-rouge">RCZero</code>, <code class="language-plaintext highlighter-rouge">RCModifiedProcessor</code>, etc.  They only override the
<code class="language-plaintext highlighter-rouge">processEdge</code> method, assuming <code class="language-plaintext highlighter-rouge">processNode</code> is never called.</p>

<p>What do they do?</p>

<p>They are <strong>field visitors</strong>.  For example, <code class="language-plaintext highlighter-rouge">RCZero</code> visits edges and stores
<code class="language-plaintext highlighter-rouge">null</code> to each field.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RCZero</span> <span class="kd">extends</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
    <span class="c1">// Does not override processNode, leaving it failing</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processEdge</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Address</span> <span class="n">slot</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">slot</span><span class="o">.</span><span class="na">store</span><span class="o">(</span><span class="nc">ObjectReference</span><span class="o">.</span><span class="na">nullReference</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>During RC collection, <code class="language-plaintext highlighter-rouge">RCZero</code> is passed to <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> as the
callback to set all reference fields of an object to <code class="language-plaintext highlighter-rouge">null</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">RCBaseCollector</span> <span class="kd">extends</span> <span class="nc">StopTheWorldCollector</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RCZero</span> <span class="n">zero</span><span class="o">;</span>  <span class="c1">// This implements TransitiveClosure</span>
    <span class="c1">// ... more code omitted</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">collectionPhase</span><span class="o">(</span><span class="kt">short</span> <span class="n">phaseId</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">primary</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ... more code omitted</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">phaseId</span> <span class="o">==</span> <span class="nc">RCBase</span><span class="o">.</span><span class="na">PROCESS_DECBUFFER</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ... more code omitted</span>
            <span class="k">while</span> <span class="o">(!(</span><span class="n">current</span> <span class="o">=</span> <span class="n">decBuffer</span><span class="o">.</span><span class="na">pop</span><span class="o">()).</span><span class="na">isNull</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// ... more code omitted</span>
                <span class="no">VM</span><span class="o">.</span><span class="na">scanning</span><span class="o">.</span><span class="na">scanObject</span><span class="o">(</span><span class="n">zero</span><span class="o">,</span> <span class="n">current</span><span class="o">);</span>  <span class="c1">// Passing zero as callback</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Other RC-related classes are similar.  They record the fields or apply
decrements to the objects pointed by each field.</p>

<h3 id="processnode-to-enqueue-objects">processNode: to enqueue objects</h3>

<p>The <code class="language-plaintext highlighter-rouge">TraceWriteBuffer</code> class only implements <code class="language-plaintext highlighter-rouge">processNode</code>.</p>

<p><small><em>(In fact, <code class="language-plaintext highlighter-rouge">TraceWriteBuffer</code> is the only class that overrides
<code class="language-plaintext highlighter-rouge">processNode</code> but note <code class="language-plaintext highlighter-rouge">processEdge</code> throughout the history of
JikesRVM.)</em></small></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TraceWriteBuffer</span> <span class="kd">extends</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">WriteBuffer</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="c1">// ... more code omitted</span>
    <span class="nd">@Inline</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processNode</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">object</span><span class="o">.</span><span class="na">toAddress</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">TraceWriteBuffer</code> is only used by <code class="language-plaintext highlighter-rouge">CMSMutator</code> (concurrent mark-sweep mutator).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CMSMutator</span> <span class="kd">extends</span> <span class="nc">ConcurrentMutator</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TraceWriteBuffer</span> <span class="n">remset</span><span class="o">;</span>
    <span class="c1">// ... more code omitted</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">checkAndEnqueueReference</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">ref</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="na">isNull</span><span class="o">())</span> <span class="k">return</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">barrierActive</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">ref</span><span class="o">.</span><span class="na">isNull</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">if</span>      <span class="o">(</span><span class="nc">Space</span><span class="o">.</span><span class="na">isInSpace</span><span class="o">(</span><span class="no">CMS</span><span class="o">.</span><span class="na">MARK_SWEEP</span><span class="o">,</span> <span class="n">ref</span><span class="o">))</span> <span class="no">CMS</span><span class="o">.</span><span class="na">msSpace</span><span class="o">.</span><span class="na">traceObject</span><span class="o">(</span><span class="n">remset</span><span class="o">,</span> <span class="n">ref</span><span class="o">);</span>            <span class="c1">// here</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Space</span><span class="o">.</span><span class="na">isInSpace</span><span class="o">(</span><span class="no">CMS</span><span class="o">.</span><span class="na">IMMORTAL</span><span class="o">,</span>   <span class="n">ref</span><span class="o">))</span> <span class="no">CMS</span><span class="o">.</span><span class="na">immortalSpace</span><span class="o">.</span><span class="na">traceObject</span><span class="o">(</span><span class="n">remset</span><span class="o">,</span> <span class="n">ref</span><span class="o">);</span>      <span class="c1">// here</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Space</span><span class="o">.</span><span class="na">isInSpace</span><span class="o">(</span><span class="no">CMS</span><span class="o">.</span><span class="na">LOS</span><span class="o">,</span>        <span class="n">ref</span><span class="o">))</span> <span class="no">CMS</span><span class="o">.</span><span class="na">loSpace</span><span class="o">.</span><span class="na">traceObject</span><span class="o">(</span><span class="n">remset</span><span class="o">,</span> <span class="n">ref</span><span class="o">);</span>            <span class="c1">// here</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Space</span><span class="o">.</span><span class="na">isInSpace</span><span class="o">(</span><span class="no">CMS</span><span class="o">.</span><span class="na">NON_MOVING</span><span class="o">,</span> <span class="n">ref</span><span class="o">))</span> <span class="no">CMS</span><span class="o">.</span><span class="na">nonMovingSpace</span><span class="o">.</span><span class="na">traceObject</span><span class="o">(</span><span class="n">remset</span><span class="o">,</span> <span class="n">ref</span><span class="o">);</span>     <span class="c1">// here</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Space</span><span class="o">.</span><span class="na">isInSpace</span><span class="o">(</span><span class="no">CMS</span><span class="o">.</span><span class="na">SMALL_CODE</span><span class="o">,</span> <span class="n">ref</span><span class="o">))</span> <span class="no">CMS</span><span class="o">.</span><span class="na">smallCodeSpace</span><span class="o">.</span><span class="na">traceObject</span><span class="o">(</span><span class="n">remset</span><span class="o">,</span> <span class="n">ref</span><span class="o">);</span>     <span class="c1">// here</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Space</span><span class="o">.</span><span class="na">isInSpace</span><span class="o">(</span><span class="no">CMS</span><span class="o">.</span><span class="na">LARGE_CODE</span><span class="o">,</span> <span class="n">ref</span><span class="o">))</span> <span class="no">CMS</span><span class="o">.</span><span class="na">largeCodeSpace</span><span class="o">.</span><span class="na">traceObject</span><span class="o">(</span><span class="n">remset</span><span class="o">,</span> <span class="n">ref</span><span class="o">);</span>     <span class="c1">// here</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// ... more code omitted</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In simple terms, the code above means “Trace the object <code class="language-plaintext highlighter-rouge">ref</code> in the space it is
in, and, if it is the first time the object is traced, enqueue it in <code class="language-plaintext highlighter-rouge">remset</code>.”</p>

<p>What’s in common between <code class="language-plaintext highlighter-rouge">TraceWriteBuffer</code> and <code class="language-plaintext highlighter-rouge">TraceLocal</code> is that both of
them contain a buffer (a remember set, or the tracing queue) where the
<code class="language-plaintext highlighter-rouge">traceObject</code> method can enqueue newly visited objects to.  This is what
<code class="language-plaintext highlighter-rouge">processNode</code> is for, i.e. <em>enqueuing objects</em>.</p>

<h3 id="so-why-not-introducing-a-dedicated-interface">So why not introducing a dedicated interface?</h3>

<p>There comes an interesting question:</p>

<blockquote>
  <p><em>If some classes are just field visitors, why don’t we have a dedicated
  interface for it, and name it <code class="language-plaintext highlighter-rouge">FieldVisitor</code>?</em></p>
</blockquote>

<p>and</p>

<blockquote>
  <p><em>If some classes are just places to enqueue objects, why don’t we have a
  dedicated interface for it, and name it <code class="language-plaintext highlighter-rouge">ObjectBuffer</code>?</em></p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">TransitiveClosure</code> has been there for 15 years.  Many developers have made
contributions to MMTk, and some of them must have noticed the issues I talked
about.  Why have <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> remained this way till today?</p>

<p>And why did we end up having this <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> amalgamation in the first
place?</p>

<h2 id="through-the-history">Through the history</h2>

<p>To answer these questions, I dug into the Git revision history of the JikesRVM
repository.</p>

<p>The <code class="language-plaintext highlighter-rouge">git blame</code> command can show me in which commit any line in any source file
is last modified.  I use <a href="https://github.com/tpope/vim-fugitive">vim-fugitive</a>, and it even allows me to follow a line
of code from one commit to another, and see every single change to a line of
code in history.</p>

<h3 id="early-days-of-object-scanning">Early days of object scanning</h3>

<p>The history of <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> is the history of object scanning interface
and implementation.</p>

<p><a href="https://github.com/JikesRVM/JikesRVM/tree/68e36aac633743a7930516eb4c7536240152dc1e">Back in 2003</a>, MMTk (was JMTk back then) and JikesRVM were
more tightly coupled than they are today.  Unlike the modern <code class="language-plaintext highlighter-rouge">Scanning</code>
interface, the <code class="language-plaintext highlighter-rouge">ScanObject</code> class back then contained concrete implementations
directly. The <a href="https://github.com/JikesRVM/JikesRVM/blob/68e36aac633743a7930516eb4c7536240152dc1e/rvm/src/vm/memoryManagers/JMTk/vmInterface/ScanObject.java#L42"><code class="language-plaintext highlighter-rouge">ScanObject.scan</code></a> method enumerates
reference fields, and directly calls the <code class="language-plaintext highlighter-rouge">Plan.traceObjectLocation</code> static
method, which does the load/traceObject/store sequence like our modern
<code class="language-plaintext highlighter-rouge">ProcessEdgesWork::process_edge</code> method.  Everything was hard-wired.  The
operation for visiting field was fixed.</p>

<p><a href="https://github.com/JikesRVM/JikesRVM/commit/e7bc7a0b35b96d3182a8cb53f9548c38c90de579">A commit in 2003</a> introduced the
<a href="https://github.com/JikesRVM/JikesRVM/blob/e7bc7a0b35b96d3182a8cb53f9548c38c90de579/rvm/src/vm/memoryManagers/JMTk/vmInterface/ScanObject.java#L64"><code class="language-plaintext highlighter-rouge">ScanObject.enumeratePointers</code></a> method which calls back to
<code class="language-plaintext highlighter-rouge">Plan.enumeratePointerLocation</code> which can be customised.  This allows a certain
degree of freedom of what to do with each field, instead of
load/traceObject/store.</p>

<p><a href="https://github.com/JikesRVM/JikesRVM/commit/e7195af9696795f20acb4eb841bc9beec8e7d412">Another commit in 2003</a> introduced the <code class="language-plaintext highlighter-rouge">Enumerate</code> class
which was subsequently renamed to <code class="language-plaintext highlighter-rouge">Enumerator</code> and <a href="https://github.com/JikesRVM/JikesRVM/commit/c2ff58e6a8499ad987ecb1c30a0f206f1036ef1c">made fully
abstract</a>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">abstract</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Enumerator</span> <span class="kd">implements</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">abstract</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">enumeratePointerLocation</span><span class="o">(</span><span class="nc">Address</span> <span class="n">location</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">ScanObject.enumeratePointers</code> method then used <code class="language-plaintext highlighter-rouge">Enumerator</code> as the call
back instead calling into <code class="language-plaintext highlighter-rouge">Plan</code> directly, allowing the behavior of visiting
each edge to be fully customised.</p>

<p>As I conjectured, <em>some developers did notice that the call-back for
<code class="language-plaintext highlighter-rouge">scanObjects</code> should be customisable</em>, and <code class="language-plaintext highlighter-rouge">Enumerator</code> was introduced just for
that.</p>

<h3 id="in-2006-just-before-that-important-change">In 2006, just before that important change</h3>

<p>Both the <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> and <code class="language-plaintext highlighter-rouge">Scanning.enumeratePointers</code> existed in <a href="https://github.com/JikesRVM/JikesRVM/blob/600956237939e61b314535d485dfdfcbab2c0bbe/MMTk/src/org/mmtk/vm/Scanning.java">the
Scanning class</a> before late 2006.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Scanning</span> <span class="kd">implements</span> <span class="nc">Constants</span><span class="o">,</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">scanObject</span><span class="o">(</span><span class="nc">TraceLocal</span> <span class="n">trace</span><span class="o">,</span> <span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">enumeratePointers</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Enumerator</span> <span class="n">e</span><span class="o">);</span>
    <span class="c1">// ... more code omitted</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Both <code class="language-plaintext highlighter-rouge">scanObject</code> and <code class="language-plaintext highlighter-rouge">enumeratePointers</code> enumerate reference fields in an
object.  However, they are used in totally different places.</p>

<h4 id="scanningscanobject">Scanning.scanObject</h4>

<p>The <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> method was used for tracing, as it took <code class="language-plaintext highlighter-rouge">TraceLocal</code>
as parameter, and called <code class="language-plaintext highlighter-rouge">TraceLocal.traceObjectLocation</code> for each reference
filed.</p>

<p>Note that at that time, <a href="https://github.com/JikesRVM/JikesRVM/blob/600956237939e61b314535d485dfdfcbab2c0bbe/MMTk/src/org/mmtk/plan/TraceLocal.java#L42">TraceLocal was a root
class</a>. There was no superclasses or interfaces
like <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> for it to extend/implement. (<code class="language-plaintext highlighter-rouge">Constants</code> is an
all-static interface, and <code class="language-plaintext highlighter-rouge">Uninterruptible</code> is just a marker.)  This means
<code class="language-plaintext highlighter-rouge">scanObject</code> was only applicable to subclasses of <code class="language-plaintext highlighter-rouge">TraceLocal</code>, and nothing
else.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TraceLocal</span> <span class="kd">implements</span> <span class="nc">Constants</span><span class="o">,</span> <span class="nc">Uninterruptible</span> <span class="o">{</span> <span class="c1">// no superclass</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InlinePragma</span> <span class="o">{</span> <span class="c1">// traceObject calls this</span>
        <span class="n">values</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">traceObjectLocation</span><span class="o">(</span><span class="nc">Address</span> <span class="n">objLoc</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">root</span><span class="o">)</span> <span class="c1">// scanObject calls this</span>
            <span class="kd">throws</span> <span class="nc">InlinePragma</span> <span class="o">{</span>
        <span class="nc">ObjectReference</span> <span class="n">object</span> <span class="o">=</span> <span class="n">objLoc</span><span class="o">.</span><span class="na">loadObjectReference</span><span class="o">();</span>
        <span class="nc">ObjectReference</span> <span class="n">newObject</span> <span class="o">=</span> <span class="n">traceObject</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">root</span><span class="o">);</span>
        <span class="n">objLoc</span><span class="o">.</span><span class="na">store</span><span class="o">(</span><span class="n">newObject</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// ... more code omitted</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="scanningenumeratepointers">Scanning.enumeratePointers</h4>

<p>On the other hand, the <code class="language-plaintext highlighter-rouge">Scanning.enumeratePointers</code> could in theory be used by
any code that needs to enumerate reference fields.  At that time, it was used
for (deferred) reference counting.  The following was the “mark grey” operation
in trial-deletion for cycle collection in reference counting.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TrialDeletion</span> <span class="kd">extends</span> <span class="nc">CycleDetector</span>
        <span class="kd">implements</span> <span class="nc">Constants</span><span class="o">,</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">TDGreyEnumerator</span> <span class="n">greyEnum</span><span class="o">;</span>  <span class="c1">// extends Enumerator</span>
    <span class="c1">// ... more code omitted</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">markGrey</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeCap</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">InlinePragma</span> <span class="o">{</span>
        <span class="c1">// ... more code omitted</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">object</span><span class="o">.</span><span class="na">isNull</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// ... more code omitted</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">abort</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">RefCountSpace</span><span class="o">.</span><span class="na">isGrey</span><span class="o">(</span><span class="n">object</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">RefCountSpace</span><span class="o">.</span><span class="na">makeGrey</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
                <span class="nc">Scan</span><span class="o">.</span><span class="na">enumeratePointers</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">greyEnum</span><span class="o">);</span>  <span class="c1">// pay attention to this call site</span>
            <span class="o">}</span>
            <span class="n">object</span> <span class="o">=</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">!</span><span class="n">abort</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// ... more code omitted</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The call site of <code class="language-plaintext highlighter-rouge">Scan.enumeratePointers</code> passed a <code class="language-plaintext highlighter-rouge">TDGreyEnumerator</code> instance
which customised the behaviour of visiting fields.  It just forward the call to
<code class="language-plaintext highlighter-rouge">TrialDeletion.enumerateGrey</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TDGreyEnumerator</span> <span class="kd">extends</span> <span class="nc">Enumerator</span> <span class="kd">implements</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">TrialDeletion</span> <span class="n">td</span><span class="o">;</span>
    <span class="c1">// ... more code omitted</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">enumeratePointerLocation</span><span class="o">(</span><span class="nc">Address</span> <span class="n">objLoc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InlinePragma</span> <span class="o">{</span>
        <span class="n">td</span><span class="o">.</span><span class="na">enumerateGrey</span><span class="o">(</span><span class="n">objLoc</span><span class="o">.</span><span class="na">loadObjectReference</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="the-obvious-problem">The obvious problem</h4>

<p>We then had <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> for tracing, and <code class="language-plaintext highlighter-rouge">Scanning.enumeratePointers</code>
for RC.</p>

<p>But <em>why did we need both methods</em>?  <code class="language-plaintext highlighter-rouge">scanObject</code> was basically a special case
of <code class="language-plaintext highlighter-rouge">enumeratePointers</code> that called <code class="language-plaintext highlighter-rouge">TraceObject.enumeratePointerLocation</code>.</p>

<p>Could we <strong>unify</strong> them? Apparently someone noticed that, and he did a
refactoring.</p>

<h3 id="unifying-scanobject-and-enumeratepointers-with-tracestep">Unifying scanObject and enumeratePointers with “TraceStep”</h3>

<p>In late 2006, <a href="https://github.com/JikesRVM/JikesRVM/commit/64f538ca4d348f062f3afb313f519ffcbbbd22bd">someone created a commit</a> which
introduced a new version of reference counting collector, and at the same time
did “a huge refactoring” (see the commit message).</p>

<p>This commit created a class named <code class="language-plaintext highlighter-rouge">TraceStep</code>.  <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> then took
<code class="language-plaintext highlighter-rouge">TraceStep</code> as parameter instead of <code class="language-plaintext highlighter-rouge">TraceLocal</code>.  The <code class="language-plaintext highlighter-rouge">enumeratePointers</code>
method was removed.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TraceStep</span> <span class="kd">implements</span> <span class="nc">Constants</span><span class="o">,</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">traceObjectLocation</span><span class="o">(</span><span class="nc">Address</span> <span class="n">objLoc</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Scanning</span> <span class="kd">implements</span> <span class="nc">Constants</span><span class="o">,</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">scanObject</span><span class="o">(</span><span class="nc">TraceStep</span> <span class="n">trace</span><span class="o">,</span> <span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Obviously, <code class="language-plaintext highlighter-rouge">TraceStep</code> was intended to replaced <code class="language-plaintext highlighter-rouge">Enumerator</code> as the call-back
interface for <code class="language-plaintext highlighter-rouge">scanObject</code> to enumerating fields.  Both tracing and RC started
using <code class="language-plaintext highlighter-rouge">scanObject</code> from then on.</p>

<p>For tracing, the <code class="language-plaintext highlighter-rouge">TraceLocal</code> started to extend <code class="language-plaintext highlighter-rouge">TraceStep</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TraceLocal</span> <span class="kd">extends</span> <span class="nc">TraceStep</span>   <span class="c1">// Now extends TraceStep</span>
        <span class="kd">implements</span> <span class="nc">Constants</span><span class="o">,</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">traceObjectLocation</span><span class="o">(</span><span class="nc">Address</span> <span class="n">objLoc</span><span class="o">)</span> <span class="c1">// called by scanObject</span>
            <span class="kd">throws</span> <span class="nc">InlinePragma</span> <span class="o">{</span>
        <span class="n">traceObjectLocation</span><span class="o">(</span><span class="n">objLoc</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">traceObjectLocation</span><span class="o">(</span><span class="nc">Address</span> <span class="n">objLoc</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">root</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">InlinePragma</span> <span class="o">{</span>
        <span class="c1">// ... just like before</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>RC operations, such as “mark grey”, started extending <code class="language-plaintext highlighter-rouge">TraceStep</code> instead of
<code class="language-plaintext highlighter-rouge">Enumerator</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TrialDeletionGreyStep</span> <span class="kd">extends</span> <span class="nc">TraceStep</span>  <span class="c1">// Now extends TraceStep instead of Enumerator</span>
        <span class="kd">implements</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">traceObjectLocation</span><span class="o">(</span><span class="nc">Address</span> <span class="n">objLoc</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ObjectReference</span> <span class="n">object</span> <span class="o">=</span> <span class="n">objLoc</span><span class="o">.</span><span class="na">loadObjectReference</span><span class="o">();</span>
        <span class="o">((</span><span class="nc">TrialDeletionCollector</span><span class="o">)</span><span class="nc">CDCollector</span><span class="o">.</span><span class="na">current</span><span class="o">()).</span><span class="na">enumerateGrey</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TrialDeletionCollector</span> <span class="kd">extends</span> <span class="nc">CDCollector</span>
        <span class="kd">implements</span> <span class="nc">Uninterruptible</span><span class="o">,</span> <span class="nc">Constants</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">TrialDeletionGreyStep</span> <span class="n">greyStep</span><span class="o">;</span>  <span class="c1">// A TraceStep instead of Enumerator</span>
    <span class="c1">// ... more code omitted</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">markGrey</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InlinePragma</span> <span class="o">{</span>
        <span class="c1">// ... more code omitted</span>
        <span class="nc">Scan</span><span class="o">.</span><span class="na">scanObject</span><span class="o">(</span><span class="n">greyStep</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>  <span class="c1">// now passes a TraceStep as arg</span>
        <span class="c1">// ... more code omitted</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This commit successfully unified the object scanning interface.
<code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> became the only object-scanning method. It became
applicable to all <code class="language-plaintext highlighter-rouge">TraceStep</code> instances alike, and was no longer coupled with
<code class="language-plaintext highlighter-rouge">TraceLocal</code>. Good! Nicely done!</p>

<p>More over, this commit cleverly found a concept that describes both
<code class="language-plaintext highlighter-rouge">TraceLocal</code> and the various operations in reference counting, such as “mark
grey”, “scan black”, etc.  It was <strong>“TraceStep”</strong>.  Intuitively, all of them
were steps of tracing.</p>

<p>But really?  We will soon find that it is not really that clever.</p>

<h3 id="here-comes-transitiveclosure">Here comes TransitiveClosure</h3>

<p>In 2007, someone made <a href="https://github.com/JikesRVM/JikesRVM/commit/f85c61257bbeda1efeed3a2f6a4ba5903cbe74e0">another commit</a> to “reorganise the core of
transitive closure”, and the motivations were “concurrent collection” and
“implementing prefetching during trace”.</p>

<p>In this commit, <code class="language-plaintext highlighter-rouge">TraceStep</code> was renamed to our familiar <code class="language-plaintext highlighter-rouge">TransitiveClosure</code>.</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">TraceStep.traceObjectLocation</code> method was renamed to
<code class="language-plaintext highlighter-rouge">TransitiveClosure.processEdge</code>, and</li>
  <li>a new method <code class="language-plaintext highlighter-rouge">processNode</code> was added.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Uninterruptible</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
  <span class="cm">/**
   * Trace an edge during GC.
   *
   * @param objLoc The location containing the object reference.
   */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processEdge</span><span class="o">(</span><span class="nc">Address</span> <span class="n">objLoc</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">VM</span><span class="o">.</span><span class="na">assertions</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="s">"processEdge not implemented."</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Trace a node during GC.
   *
   * @param object The object to be processed.
   */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processNode</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">VM</span><span class="o">.</span><span class="na">assertions</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="s">"processNode not implemented."</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Note that I didn’t add any <code class="language-plaintext highlighter-rouge">// ... more code omitted</code> comment because back in
2007, that was <a href="https://github.com/JikesRVM/JikesRVM/blob/f85c61257bbeda1efeed3a2f6a4ba5903cbe74e0/MMTk/src/org/mmtk/plan/TransitiveClosure.java#L29">the entire class body of <code class="language-plaintext highlighter-rouge">TransitiveClosure</code></a>.</p>

<p><code class="language-plaintext highlighter-rouge">TraceLocal</code> now extends <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> instead of <code class="language-plaintext highlighter-rouge">TraceStep</code>, and</p>

<ul>
  <li>the <code class="language-plaintext highlighter-rouge">traceObjectLocation</code> method was renamed to <code class="language-plaintext highlighter-rouge">processEdge</code>, and</li>
  <li>the <code class="language-plaintext highlighter-rouge">enqueue</code> method was renamed to <code class="language-plaintext highlighter-rouge">processNode</code>.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TraceLocal</span> <span class="kd">extends</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">processNode</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ... like before</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">processEdge</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Address</span> <span class="n">slot</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ... like before</span>
    <span class="o">}</span>
    <span class="c1">// ... more code omitted</span>
<span class="o">}</span>
</code></pre></div></div>

<p>A few days later, <a href="https://github.com/JikesRVM/JikesRVM/commit/2257a7565c9920beb8455a6df0f8f6f8dbb2bae4">a subsequent commit</a> introduced a
<code class="language-plaintext highlighter-rouge">TraceWriteBuffer</code> class that extended <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> and overrode
<code class="language-plaintext highlighter-rouge">processNode</code> alone, and not <code class="language-plaintext highlighter-rouge">processEdge</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TraceWriteBuffer</span> <span class="kd">extends</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
    <span class="c1">// ... more code omitted</span>
    <span class="nd">@Inline</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processNode</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// .. as you have seen in previous sections.</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>It remains the only class that overrides <code class="language-plaintext highlighter-rouge">processNode</code> but note <code class="language-plaintext highlighter-rouge">processEdge</code>
in the history of JikesRVM, even today.</p>

<p>With this change, <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> started to serve two distinct purposes.</p>

<ol>
  <li>the callback for <code class="language-plaintext highlighter-rouge">scanObject</code>, and</li>
  <li>the place to enqueue an object after tracing it.</li>
</ol>

<p>If a class was only used in one of the two cases, it would override only one of
the two methods.</p>

<h3 id="10-years-passed">10 years passed…</h3>

<p><code class="language-plaintext highlighter-rouge">TransitiveClosure</code> remained this way in JikesRVM MMTk since then.</p>

<p>And the <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> class grew a little bit.  <a href="https://github.com/JikesRVM/JikesRVM/blob/5072f19761115d987b6ee162f49a03522d36c697/MMTk/src/org/mmtk/plan/TransitiveClosure.java#L32">Some static fields and
methods about specialised scanning</a> were added to it, as if
it were a good place to hold information for specialised scanning.</p>

<h3 id="and-there-was-rust-mmtk">…and there was Rust MMTk.</h3>

<p>In 2017, we started porting MMTk to Rust.</p>

<h4 id="porting-mmtk-to-rust">Porting MMTk to Rust</h4>

<p>The <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> was copied to the Rust version, except this time it
was represented as a Rust trait.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">TransitiveClosure</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">process_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">);</span>
    <span class="k">fn</span> <span class="nf">process_node</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And <code class="language-plaintext highlighter-rouge">TraceLocal</code> was a trait that requires <code class="language-plaintext highlighter-rouge">TransitiveClosure</code>.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">TraceLocal</span><span class="p">:</span> <span class="n">TransitiveClosure</span> <span class="p">{</span>
    <span class="c1">// ... other methods</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Scanning.scan_object</code> method took <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> as parameter, just
like JikesRVM MMTk.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">Scanning</span><span class="o">&lt;</span><span class="n">VM</span><span class="p">:</span> <span class="n">VMBinding</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">scan_object</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">TransitiveClosure</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">trace</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="p">,</span>
        <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">,</span>
        <span class="n">tls</span><span class="p">:</span> <span class="n">OpaquePointer</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="c1">// ... more code omitted</span>
<span class="p">}</span>

</code></pre></div></div>

<p>And the <code class="language-plaintext highlighter-rouge">XxxSpace::trace_object</code> methods still took <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> as
parameter, like this:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">VM</span><span class="p">:</span> <span class="n">VMBinding</span><span class="o">&gt;</span> <span class="n">CopySpace</span><span class="o">&lt;</span><span class="n">VM</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">trace_object</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">TransitiveClosure</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="p">,</span>
        <span class="n">trace</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="p">,</span>
        <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">,</span>
        <span class="n">allocator</span><span class="p">:</span> <span class="n">Allocator</span><span class="p">,</span>
        <span class="n">tls</span><span class="p">:</span> <span class="n">OpaquePointer</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ObjectReference</span> <span class="p">{</span>

    <span class="c1">// ... more code omitted</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And <a href="https://github.com/mmtk/mmtk-core/blob/96855d287fe5ea789a532f347d6ee37e6679c71f/src/plan/tracelocal.rs">there was still TraceLocal</a>. (Not any more now.)</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">TraceLocal</span><span class="p">:</span> <span class="n">TransitiveClosure</span> <span class="p">{</span>
    <span class="c1">// ... omitted.  There are many methods, but none is interesting here.</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Like in JikesRVM MMTk,</p>

<ul>
  <li>the <code class="language-plaintext highlighter-rouge">scan_object</code> method still called <code class="language-plaintext highlighter-rouge">trace.process_edge</code> for each visited
edge, and</li>
  <li>the <code class="language-plaintext highlighter-rouge">trace_object</code> method still called <code class="language-plaintext highlighter-rouge">trace.process_node</code> to enqueue the
object on first visit.</li>
</ul>

<p>Initially, <em>we did not address the fact that TransitiveClosure served two
different purposes.</em> By that time, we had just begun porting MMTk to Rust.  <strong>We
prioritised making Rust MMTk working</strong>, and ported from JikesRVM MMTk in a style
closely resembled the original Java code.</p>

<p>And MMTk worked.  Not just worked, but worked for OpenJDK, JikesRVM and several
other VMs, too.</p>

<h4 id="introducing-work-packets">Introducing work packets</h4>

<p>We later removed <code class="language-plaintext highlighter-rouge">TraceLocal</code> and introduced the work packet system.</p>

<p>The work packet system represents each unit of work as a “packet” that can be
scheduled on any GC worker thread.  The <code class="language-plaintext highlighter-rouge">TraceLocal</code> class was replaced by two
work packets:</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> work packet represents a list of edges to be traced.</li>
  <li>The <code class="language-plaintext highlighter-rouge">ScanObjects</code> work packet represents a list of objects to be scanned.</li>
</ul>

<p>A <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> work packet also carries an object queue inside it.  It
needs the <code class="language-plaintext highlighter-rouge">process_node</code> method so that <code class="language-plaintext highlighter-rouge">XxxSpace.trace_object</code> can call it and
queue newly visited objects.</p>

<p>Therefore, <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> implements TransitiveClosure because
<code class="language-plaintext highlighter-rouge">trace_object</code> expects it. And… remember?  That implementation startled me…</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">ProcessEdgesWork</span><span class="o">&gt;</span> <span class="n">TransitiveClosure</span> <span class="k">for</span> <span class="n">T</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">process_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">_slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
        <span class="nd">unreachable!</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nd">#[inline]</span>
    <span class="k">fn</span> <span class="nf">process_node</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">)</span> <span class="p">{</span>
        <span class="nn">ProcessEdgesWork</span><span class="p">::</span><span class="nf">process_node</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">object</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then what visits edges when scanning an object?  It is now the <code class="language-plaintext highlighter-rouge">ObjectsClosure</code>
object.  It needs to provide <code class="language-plaintext highlighter-rouge">process_edge</code>, but <code class="language-plaintext highlighter-rouge">Scanning::scan_object</code> expects
<code class="language-plaintext highlighter-rouge">TransitiveClosure</code>.</p>

<p>So we have to do what the <a href="https://www.dictionary.com/browse/wtf">…</a> we need to satisfy that requirement, as we
have seen before:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">E</span><span class="p">:</span> <span class="n">ProcessEdgesWork</span><span class="o">&gt;</span> <span class="n">TransitiveClosure</span> <span class="k">for</span> <span class="n">ObjectsClosure</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">process_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.buffer</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.buffer</span><span class="nf">.reserve</span><span class="p">(</span><span class="nn">E</span><span class="p">::</span><span class="n">CAPACITY</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">self</span><span class="py">.buffer</span><span class="nf">.push</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
        <span class="c1">// ... more code omitted.</span>
    <span class="p">}</span>
    <span class="k">fn</span> <span class="nf">process_node</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">_object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">)</span> <span class="p">{</span>
        <span class="nd">unreachable!</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span> 
</code></pre></div></div>

<p>As you can see, <strong>even after we migrated to the work packet system, and even
though we no longer have any type that overrides both <code class="language-plaintext highlighter-rouge">process_edge</code> and
<code class="language-plaintext highlighter-rouge">process_node</code>, we still kept both <code class="language-plaintext highlighter-rouge">process_edge</code> and <code class="language-plaintext highlighter-rouge">process_node</code> in the
<code class="language-plaintext highlighter-rouge">TransitiveClosure</code> trait</strong>.</p>

<h2 id="why-do-we-end-up-having-transitiveclosure-like-this">Why do we end up having TransitiveClosure like this?</h2>

<p>We have been startled by smelly code.  We have <a href="https://www.dictionary.com/browse/wtf">expressed our anger, impatience,
surprise, etc., without explicit vulgarity</a>.  We have looked into JikesRVM
for the old MMTk.  We have gone through the history to see the change of the
object scanning interface, and read the commits from developers with the
intention of improving MMTk.</p>

<p>But why do we end up having a <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> trait like this?</p>

<h3 id="have-we-noticed-that-object-scanning-is-not-necessarily-part-of-tracing">Have we noticed that object scanning is not necessarily part of tracing?</h3>

<p>Yes.  The <a href="https://github.com/JikesRVM/JikesRVM/commit/c2ff58e6a8499ad987ecb1c30a0f206f1036ef1c"><code class="language-plaintext highlighter-rouge">Enumerator</code></a> interface was introduced just for
that.  When called back from <code class="language-plaintext highlighter-rouge">scan_object</code>, it allows us to do anything to
reference fields.</p>

<h3 id="have-we-refactored-scan_object-so-it-takes-a-simple-callback-instead-of-tracelocal">Have we refactored scan_object so it takes a simple callback instead of TraceLocal?</h3>

<p>Yes.  When <a href="https://github.com/JikesRVM/JikesRVM/commit/64f538ca4d348f062f3afb313f519ffcbbbd22bd"><code class="language-plaintext highlighter-rouge">TraceStep</code></a> was introduced, We unified
<code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> and <code class="language-plaintext highlighter-rouge">Scanning.enumeratePointers</code>.  <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code>
was refactored to only depend on <code class="language-plaintext highlighter-rouge">TraceStep</code>, and <code class="language-plaintext highlighter-rouge">TraceStep</code> was an abstract
class with only an abstract method <code class="language-plaintext highlighter-rouge">traceObjectLocation(Address objLoc)</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TraceStep</span> <span class="kd">implements</span> <span class="nc">Constants</span><span class="o">,</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">traceObjectLocation</span><span class="o">(</span><span class="nc">Address</span> <span class="n">objLoc</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Scanning</span> <span class="kd">implements</span> <span class="nc">Constants</span><span class="o">,</span> <span class="nc">Uninterruptible</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">scanObject</span><span class="o">(</span><span class="nc">TraceStep</span> <span class="n">trace</span><span class="o">,</span> <span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This should have been the ideal interface for <code class="language-plaintext highlighter-rouge">Scanning.scan_object</code> for MMTk in
Java.  (Rust could use closure to make it more concise.)</p>

<h3 id="but-why-did-we-migrate-away-from-it">But why did we migrate away from it?</h3>

<p>Probably only the author of <a href="https://github.com/JikesRVM/JikesRVM/commit/f85c61257bbeda1efeed3a2f6a4ba5903cbe74e0">this commit</a> knows the exact reason.</p>

<p>To my understanding, I think it was because <strong><code class="language-plaintext highlighter-rouge">TraceStep</code> was such a good, but
a wrong, name</strong>.</p>

<ol>
  <li>
    <p>We named it “TraceStep”.</p>
  </li>
  <li>
    <p>We made it the superclass of <code class="language-plaintext highlighter-rouge">TraceLocal</code>.</p>
  </li>
  <li>
    <p>We then <a href="https://github.com/JikesRVM/JikesRVM/commit/2257a7565c9920beb8455a6df0f8f6f8dbb2bae4">introduced TraceWriteBuffer</a>.</p>
  </li>
  <li>
    <p>We noticed <code class="language-plaintext highlighter-rouge">TraceWriteBuffer</code> was another place to enqueue objects in
addition to <code class="language-plaintext highlighter-rouge">TraceLocal</code>.</p>
  </li>
  <li>
    <p>Then we naturally thought that both <code class="language-plaintext highlighter-rouge">TraceWriteBuffer</code> and <code class="language-plaintext highlighter-rouge">TraceLocal</code>
should have a common superclass that had a method named <code class="language-plaintext highlighter-rouge">enqueue</code>.</p>

    <p>But <code class="language-plaintext highlighter-rouge">TraceStep</code> doesn’t have <code class="language-plaintext highlighter-rouge">enqueue</code>.</p>
  </li>
  <li>
    <p>Then we extended <code class="language-plaintext highlighter-rouge">TraceStep</code> into <code class="language-plaintext highlighter-rouge">TransitiveClosure</code>, and added <code class="language-plaintext highlighter-rouge">enqueue</code>.</p>

    <p>And we even renamed <code class="language-plaintext highlighter-rouge">enqueue</code> to <code class="language-plaintext highlighter-rouge">processNode</code> to make it consistent with
<code class="language-plaintext highlighter-rouge">processEdge</code>.</p>
  </li>
  <li>
    <p>Then we have <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> which had <code class="language-plaintext highlighter-rouge">processEdge</code> and <code class="language-plaintext highlighter-rouge">processNode</code>.</p>
  </li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TraceLocal</span> <span class="kd">extends</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">processNode</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TraceWriteBuffer</span> <span class="kd">extends</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processNode</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Wow!  “TransitiveClosure” was an even better name!  That was what <code class="language-plaintext highlighter-rouge">TraceLocal</code>
really was, i.e. computing the transitive closure of an object graph!  A
“transitive closure” is a graph!  A graph has nodes and edges!</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TransitiveClosure</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processEdge</span><span class="o">(</span><span class="nc">Address</span> <span class="n">objLoc</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processNode</span><span class="o">(</span><span class="nc">ObjectReference</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>But <code class="language-plaintext highlighter-rouge">TraceWriteBuffer</code> doesn’t override <code class="language-plaintext highlighter-rouge">processEdge</code>, and <code class="language-plaintext highlighter-rouge">RCZero</code> doesn’t
override <code class="language-plaintext highlighter-rouge">processNode</code>!</p>

<p>No worries.  We leave them “unreachable”.</p>

<p>“Unreachable”?  That doesn’t sound right.</p>

<p>But it worked… for 15 years.</p>

<p>The name “TransitiveClosure”  made so much sense that we stuck to
<code class="language-plaintext highlighter-rouge">TransitiveClosure</code> forever, even after we ported MMTk to Rust.</p>

<h3 id="but-tracestep-is-a-wrong-name">But TraceStep is a wrong name.</h3>

<ol>
  <li><code class="language-plaintext highlighter-rouge">TraceLocal</code>, “mark grey”, “scan black”, <code class="language-plaintext highlighter-rouge">RCZero</code> and so on are all steps in
tracing,</li>
  <li>and those trace steps process edges,</li>
  <li>hence <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> should accept <code class="language-plaintext highlighter-rouge">TraceStep</code> as a call-back
argument, so <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> can give <code class="language-plaintext highlighter-rouge">TraceStep</code> edges to process.</li>
</ol>

<p>Wrong.</p>

<p><code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> accepts a callback argument not because the callback is a
step of tracing, but simply <strong>because the callback visits edges</strong>.</p>

<p>I don’t really know what counts as a “trace step”.</p>

<ul>
  <li>Does “assigning <code class="language-plaintext highlighter-rouge">null</code> to each reference field” count as a “trace step”?</li>
  <li>Does “applying decrement operations to the reference counts of all neighbor
objects” count as a “trace step” even if it is used in reference counting,
only?</li>
  <li>Is trial-deletion considered as a kind of tracing at all?</li>
</ul>

<p>No matter what it is, isn’t it much easier to just say</p>

<blockquote>
  <p><em>“<code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> accepts it as a callback argument because it visits
  edges.”</em></p>
</blockquote>

<h3 id="the-nature-of-interfaces">The nature of interfaces.</h3>

<p>This is the nature of interfaces.  A reuseable component should not make
assumptions about its neighbours more than necessary.  This is <strong>the
separation of concern</strong>.</p>

<p>It is just like when we do the following in rust:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.foreach</span><span class="p">(|</span><span class="n">e</span><span class="p">|</span> <span class="p">{</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Iterator::foreach</code> function accepts this closure not because it prints
things, but because it visits elements.  <code class="language-plaintext highlighter-rouge">foreach</code> is intended for visiting
elements.  The closure receives the object.  That is the contract of the
<code class="language-plaintext highlighter-rouge">foreach</code> method.  Whether it prints the element or how it prints the element is
not part of the contract.</p>

<p>So “Enumerator” was a right name.  It correctly describes the role of the object
in a <code class="language-plaintext highlighter-rouge">scanObject</code> invocation, that is, <em>“it enumerates fields”</em>, nothing more.
That’s all what <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> need to care about.  It passes each field
to the callback, and that’s it.  It should not assume what that callback object
does to each edge.  Whether it is a <code class="language-plaintext highlighter-rouge">TraceLocal</code> or an RC operation is beyond
its obligation.</p>

<p>“TraceStep” was wrong.  “TransitiveClosure” was also wrong.  Neither of them
is what <code class="language-plaintext highlighter-rouge">Scanning.scanObject</code> cares about.</p>

<h2 id="finding-the-way-out">Finding the way out</h2>

<p>We have seen the history, and know why it ended up like this.</p>

<p>We know what was wrong, and what would be right.</p>

<p>“Enumerator” was right.  “TraceStep” was wrong.  “TransitiveClosure” was wrong,
too, but it just sounded so good.</p>

<p>No matter how good it sounds, we need to fix it.</p>

<p>From our analysis in the beginning of this article, we should split
<code class="language-plaintext highlighter-rouge">TransitiveClosure</code> into two traits,</p>

<ol>
  <li>one as the callback of <code class="language-plaintext highlighter-rouge">Scanning::scan_object</code>, and</li>
  <li>the other to be used by <code class="language-plaintext highlighter-rouge">XxxSpace::trace_object</code> to enqueue object.</li>
</ol>

<p>I have opened an <a href="https://github.com/mmtk/mmtk-core/issues/559">issue</a>, and detailed the steps of
splitting and removing <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> from <code class="language-plaintext highlighter-rouge">mmtk-core</code>.</p>

<h3 id="refactoring-scanningscan_object">Refactoring Scanning::scan_object</h3>

<p><code class="language-plaintext highlighter-rouge">Scanning::scan_object</code> takes an object and a callback as parameters.  It will
find all reference fields in the object, and invoke the callback for each
reference field.</p>

<p>We need a proper name for the callback of <code class="language-plaintext highlighter-rouge">Scanning::scan_object</code>.</p>

<p>I name it <code class="language-plaintext highlighter-rouge">EdgeVisitor</code>, and its only method is, as you can imagine,
<code class="language-plaintext highlighter-rouge">visit_edge</code>.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">EdgeVisitor</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">visit_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span> <span class="n">Address</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And it replaces <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> as the parameter type of
<code class="language-plaintext highlighter-rouge">Scanning::scan_object</code>:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">Scanning</span><span class="o">&lt;</span><span class="n">VM</span><span class="p">:</span> <span class="n">VMBinding</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">scan_object</span><span class="o">&lt;</span><span class="n">EV</span><span class="p">:</span> <span class="n">EdgeVisitor</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">tls</span><span class="p">:</span> <span class="n">VMWorkerThread</span><span class="p">,</span>
        <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">,</span>
        <span class="n">edge_visitor</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">EV</span><span class="p">,</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then the only callback that have ever been passed to <code class="language-plaintext highlighter-rouge">Scanning::scan_object</code>,
i.e. <code class="language-plaintext highlighter-rouge">ObjectsClosure</code>, now implements <code class="language-plaintext highlighter-rouge">EdgeVisitor</code>, instead.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">E</span><span class="p">:</span> <span class="n">ProcessEdgesWork</span><span class="o">&gt;</span> <span class="n">EdgeVisitor</span> <span class="k">for</span> <span class="n">ObjectsClosure</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">visit_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ... code omitted</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And this change has been <a href="https://github.com/mmtk/mmtk-core/commit/0babba20290d3c4e4cdb2a83284aa7204c9a23cc">merged</a> into the master branch of
<code class="language-plaintext highlighter-rouge">mmtk-core</code>.</p>

<h4 id="meanwhile-in-australia">Meanwhile in Australia…</h4>

<p>While I was refactoring <code class="language-plaintext highlighter-rouge">mmtk-core</code> and working on <code class="language-plaintext highlighter-rouge">mmtk-ruby</code>, my colleague
<a href="https://wenyu.me/">Wenyu Zhao</a> was busy with <a href="https://users.cecs.anu.edu.au/~steveb/pubs/papers/lxr-pldi-2022.pdf">his paper about the LXC GC algorithm</a> targetting <a href="https://pldi22.sigplan.org/details/pldi-2022-pldi/15/Low-Latency-High-Throughput-Garbage-Collection">PLDI 2022</a>.</p>

<p>Wenyu <a href="https://github.com/wenyuzhao/mmtk-core/commit/9587aca2c62e02e043a5f01c3488cd91e21515b0">independently introduced</a> the
<a href="https://github.com/wenyuzhao/mmtk-core/blob/9587aca2c62e02e043a5f01c3488cd91e21515b0/src/plan/transitive_closure.rs#L88"><code class="language-plaintext highlighter-rouge">EdgeIterator</code></a> struct.  It is a wrapper over
<code class="language-plaintext highlighter-rouge">Scanning::scan_object</code> and <code class="language-plaintext highlighter-rouge">TransitiveClosure</code>, and the <code class="language-plaintext highlighter-rouge">unreachable!()</code>
statement, too! :P</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">EdgeIterator</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">VM</span><span class="p">:</span> <span class="n">VMBinding</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">f</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span> <span class="nf">FnMut</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span> <span class="o">+</span> <span class="nv">'a</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">_p</span><span class="p">:</span> <span class="n">PhantomData</span><span class="o">&lt;</span><span class="n">VM</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">VM</span><span class="p">:</span> <span class="n">VMBinding</span><span class="o">&gt;</span> <span class="n">EdgeIterator</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">VM</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">iterate</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="k">impl</span> <span class="nf">FnMut</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span> <span class="o">+</span> <span class="nv">'a</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">x</span> <span class="o">=</span> <span class="k">Self</span> <span class="p">{</span> <span class="n">f</span><span class="p">:</span> <span class="k">box</span> <span class="n">f</span><span class="p">,</span> <span class="n">_p</span><span class="p">:</span> <span class="n">PhantomData</span> <span class="p">};</span>
        <span class="o">&lt;</span><span class="nn">VM</span><span class="p">::</span><span class="n">VMScanning</span> <span class="k">as</span> <span class="n">Scanning</span><span class="o">&lt;</span><span class="n">VM</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">scan_object</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">x</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="nf">VMWorkerThread</span><span class="p">(</span><span class="nn">VMThread</span><span class="p">::</span><span class="n">UNINITIALIZED</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">VM</span><span class="p">:</span> <span class="n">VMBinding</span><span class="o">&gt;</span> <span class="n">TransitiveClosure</span> <span class="k">for</span> <span class="n">EdgeIterator</span><span class="o">&lt;</span><span class="nv">'a</span><span class="p">,</span> <span class="n">VM</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">#[inline(always)]</span>
    <span class="k">fn</span> <span class="nf">process_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="k">self</span><span class="py">.f</span><span class="p">)(</span><span class="n">slot</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">fn</span> <span class="nf">process_node</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">_object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">)</span> <span class="p">{</span>
        <span class="nd">unreachable!</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With this struct, it allows a closure to be used in the place of a
<code class="language-plaintext highlighter-rouge">TransitiveClosure</code>.  The following code applies the <code class="language-plaintext highlighter-rouge">inc</code> RC operation to all
adjacent objects:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">EdgeIterator</span><span class="p">::</span><span class="o">&lt;</span><span class="nn">E</span><span class="p">::</span><span class="n">VM</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">iterate</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">|</span><span class="n">edge</span><span class="p">|</span> <span class="p">{</span>
    <span class="k">self</span><span class="nf">.inc</span><span class="p">(</span><span class="k">unsafe</span> <span class="p">{</span> <span class="n">edge</span><span class="nf">.load</span><span class="p">()</span> <span class="p">});</span>
<span class="p">})</span>
</code></pre></div></div>

<p>And the following applies <code class="language-plaintext highlighter-rouge">dec</code>, and optionally frees the object:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">EdgeIterator</span><span class="p">::</span><span class="o">&lt;</span><span class="n">VM</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">iterate</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">|</span><span class="n">edge</span><span class="p">|</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">edge</span><span class="py">.load</span><span class="p">::</span><span class="o">&lt;</span><span class="n">ObjectReference</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">};</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">t</span><span class="nf">.is_null</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">Ok</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="k">super</span><span class="p">::</span><span class="nn">rc</span><span class="p">::</span><span class="nf">dec</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="nd">debug_assert!</span><span class="p">(</span><span class="k">super</span><span class="p">::</span><span class="nn">rc</span><span class="p">::</span><span class="nf">is_dead</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
            <span class="nf">f</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Pretty neat, isn’t it?  It is so neat that I want to steal the code and add an
<code class="language-plaintext highlighter-rouge">EdgeVisitor::from_closure</code> factory method for my <code class="language-plaintext highlighter-rouge">EdgeVisitor</code>.</p>

<p>One interesting thing is, Wenyu introduced this for reference counting,
according to the <a href="https://github.com/wenyuzhao/mmtk-core/commit/9587aca2c62e02e043a5f01c3488cd91e21515b0">commit message</a>.  What a coincidence!  Daniel
<a href="https://github.com/JikesRVM/JikesRVM/commit/64f538ca4d348f062f3afb313f519ffcbbbd22bd">introduced <code class="language-plaintext highlighter-rouge">TraceStep</code> in 2006</a> for exactly the same
reason: reference counting, according to its commit message, too.
Understandably, reference counting is very different from tracing.  RC needs to
scan objects, but not for tracing, so passing <code class="language-plaintext highlighter-rouge">TraceLocal</code> to <code class="language-plaintext highlighter-rouge">scan_object</code>
doesn’t make sense.  Therefore, those additional operations, be it mark-grey,
scan-black or just freeing objects, all define their own callbacks to be called
by <code class="language-plaintext highlighter-rouge">scan_object</code>. This necessitates the creation of a better interface for the
callback of <code class="language-plaintext highlighter-rouge">scan_object</code>.</p>

<h3 id="refactoring-spacetrace_object">Refactoring Space::trace_object</h3>

<p>The <code class="language-plaintext highlighter-rouge">XxxSpace::trace_object</code> method usually has this form:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">VM</span><span class="p">:</span> <span class="n">VMBinding</span><span class="o">&gt;</span> <span class="n">CopySpace</span><span class="o">&lt;</span><span class="n">VM</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">#[inline]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="n">trace_object</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">TransitiveClosure</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="p">,</span>
        <span class="n">trace</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span><span class="p">,</span>
        <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">,</span>
        <span class="n">semantics</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">CopySemantics</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">worker</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">GCWorker</span><span class="o">&lt;</span><span class="n">VM</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ObjectReference</span> <span class="p">{</span>
        <span class="c1">// ... more code omitted</span>
        <span class="k">if</span> <span class="cm">/* is first visited */</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">new_object</span> <span class="o">=</span> <span class="nn">object_forwarding</span><span class="p">::</span><span class="nn">forward_object</span><span class="p">::</span><span class="o">&lt;</span><span class="n">VM</span><span class="o">&gt;</span><span class="p">(</span><span class="o">...</span><span class="p">);</span>

            <span class="n">trace</span><span class="nf">.process_node</span><span class="p">(</span><span class="n">new_object</span><span class="p">);</span>  <span class="c1">// enqueue object</span>
            <span class="n">new_object</span>  <span class="c1">// return the forwarded obj ref</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// ... more code omitted</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If an object is first visited, it enqueues the object in <code class="language-plaintext highlighter-rouge">trace</code>, and returns
the forwarded object reference.</p>

<p>This method is polymorphic w.r.t. <code class="language-plaintext highlighter-rouge">T</code>.  <code class="language-plaintext highlighter-rouge">T</code> is the <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> (a
sub-trait of <code class="language-plaintext highlighter-rouge">TransitiveClosure</code>) type used by the plan.  We used to have one
different <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> type for each plan, which made this generic type
parameter necessary.</p>

<p>We already <a href="https://github.com/mmtk/mmtk-core/issues/110#issuecomment-954335561">noticed</a> that we may safely remove this
only use case of the <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> trait (i.e. <code class="language-plaintext highlighter-rouge">trace_object</code>) once we
remove plan-specific <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> implementations. And the good thing is,
we have recently just <a href="https://github.com/mmtk/mmtk-core/commit/93281e9563fb5a780b880c086f67c75fc66bc8f8">removed</a> all plan-specific
<code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> implementations. Although we are not sure whether we will
have plan-specific <code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> for complex GC algorithms in the future, I
think the code is much cleaner for a refactoring.</p>

<p>However, I <a href="https://github.com/mmtk/mmtk-core/issues/559">believe</a> the <code class="language-plaintext highlighter-rouge">trace</code> parameter is
completely unnecessary.  We just need a return value to indicate whether it is
the first time the object is visited, so that the <em>caller</em> of <code class="language-plaintext highlighter-rouge">trace_object</code>
(which is only <code class="language-plaintext highlighter-rouge">ProcessEdgesWork::process_edge</code> at this time) can enqueue the
object.  So instead of</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">process_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">object</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">slot</span><span class="py">.load</span><span class="p">::</span><span class="o">&lt;</span><span class="n">ObjectReference</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">};</span>
    <span class="k">let</span> <span class="n">new_object</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.trace_object</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
    <span class="k">if</span> <span class="k">Self</span><span class="p">::</span><span class="n">OVERWRITE_REFERENCE</span> <span class="p">{</span>
        <span class="k">unsafe</span> <span class="p">{</span> <span class="n">slot</span><span class="nf">.store</span><span class="p">(</span><span class="n">new_object</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>we shall have</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">process_edge</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">object</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="n">slot</span><span class="py">.load</span><span class="p">::</span><span class="o">&lt;</span><span class="n">ObjectReference</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">};</span>
    <span class="k">let</span> <span class="p">(</span><span class="n">new_object</span><span class="p">,</span> <span class="n">first_visit</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.trace_object</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
    <span class="k">if</span> <span class="k">Self</span><span class="p">::</span><span class="n">OVERWRITE_REFERENCE</span> <span class="p">{</span>
        <span class="k">unsafe</span> <span class="p">{</span> <span class="n">slot</span><span class="nf">.store</span><span class="p">(</span><span class="n">new_object</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">first_visit</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.enqueue</span><span class="p">(</span><span class="n">new_object</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>However, the <code class="language-plaintext highlighter-rouge">#[inline]</code> above <code class="language-plaintext highlighter-rouge">trace_object</code> indicates that it is very
performance-critical.  We’d better measure before making the decision to change.</p>

<h2 id="epilogue">Epilogue</h2>

<p>After fifteen years, the <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> trait is finally going to change.</p>

<p>The Rust MMTk is under active development now.  As we proceed, we may see more
things like this, things that have remained in its current state for years, or
even decades.  But this doesn’t mean they are always right.  We have to rethink
about the code again and again, and fix the problems whenever we can.</p>

<h2 id="update">Update</h2>

<p>We eventually <a href="https://github.com/mmtk/mmtk-core/pull/607">removed</a> <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> as well as the stale
<code class="language-plaintext highlighter-rouge">TraceLocal</code> trait from <code class="language-plaintext highlighter-rouge">mmtk-core</code>.  However, unlike we discussed in previous
sections, we did not remove the <code class="language-plaintext highlighter-rouge">trace</code> parameter from <code class="language-plaintext highlighter-rouge">trace_object</code>.  We think
“enqueuing objects” is still a responsibility of the <code class="language-plaintext highlighter-rouge">trace_object</code> method, so
we should still enqueue objects in <code class="language-plaintext highlighter-rouge">trace_object</code> instead of in <code class="language-plaintext highlighter-rouge">process_edges</code>
using the return value.  Therefore, we simply renamed <code class="language-plaintext highlighter-rouge">TransitiveClosure</code> to
<code class="language-plaintext highlighter-rouge">ObjectQueue</code>, and renamed <code class="language-plaintext highlighter-rouge">process_node</code> to <code class="language-plaintext highlighter-rouge">enqueue</code>, so they indicate exactly
what they do.  And now it is the actual object queue instead of
<code class="language-plaintext highlighter-rouge">ProcessEdgesWork</code> that implements <code class="language-plaintext highlighter-rouge">ObjectQueue</code>.</p>

<p>The signature of <code class="language-plaintext highlighter-rouge">CopySpace::trace_object</code> now looks like this:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[inline(always)]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="n">trace_object</span><span class="o">&lt;</span><span class="n">Q</span><span class="p">:</span> <span class="n">ObjectQueue</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="o">&amp;</span><span class="k">self</span><span class="p">,</span>
    <span class="n">queue</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Q</span><span class="p">,</span>
    <span class="n">object</span><span class="p">:</span> <span class="n">ObjectReference</span><span class="p">,</span>
    <span class="n">semantics</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">CopySemantics</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">worker</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">GCWorker</span><span class="o">&lt;</span><span class="n">VM</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ObjectReference</span> <span class="p">{</span>
</code></pre></div></div>

<p>Note that <code class="language-plaintext highlighter-rouge">ObjectQueue</code> is still a trait.  It does not have to be a physical
queue.  If a GC algorithm does not hold objects in a queue during tracing, it
can implement this trait and process the “enqueued” object immediatey.</p>

<h2 id="see-also">See also</h2>

<p>The tracking issue: https://github.com/mmtk/mmtk-core/issues/559</p>]]></content><author><name>Kunshan Wang</name></author><category term="blog" /><category term="mmtk" /><summary type="html"><![CDATA[The TransitiveClosure interface in MMTk is confusing. It should have been split into two different interfaces, but not… until now. What’s more interesting is how we ended up having an interface like that 15 years ago, and why it stayed that way since then.]]></summary></entry><entry><title type="html">Hello world!</title><link href="https://wks.github.io/blog/2022/04/15/Hello-world.html" rel="alternate" type="text/html" title="Hello world!" /><published>2022-04-15T00:00:00+00:00</published><updated>2022-04-15T00:00:00+00:00</updated><id>https://wks.github.io/blog/2022/04/15/Hello-world</id><content type="html" xml:base="https://wks.github.io/blog/2022/04/15/Hello-world.html"><![CDATA[<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
incididunt ut labore et dolore magna aliqua. A erat nam at lectus urna duis
convallis convallis. Augue mauris augue neque gravida in fermentum et
sollicitudin ac. Ante in nibh mauris cursus mattis molestie a. Cras pulvinar
mattis nunc sed blandit libero volutpat sed cras. Duis ultricies lacus sed
turpis tincidunt id. Elementum eu facilisis sed odio morbi quis commodo odio.
Quisque non tellus orci ac auctor augue mauris. Amet consectetur adipiscing
elit pellentesque habitant morbi tristique senectus. Euismod elementum nisi
quis eleifend quam adipiscing vitae. Diam maecenas sed enim ut sem viverra
aliquet eget. Habitant morbi tristique senectus et netus et. Facilisi nullam
vehicula ipsum a. Mi proin sed libero enim sed. Lacus vel facilisis volutpat
est.</p>

<p>Malesuada pellentesque elit eget gravida cum sociis natoque. Dolor magna eget
est lorem ipsum dolor. Id eu nisl nunc mi ipsum faucibus. Elit eget gravida cum
sociis natoque penatibus et. Augue interdum velit euismod in pellentesque massa
placerat duis ultricies. Aliquet eget sit amet tellus cras adipiscing enim eu
turpis. Nisl pretium fusce id velit ut tortor. Non enim praesent elementum
facilisis. Libero volutpat sed cras ornare arcu dui vivamus arcu. Molestie nunc
non blandit massa enim. Nam aliquam sem et tortor consequat. Turpis egestas sed
tempus urna et pharetra pharetra. Nisi vitae suscipit tellus mauris a diam
maecenas. Praesent tristique magna sit amet purus gravida quis. Convallis
tellus id interdum velit laoreet.</p>

<p>In hac habitasse platea dictumst vestibulum. Urna neque viverra justo nec
ultrices. Amet nisl purus in mollis. Ut lectus arcu bibendum at varius vel
pharetra vel turpis. Facilisi nullam vehicula ipsum a arcu cursus vitae congue.
Ornare arcu dui vivamus arcu. Volutpat commodo sed egestas egestas fringilla
phasellus faucibus scelerisque eleifend. Et pharetra pharetra massa massa
ultricies mi. At augue eget arcu dictum varius duis at consectetur. Amet massa
vitae tortor condimentum lacinia quis vel eros.</p>

<p>Tellus pellentesque eu tincidunt tortor aliquam nulla facilisi cras fermentum.
Feugiat nisl pretium fusce id velit. Dictum at tempor commodo ullamcorper a.
Quam vulputate dignissim suspendisse in. Massa id neque aliquam vestibulum
morbi blandit cursus risus. Laoreet sit amet cursus sit amet dictum sit amet.
Cursus vitae congue mauris rhoncus aenean vel elit. Phasellus vestibulum lorem
sed risus. Et netus et malesuada fames ac. Pharetra magna ac placerat
vestibulum lectus mauris ultrices eros in. Proin sed libero enim sed faucibus
turpis in. Sed vulputate mi sit amet mauris commodo quis. Egestas tellus rutrum
tellus pellentesque eu tincidunt tortor aliquam. Consectetur purus ut faucibus
pulvinar elementum integer enim. Elementum tempus egestas sed sed risus.
Molestie ac feugiat sed lectus vestibulum mattis ullamcorper. Convallis a cras
semper auctor neque vitae tempus quam pellentesque. Nunc vel risus commodo
viverra. Nam libero justo laoreet sit amet cursus. Elit duis tristique
sollicitudin nibh sit amet commodo nulla.</p>

<p>In ante metus dictum at tempor commodo ullamcorper a lacus. Id eu nisl nunc mi
ipsum faucibus. Semper eget duis at tellus at. Proin sagittis nisl rhoncus
mattis rhoncus. Habitasse platea dictumst vestibulum rhoncus est pellentesque.
Eget felis eget nunc lobortis mattis aliquam. Risus sed vulputate odio ut enim
blandit volutpat maecenas volutpat. Viverra nibh cras pulvinar mattis nunc sed
blandit libero. Ut venenatis tellus in metus vulputate. Aliquam sem et tortor
consequat id. Suspendisse ultrices gravida dictum fusce ut placerat orci nulla.</p>]]></content><author><name>Kunshan Wang</name></author><category term="blog" /><summary type="html"><![CDATA[Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. A erat nam at lectus urna duis convallis convallis. Augue mauris augue neque gravida in fermentum et sollicitudin ac. Ante in nibh mauris cursus mattis molestie a. Cras pulvinar mattis nunc sed blandit libero volutpat sed cras. Duis ultricies lacus sed turpis tincidunt id. Elementum eu facilisis sed odio morbi quis commodo odio. Quisque non tellus orci ac auctor augue mauris. Amet consectetur adipiscing elit pellentesque habitant morbi tristique senectus. Euismod elementum nisi quis eleifend quam adipiscing vitae. Diam maecenas sed enim ut sem viverra aliquet eget. Habitant morbi tristique senectus et netus et. Facilisi nullam vehicula ipsum a. Mi proin sed libero enim sed. Lacus vel facilisis volutpat est.]]></summary></entry></feed>